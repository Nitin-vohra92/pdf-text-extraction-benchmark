Proposition Lemma

Definition

The space of ultrametric phylogenetic trees

and Alexei J. Drummond

This paper lies in the broad scope of research on the following two phylogenetic problems, which are also of more general interest, as we demonstrate in this work. First is the problem of introducing a satisfactory parameterisation of phylogenetic trees for statistical analysis of tree space. The space of phylogenetic trees encapsulates the structure of a manifold as well as the combinatorially complicated discrete structure of trees . This mix of a continuous and a discrete component is what makes statistical analysis of the space complicated. The second problem is the problem of summarising a finite set of phylogenetic trees . This problem arises in different settings of phylogenetic analysis, the most important of which is the problem of computing a statistically consistent summary of a sample from the posterior probability distribution over trees .

A quite extensive amount of research has been done on the space of phylogenetic trees in the general setting when the phylogenetic distance between taxa is given by arbitrary lengths of the edges of the tree . As we demonstrate in this paper, this general setting sometimes leads to computationally intractable models when applied to the space of ultrametric trees (a special case of time-trees). Ultrametric trees are the only satisfactory model for a great body of research in phylogenetics and epidemiology, especially when divergence time dating is the objective, and the taxa are all contemporaneous. In this case the time-tree is ultrametric, and is considered separately to the rates of evolution across lineages, which may vary from one branch to the next.

The aim of this paper is to introduce a mathematically satisfactory model of the space of equidistant phylogenetic trees. The notion of a 'mathematically satisfactory model' will be clarified and made exact later in the paper with an eye towards the two general problems described above. Our work is inspired by that of , and is similar to it in the sense that we use polyhedral complexes to define a metric space. The investigation of the tree space from a geometric point of view was initiated by their work with the introduction of a parameterisation that later became known as [formula]. Due to several nice geometric and algorithmic properties, it was recently suggested that [formula] is the space for statistical, and particularly MCMC, analysis of phylogenetic trees. Our results presented in this paper show how crucial the way a tree is parameterised can be for geometric, algorithmic, and statistical properties of the space. Particularly, we demonstrate that the summary tree that is suggested in will be different for different parameterisations of the tree space. Our results leaves open the question of which parameterisation should be chosen.

We call the same type of trees 'ultrametric' in the title of the paper and 'equidistant' in the previous paragraph. The reason for this ambiguity is the following. The type of object we consider in this paper is commonly known to evolutionary biologists as an ultrametric tree, while for mathematical biologists, this term is not appropriate for the following reasons:

The popular handbook of a mathematical biologist calls these trees equidistant.

An equidistant tree gives rise to a metric on the taxa. This metric is always an ultrametric, which is a standard notion of geometry.

Every finite ultrametric space X can be presented by a unique equidistant phylogenetic tree on X as taxa.

There are non-equidistant phylogenetic trees that give rise to an ultrametric space on the taxa.

Hence, we have used the term 'ultrametric' in the title and abstract, to make the topic of this paper clear for both communities, and we use the term 'equidistant' from now on for reasons ([\ref=equidistantSteel]) and ([\ref=equidistantGeometry]) above.

Unless otherwise explicit, by a tree we mean an equidistant phylogenetic tree, that is, a binary rooted tree with distinguished tips and branch lengths such that the distance from the root is the same to every tip.

We follow books for phylogenetics and for geometric combinatorics terminology. The structure of our paper is the following. In Section [\ref=introduction]. Introduction, we describe the state of the art. Particularly, we present the metric spaces with which we will be comparing our spaces. We note that all the metric spaces, apart from [formula], are not actually used as geometries but as a way of measuring errors instead . Indeed, some of those characteristics are not even metrics, they are more general geometric objects called dissimilarity maps. In this section, we establish some geometric properties of described spaces (that theoretically justify their sometimes poor fit for both statistical analysis and summarising the posterior). We also describe a way of adapting the [formula] space for the space of equidistant trees. Section [\ref=tauSpace]. τ-space is one of the main contributions of the paper. Here we introduce the space and establish its geometric properties that make τ-space attractive for modelling equidistant phylogenetic trees. We also describe effectiveness properties of the space. Section [\ref=tSpace]. [formula]-space is where we describe [formula]-space, establish its geometric properties and compare τ- and [formula]-spaces. The seemingly inessential difference between the two spaces of how a tree is parameterised results in a large impact on geometric and algorithmic properties of the space, as we demonstrate in this section, which is one of the main contributions of the paper.

Introduction

Although the space of equidistant phylogenetic trees is well understood by biologists, mathematicians, and statisticians, there are a large number of ways to define this space formally. As a well-chosen formal definition is the main and crucial step for various types of analyses of the space, including mathematical, statistical, and computational, it is important to carefully address the balance between the generality of the definition, its mathematical clarity, and its applicability in analyses of real evolutionary processes. Formal definitions become especially important in modern research because of the massive use of computational tools, for which equivalent definitions can change the complexity of a problem from incomputable on any type of abstract digital computer to rapidly computable on available machines. In this paper, we consider several approaches to defining the space of equidistant phylogenetic trees and compare their mathematical, computational, and statistical tractability.

It is a standard practice in evolutionary biology to model real biological processes by mathematical abstractions . Particularly, as biologists are often interested in comparing different hypotheses about an evolutionary process modelled by phylogenetic trees, it is natural to work within the space of such trees. It is also a common practice to introduce different types of measures on the space of trees as a formal way of comparing them. One of the most general and commonly used ways of measuring the similarity between two trees is given by the notion of a distance, or metric as it is widely known in mathematics. In order to measure the distance between trees, the tree space has to be parameterised, that is, some real-valued parameters have to be assigned to trees.

Formally, this scenario can be described as follows. Let T be the space of phylogenetic trees on n taxa. A parameterisation of the space T is an embedding p:T  →  M of the tree space T to a metric space M, which we call a model metric space. By embedding here, we mean a function that maps different trees to different points of the metric space M. The embedding p plays the role of the assignment of parameters (points of the space M, which could be tuples of real numbers, for example). The existence of such an embedding makes the space T itself a metric space. Indeed, the distance between two trees T and R is given by the distance between their images under the embedding p, that is, [formula] is defined to be [formula]. We say in this case that the metric [formula] is induced by the parameterisation p.

As is known , the existence of a parameterisation alone is already a fruitful property of the tree space, as it allows to test hypotheses such as how far are two trees from each other? How far is an estimate from the true tree? Given two algorithms, which one produces trees that are closer to the true tree? Sometimes it is even possible to extract an objective function minimisation that leads to a practical way of summarising posteriors . We will present some of these parameterisations later in this section.

Often biologists and especially phylogeneticists are interested in more subtle properties of the space of trees, such as what tree is in the middle between two given trees? What is the path from one tree to another? What is the mean and the variance of a set of (sampled) trees? The last question is of prominent importance, as this is the very basic question for statistical analysis of data that produces a set of phylogenetic trees. Furthermore, this question is important in testing whether two probability distributions on tree space are the same, a task common in statistical model selection. More sophisticated questions include, for example, how standard phylogenetic models such as coalescent and birth-death can be described under a given parameterisation? Can more efficient proposal mechanisms, such as Hamiltonian Monte Carlo, be employed in Bayesian analysis of phylogenetic data?

A more detailed mathematical analysis is needed in order to approach questions such as these. In what follows, we summarise several basic properties of parameterisations, which we suggest are desirable to advance research on the problems mentioned.

It is often the case that the metric space M, that is used to parameterise tree space T, is greatly different from the metric space T with the induced metric [formula]. The key reason for this is the nature of the parameterisation p. As we will see later in the paper, some parameterisations p induce metrics that share almost no geometric properties in common with the original metric space M that was used in the parameterisation p. Particularly, those parameterisations are far from being bijective, that is, being able to recover a tree given an arbitrary point from the space M. The lack of this property can lead to situations where, for example, there are infinitely many trees all of which minimise the total square distance to a given set of trees . A sphere, for example, has such a property, where there are infinitely many points minimising the total square distance to two antipodal points. Furthermore, there are two points a and b both of which minimise this distance, but the distance between a and b is as large as possible.

Although the parameterisations we introduce in Sections [\ref=tauSpace] and [\ref=tSpace] of this paper are bijective, the requirement of being bijective is somewhat strong in the sense that many desirable properties can be achieved without the parameterisation being bijective. We continue with introducing formal requirements that allow to carry the analysis of the space M over to the space of trees T.

For the statistical analysis of a space, one needs to define probability distributions over the space, e.g. for Bayesian analysis the first step is to define a prior distribution. A continuous probability distribution defined on the metric space M has to remain the same continuous distribution when pulled back to the space of trees T under the parameterisation p. In order to achieve this, one has to be able to continuously move from one tree to another by a path that stays within the tree space. In other words, any two trees have to be connected by a path.

Formally, a metric space X is called path-connected if for each pair of points x,y in the space, there exists a continuous map γ (with respect to the standard topologies generated by balls) from the unit real segment

[formula]

τ-space

In this section, we model the space of equidistant trees by a cubical complex, which we call τ-space, with efficiently computable unique geodesics and establish several geometric and algorithmic properties of the space.

Construction of the space

Those readers who are familiar with [formula] space will probably not need much extra explanation other than Figures [\ref=T5.pdf] and [\ref=tauSpace.pdf]. Figure [\ref=T5.pdf] depicts a tree from 5-dimensional τ-space T5 and shows how the tree is parameterised. Figure  [\ref=tauSpace.pdf] depicts one third of 4-dimensional τ-space T4, where each orthant is projected onto the subspace with the first coordinate τ1 fixed. Although this projected space cannot be embedded into 3-dimensional Euclidean space, it can be visualised by imagining the other two thirds of the space. The figure is also helpful in understanding the fact that the Cartan-Alexandrov-Toponogov axiom (for k = 0), which we explain in Definition [\ref=definitionCAT], holds for the space, that is, triangles are thin.

We now give a formal construction of the space to complement the figure. Since one of the main reasons for our interest in equidistant trees is that they allow accurate modelling of evolutionary processes, and in most of those models the height of a node is interpreted as time, we will be using words 'height' and 'time' interchangeably.

Let T be an equidistant tree on n taxa with times assigned to its nodes. Assuming that the times of all internal nodes are pairwise distinct, we denote the set of such trees by Tn. We parameterise the tree T by a pair that consists of the ranked topology of the tree and the differences between the times of the tree's consecutive nodes. We proceed by defining this parameterisation formally. Let us order the internal nodes of T according to their times: [formula]. Note that the node vn must be the root in this case. Denote the difference between the time of node vi + 1 and the time of node vi by τi for all [formula]. We call τi the coordinate of node vi. Since the tree is equidistant, the differences between the time of v2 and the times of external nodes are all the same. Denote this difference by τ1. The coordinates of the tree T are given by the n-tuple [formula], where [formula] is the ranked topology of tree T and [formula] is the tuple [formula] from [formula] that consists of the coordinates of the nodes of T. By [formula] we denote the (n - 1)-dimensional non-negative orthant [formula], where [formula] is the set of reals. Figure [\ref=T5.pdf] depicts an example of τ-parameterisation of a tree from T5.

Consider now the set of all ranked topologies on n taxa such that all internal nodes have different ranks. We recall that there are [formula] many such topologies , and we denote this number by m throughout the paper.

Thus, we have constructed a disjoint union of m (n - 1)-dimensional polyhedra [formula]. Specifically, the polyhedra are orthants indexed by tree topologies. It is clear that the set Tn is in a bijective correspondence with the interior of S. It is also obvious how to establish a bijection between the faces of the polyhedra in S and the set of ranked (multifurcating) tree topologies on n taxa which have at least two internal nodes of the same rank. Indeed, if we consider such a tree, the coordinates τi that are between two nodes of the same rank have to be 0, and the faces of the polyhedra in S are precisely the tuples [formula] where some of the coordinates τi are 0. It remains to note that faces for which τ1 = 0 (may be with some [formula] also 0) will correspond to the trees where the most recent divergence event (may be with second, [formula] , ith most recent divergence events) occurs at present.

We now want to create a polyhedral complex in the obvious way, that is, by gluing the faces that correspond to same ranked (not necessarily fully resolved) tree topologies together. We proceed formally as follows. We define an equivalence relation ~   on the set of faces of polyhedra in S. We say that two faces F and G are equivalent, written F  ~  G, if they correspond to the same ranked tree topology. Now, consider the set S' that consists of the union of the set S and the set of all faces of elements from S. The polyhedral complex is then the quotient set S' /   ~  .

Since trees are in a bijective correspondence with this complex, the parameterisation is strict and we shall refer to the space of trees Tn as to a polyhedral complex slightly abusing the notation.

Polyhedral complexes where the polyhedra are orthants share the same local geometric properties as cubical complexes. By 'local properties' here we mean those that can be observed at a finite distance from the origin, rather than the properties that arise at infinity. Hence, one can always assume that all coordinates of the orthants are bounded by a (large enough) constant. This boundary makes the polyhedral complex Tn a cubical complex, which is a standard and well-studied object of geometric combinatorics . This does not imply that unbounded polyhedra are of smaller interest. For example, Gromov's influential programme on large scale geometry focuses on investigating geometric asymptotic properties at infinity. We make this restriction because for our goals cubical complexes are a more appropriate object to model the space of trees because only local properties are at question. All of the results contained in this paper remain true in the unbounded case.

An interesting example where asymptotic properties of tree space at infinity are treated differently is so-called 'orange geometry' , where polyhedra are 'glued' together at infinity. That geometric framework encodes not only phylogenies but also data sets, evolution models, and estimation methods.

From now on we can think of the tree space Tn as of a cubical complex. This in particular implies that the space Tn is a metric space with geodesics. It is easy to construct an example of a cubical complex where geodesics are not unique. Hence, the immediate question is whether geodesics are unique in τ-space Tn. They are, and we prove this, but before that let us consider some geometric properties of the space and compare them with those of [formula] space.

It is convenient to think of τ-space as a set of points (trees) that freely move within orthants without leaving them as long as all the coordinates τi are strictly positive. This movement results in changes in branch lengths (time between divergence events) but the ranked tree topology remains the same. When one of the τi becomes 0, the point (tree) is on the boundary of one smaller dimension. The point now can either move along the boundary by varying the other τi, or it can leave the boundary by increasing the τi that became 0. The boundary corresponds to a facet F and there could be several orthants that share this facet F. It is not hard to understand that the possible numbers of orthants which share a common facet are one, two, and three. Indeed, we have seen an example of a polyhedron and its facet that is not a face of any other polyhedron, i.e. when τ1 = 0. If a facet does not correspond to a multifurcation (see the facet between polyhedra corresponding to trees T and E in Figure [\ref=tauSpace.pdf]), there are precisely two orthants that share the facet. If it does (as the other facet of the orthant corresponding to the tree T in Figure [\ref=tauSpace.pdf]), then the number is three.

Some geometric properties

At first glance it might seem that the [formula] and τ-space are very similar. It might even appear that they are the same space. The graph on Figure [\ref=tauLink.pdf] depicts the link of the origin of T4 space. The link is similar to that of [formula] space on four taxa indeed, but it already suggests several differences that we would like to investigate.

In this subsection, we establish several geometric properties of the two spaces to better understand the differences and similarities between them in order to answer the question of whether the algorithms developed for [formula] space are applicable in τ-space. The first property we want to point out is the following. For every tree topology, the dimensions of corresponding orthants in [formula] and Tn are different. This is because pendant edges add n to the dimension of the [formula]-orthant and add 1 to the dimension of the τ-orthant. One might suggest that the spaces [formula] and [formula], which are the corresponding spaces where all pendant edges are omitted, are geometrically similar. They are indeed, they share a number of geometric properties. However, some dissimilarities between them become clear if one attempts to uniformly map one distance to the other. If such a mapping existed, all geometric and algorithmic results for [formula] could be directly applied to τ-space. We formalise this assertion in the following two propositions.

Spaces [formula] and [formula] are not isometric.

This follows from the fact that isometries preserve angles. Indeed, let us fix a non-caterpillar tree topology and consider the corresponding orthants in [formula] and [formula]. We may notice that there are several orthants corresponding to the tree topology in [formula] and only one orthant in [formula] space. One can use an appropriate number of hyperplanes to partition the [formula]-orthant in a way that every member of the partition corresponds to the trees in precisely one [formula]-orthant. Clearly, no embedding between these subspaces preserves angles.

The proof above can intuitively be understood by trying to establish an isometry between the orthants that correspond to the trees T and E in Figure [\ref=tauSpace.pdf]. The corresponding τ- and [formula]-subspaces can be drawn as Figure [\ref=noIsometry.pdf] (note that the objects depicted are flat).

One might still wonder in what way the distances are related. It might even appear that the [formula]-distance majorates the τ-distance, that is, [formula] for all trees T and R. Although it is obvious that the [formula]- and the τ-coordinates are easily computable from each other, the following proposition is true.

None of the [formula]- and τ-metrics majorates the other.

It is important to note that since the dimensions of [formula] and τn are different, we are ignoring the external branches here and considering [formula] and [formula].

Consider trees T, R, and E depicted in Figure [\ref=tauSpace.pdf]. We finish the proof of the lemma by setting

(1) All sigmas, mus, and taus to 1. In this case: [formula] [formula]

One might hypothesise that an inequality of the second type can only be obtained in the quadrants that present in τ-space but not in [formula] space. Although it is not necessary for the proof, we demonstrate that this hypothesis can be refuted by setting

(2) τ2 = 1, τ3 = 2, μ2 = 3, μ3 = 4. In this case: [formula].

Uniqueness and efficiency of geodesics

The geometric property of main interest to us in this paper is the uniqueness of geodesics. We are aimed at efficient procedures for computing several geometric characteristics such as Fréchet mean, standard deviation, and convex hulls, for which the uniqueness of geodesics is important. Although most of the properties of the space, including the uniqueness of geodesics, can be shown directly, we will establish those properties in this section using Gromov's [formula] theory . Our main motivation for doing this is that this way is more elegant, to our taste, than the one that uses a direct construction of geodesics.

We recall that a metric space X is called geodesic if every pair of points from X is connected by a shortest path. A geodesic metric space has unique geodesics if the geodesic is unique between every two points from X.

A geodesic metric space X is said to satisfy Cartan-Alexandrov-Toponogov axiom, or be [formula], if the following property holds.

For all triples x1,x2,x3∈X and all points y on a geodesic from x1 to x2, the inequality dX(x3,y)  ≤  dE(x3',y') holds, where x1',x2',x3' are three points on the Euclidean plane such that dE(xi',xj') = dX(xi,xj) for all [formula], y' is the point on the segment

[formula]

In other words, a metric space X is [formula] if no triangle Δ in X is thicker than a Euclidean triangle ΔE of the same size as Δ.

It follows from the definition of a [formula] metric space that it has unique geodesics. Indeed, let X be a [formula] space and a,b two points from X. Consider a point x on a geodesic γ from a to b and consider a degenerate Euclidean triangle a',x',b' where x' lies on the segment

[formula]

[formula]-space

A natural question one could ask is why we take the time differences instead of actual times as coordinates of trees in the orthants of τ-space. One of the reasons for this is that τ-coordinates are independent as opposed to [formula]-coordinates--the absolute times of the nodes. The independence of coordinates is a useful property of parameterisations because it avoids constant checking of dependency conditions while performing the analysis (both geometric and algorithmic) of the space. We have seen in previous sections an example of a parameterisation where coordinates are dependent in a way which causes complications. Another reason is that the τ-parameterisation is used in several phylogenetic models e.g. in coalescent theory.

In some cases boundary conditions are unavoidable. For example, some boundary conditions present implicitly in τ-space--we require the coordinates to be positive and bound the first coordinate to the set of topologies of trees. The boundary condition that makes orthants cubes is explicit. Since these conditions are easily satisfiable and checkable, they do not cause any serious complication as we have seen in Section [\ref=tauSpace]. Furthermore, as absolute divergence times are often the object of interest, the parameterisation of trees using the times of their nodes is natural for several phylogenetic modes, e.g. birth-death models . As birth-death priors are one of the main classes of priors used in Bayesian inference, we address this parameterisation in more detail.

The purpose of this section is twofold. First, as we mentioned, we would like to study geometric and efficiency properties of one of the prominent parameterisations in evolutionary biology. Secondly, we demonstrate how radically these properties can change after a seemingly negligible change in parameterisation. Namely, converting τ-coordinates to their initial sums, that is, to the absolute times of divergence events, makes fundamental results from combinatorial geometry such as Gromov's theorem used to prove Theorem [\ref=uniqueGeodesics] inapplicable, along with the algorithmic results from and .

We note that considered branch lengths and a tree height to parameterise the space of ultrametric trees and prove that equidistant trees are in one-to-one correspondence with the Bergman fans of complete graphs Ardila2006-ov. As explained in the introduction, this parameterisation is not convenient for our purposes. However, the results in imply that [formula]-space is in one-to-one correspondence with the Bergman fans of complete graphs, so our results on [formula]-space are applicable to the corresponding fans.

We proceed with a formal introduction of the space, which we call the [formula]-space. Let us consider a fully resolved equidistant tree T with ranked topology [formula] with no pair of nodes of the same rank. For each node vi from T, let ti be the distance from vi to the nearest taxon. In this way, we assign times to all nodes of T, with all taxa being of time 0. Let us order all internal vertices of T according to their times: [formula] (the ordering is the same as the ordering according to their ranks). Then the coordinates of the tree T in [formula]-space is a tuple [formula].

We note that if we vary the times of the nodes of T while keeping the ranked topology preserved, we get a simplex [formula], where the upper bound on the height of the tree H is introduced by the same reason it was introduced in τ-space. Figure [\ref=simplex.pdf] depicts one such simplex.

We create a simplicial complex out of [formula] such simplices corresponding to different ranked topologies on n taxa in a similar way the complexes are created in [formula] and τ-spaces, namely, we identify faces of simplices corresponding to same tree topology. The metric is defined in the same way as in τ-space to be the standard piecewise Euclidean distance. The first substantial difference is that the edge of the complex that is shared by all the simplices is not an axes, it is rather the line [formula]. Furthermore, the faces are defined by some of the coordinates being equal, ti = tk, rather than some of the coordinates being 0. We denote the t-space on n taxa by [formula].

Figure [\ref=tSpace2d.pdf] depicts space [formula] in full.

In this figure, three coloured triangles of the simplicial complex correspond to the three depicted topologies. The triangles share a line that corresponds to the unresolved tree on three taxa. The upper bound of the triangles is the artificial bound H.

The following Figure [\ref=tSpace.pdf] depicts a part of the [formula]-space [formula]. Unlike Figure [\ref=tauSpace.pdf], we do not project the simplices onto a 2-dimensional subspace and draw them as 3-dimensional pyramids. Three such pyramids are depicted in Figure [\ref=tSpace.pdf] in white, blue, and grey. The white pyramid shares a facet with both grey and blue pyramids. The grey and blue pyramids share the edge t1 = t2 = t3 of the complex only. This is one-sixth of the space [formula] corresponding to the topologies depicted.

The following lemma is an important property that connects [formula] space, τ-space, and [formula]-space. This lemma has already been used to prove that τ-space is [formula].

[formula] space, τ-space, and [formula]-space are pairwise homeomorphic.

The homeomorphisms are induced by parameterisations [formula], pτ, and [formula] used to construct the corresponding spaces.

In particular, this lemma implies that both τ-space and [formula]-space are connected and simply connected.

Our next step is naturally to ask whether [formula]-space has unique geodesics. This question cannot be answered in the same way as it is done for [formula] and τ-space using Gromov's characterisation of [formula] cubical complexes, because [formula]-space is not a cubical complex. It is reasonable to expect that there exists a result similar to Gromov's theorem for simplicial complexes. There is one indeed. A simplicial complex is called k-large if every cycle in the link of every vertex, such that no two consecutive edges of the cycle are contained in a 2-simplex of the complex, has length at least k. As noted in , although no combinatorial formulation of the [formula] property of the standard piecewise Euclidean metric on a simplicial complex is known, the following theorem holds.

If [formula], then every connected simply connected k-large simplicial complex of dimension By dimension here the simplicial dimension of a simplicial complex is meant, that is, the greatest dimension of a simplex in the complex. For example, the simplicial dimension of the [formula]-space on n-taxa is n - 1. at most n is [formula] with respect to standard piecewise Euclidean metric.

It is not hard to see that [formula]-space [formula] is 6-large and not 7-large when [formula], hence the theorem above is not applicable. Simplicial complexes that are connected, simply connected, and 6-large are called systolic. Systolic complexes have extensively been studied and it was shown that in dimension two, a simplicial complex is systolic exactly when the standard piecewise Euclidean metric is [formula], while in higher dimensions being systolic is neither stronger nor weaker than the standard piecewise Euclidean metric being [formula]. Hence for [formula]-space, being systolic does not necessarily imply having unique geodesics.

However, [formula]-space possesses unique geodesics, as we show below. This fact makes [formula]-space an example of a non-trivial simplicial complex which is [formula]. Indeed, [formula]-space is an example of a [formula] simplicial complex for which the [formula] axiom cannot be established using Theorem [\ref=simplicialComplexes].

[formula]-space has unique geodesics.

We start with the following lemma, which is an important ingredient of the proof.

Let S be a simplex in [formula] and [formula] be an angle between a pair of facets in S. Then [formula].

First, scale the simplex S so that the height of the trees corresponding to S is bounded by 1. Then the set of vertices V of simplex S is

[formula]

The set of facets of simplex S is then given by the set of all (n - 1)-element subsets of V. Note that there are exactly two facets of S which are not shared by any other simplex in [formula]. Indeed, the facet given by the set [formula] corresponds to a completely resolved topology and belongs to exactly one simplex--the one that corresponds to that topology. The facet given by the set [formula] corresponds to a topology where a pair of taxa a,b are unresolved at present and the rest of the nodes of the topology are resolved. Since there is only one possibility to resolve the degenerate cherry (a,b), this facet belongs to exactly one simplex as well. Hence the shared facets of S are precisely those that contain both [formula] and [formula]. For example, the grey and the red facets of the simplex on Figure [\ref=simplex.pdf] are not shared by any other simplex, while the blue and the invisible facets are shared with other simplices.

We call a facet shared if the facet belongs to at least two different simplices. For every pair of shared facets of S, we now find the angle between them. To do so we first need to find the normal vectors of all shared facets. Every shared facet Fi, 1  ≤  i  ≤  n - 2, of S can be represented as an (n - 1)  ×  (n - 1) matrix j-th row of which is

[formula]

In other words, facet Fi is defined by removing the row [formula] from the set V. Normal vectors fi of facet Fi are then given by the null spaces of these matrices. For every i such that 1  ≤  i  ≤  n - 2, we fix one such vector fi to be [formula].

Since the inner product of pairs of these vectors is either 0 or 1, the smallest possible angle between the facets is π / 3, which proves the lemma.

We now note the following property. For every positive real number ε, the ε-neighbourhood of the origin of [formula]--point [formula] in terms of the proof of previous lemma--contains a simplicial complex similar to [formula]. This property follows by scaling [formula] with small enough scaling factor. Hence, to establish the claim of the theorem it is enough to show that the space is locally [formula]. To prove this, we apply the following result:

A finite simplicial complex is locally [formula] if and only if the link of every vertex of the complex is a [formula] space.

Hence, to finish the proof of Theorem [\ref=tSpaceCAT0], we need to show that the link of every vertex of [formula] is a [formula] complex. By Theorem 5.4(7) in bridsonBook, it is enough to show that [formula] contains no isometrically embedded circles of length less than 2π. That means the following. Let C be a geodesic curve in (the link of a vertex of) [formula] of length [formula] which is isometric to a Euclidean circle CE. If we scale the space so that CE is a unit circle then [formula].

This last property follows from Lemma [\ref=tSpaceAngles] for space [formula]. Let [formula] be completely resolved ranked tree topologies with the property that if C intersects a simplex corresponding to tree topology T then there is an i such that T  =  Ti. We claim that k  ≥  6. Indeed, k is bounded from below by the length of a shortest cycle in the link of the origin of [formula], and we have seen above that the length of such a cycle is 6. The length [formula] of C satisfies [formula] where [formula] is the smallest angle between facets of the simplex corresponding to a Ti. It follows from Lemma [\ref=tSpaceAngles] that [formula] and since k  ≥  6, we have [formula] as desired.

The change in the parameterisation of trees results not only in the question of uniqueness becoming more complicated. What is more important is that the algorithms used for computing geodesics in [formula] and τ-space cannot directly be applied in [formula]-space. Moreover, their existence has to be questioned. Hence we propose the following problem, on which we make some progress below but do not obtain a complete answer.

What is the complexity of computing geodesics in [formula]-space?

First we would like to develop some intuition of why [formula]-space is so different from both [formula] and τ-space. The key property for this difference is that the cone path is rarely a geodesic in [formula]-space. Indeed, in both [formula] and τ-space the position of two cubes can result in a cone path being the geodesic between any pair of trees from those cubes. For example, if two trees T and R have topologies with no compatible splits, then the geodesic between T and R is a cone path . [formula]-space does not have this property. Let us illustrate this effect by the following example. Consider trees T and R depicted in Figure [\ref=conePaths.pdf]. Since the trees do not have compatible splits, the geodesic is a cone path in both [formula] and τ-space. It is not hard to see that the shortest cone path in [formula]-space passes through the star-tree of height 6 and has length [formula], while the path that goes through ((1,2):4,3,4):8, ((1,3,2):6,4):8, and ((1,3):4,2,4):7 has length [formula] and is hence shorter than any cone path.

This example demonstrates another important property that distinguishes τ-space and [formula]-space. Every tree on the geodesic between two trees in τ-space contains only splits that present in the origin tree or in the destination tree (or both). Not so in [formula]-space. Split (123|4) does not present in either tree on Figure [\ref=conePaths.pdf] but present in an intermediate tree on the [formula]-geodesic.

We now develop a formalism that is convenient for the study of computational content of [formula]-space. This formalism can be used for τ-space as well and is actually the data structure that we use in our implementation of geodesic algorithms for τ-space . The formalism is motived by and consistent with the treatment of ranked tree topologies in .

By a partition with attached time coordinate, we mean an object of the form [formula], where [formula] is a partition of taxa that can be obtained by cutting the tree along the line obtained by fixing the time coordinate, and t is the least value of the time coordinate that produces this partition. For example, the left-hand side tree on Figure [\ref=conePaths.pdf] is defined by the set of partitions

[formula]

while the right-hand side tree--by

[formula]

Removing one or more partitions from a set of partitions that defines a completely resolved tree gives rise to a non-resolved tree or a tree with two or more internal nodes of the same rank. For example, if we remove partition [formula] from the left-hand side tree in Figure [\ref=conePaths.pdf] then we get the tree ((1,2),(3,4)) of height 9 with both internal nodes being of height 8. Alternatively, if we remove partition [formula] from that tree then we get the unresolved tree ((1,2),3,4) of height 9 with a common ancestor of (1,2) at height 1.

We note here that as we consider only trees with all taxa being at time 0, the partition [formula] is assumed to be (invisibly) present everywhere. Clearly, a tree is unambiguously defined by its set of partitions with attached time coordinates, and a set of partitions defines a tree if and only if one member of every pair of partitions from the set refines the other and the time coordinates of the partitions are monotonic under those refinements.

It can be shown in the same way as in that the coordinates in [formula]-space change at a fixed rate along geodesics. This justifies the following definition.

We assume that trees T and R are completely resolved and have all internal nodes of different ranks, that is, neither of them has [formula]-coordinates ti and ti + 1 such that ti  =  ti + 1. We say that the geodesic γ between trees T and R is computable (in polynomial time) if (a polynomial and) an algorithm exists that given the [formula]-coordinates of trees T and R, outputs (after a number of steps bounded by the polynomial of n) a sequence of sets of partitions [formula] with time coordinates attached to every partition such that

The set of partitions A0 along with the attached time coordinates defines tree T.

The set of partitions Ak along with the attached time coordinates defines tree R.

Let [formula] be all the simplices the geodesic γ traverses, ordered as they are traversed. Particularly, S0 contains T and Sk contains R.

For every i, the pair of sets Ai,Ai + 1 along with the attached time coordinates define the trees where geodesic γ enters and exits simplex Si, respectively.

Since tree T (R) is completely resolved, the number of elements of A0 (Ak) is n - 1. In terms of simplices, the number n  -  1  -  |Ai|, where |Ai| is the number of elements in Ai, is the codimension of the face of simplex Si. In terms of trees, this number is the number of multifurcations plus the number of non-resolved ranks of internal nodes of the tree corresponding to Si.

Note that the properties above imply that all sets Ai are pairwise different, all time coordinates attached to the partitions from the same set are pairwise different, and the time coordinates attached to the same partition in different sets may or may not be different. Clearly, every geodesic is unambiguously defined by a sequence of sets of partitions with attached time coordinates satisfying these properties.

We say that the geodesic γ is an [formula]-path if n - 1  -  |Ai|  =  1 for all i such that 0 < i  <  k. The following proposition, which is interesting on its own, explains several properties of [formula]-space, particularly, that the cone path is rarely a geodesic, unlike in [formula] or τ-space.

Let T and R be two trees as above and γ the geodesic in [formula]-space between them. Then there exists a tree T' that satisfies the following:

Tree T' has the same ranked topology as T.

The geodesic γ' between T' and R is an [formula]-path.

Tree T' and the sets of partitions that define geodesic γ' are computable in polynomial time from T and γ.

We start with proving a relaxed version of this proposition where we only require the geodesic γ' to be not a cone path.

First, let us characterise the geodesics between trees E and S depicted on Figure [\ref=NNIpathLemma.eps]. Note that A, B, C, and D are some trees and not necessarily taxa.

Direct computations show that the geodesic between the two trees is a cone path if and only if [formula]. If [formula] then the geodesic passes through the tree [formula], that is, node v does not move along the geodesic. Since time coordinates change at a fixed rate along geodesics, this provides a complete characterisation of [formula]-geodesics between pairs of trees having the topologies of E and S.

With this example in mind, the relaxed version of Proposition [\ref=NNIpath] follows from the following lemma.

Let Tδ be the tree obtained from tree T be increasing the root height by δ. Then there exists a number h such that the geodesic between Tδ and R does not traverse a star tree for all δ  >  h.

Let {ti} and {ri} be the time coordinates of T and R respectively. Then the shortest cone path from T to R passes through the star tree of height h obtained from the following minimisation:

[formula]

Hence, the height of the star-tree can be made arbitrarily high by increasing the height tn - 1 of tree T.

To finish the proof of Lemma, we note the following inequality, which follows directly from the triangle inequality. Let [formula] be the time of the most recent common ancestor of taxa i and j in tree T. Then

[formula]

for all trees S on the geodesic from T to R and all taxa i, j.

The Lemma follows from this inequality indeed: if the number of taxa n is at least 5 then there always exist a pair of taxa i, j such that [formula] is not the root in both trees T and R. Hence if we sufficiently increase the root hight, [formula] will always be below the root along the geodesic from T to R. It remains to be noted that the Lemma follows from the example above for n  ≤  4.

We are now ready to prove Proposition [\ref=NNIpath].

Let [formula] be the sequence of sets of partitions that define the geodesic γ from T to R. We adjust the time coordinates of T to obtain T' with desired properties. Let s be the least natural number such that n  -  1  -  |As|  >  1. If such an s does not exist, there is nothing to prove because γ is an [formula]-path. We proceed by presenting an algorithm that modifies tree T in such a way that at least one of the following conditions is satisfied:

the number s for the modified tree increases;

the number |As| for the modified tree decreases.

Since all possible values of s and |As| are bounded from above, after a certain number of iterations of this algorithm tree T will be modified to the desired tree T'. Furthermore, the number of iterations is bounded by the product of the maximal possible value of s and the maximal possible value of |As|, that is, by (n - 1)2.

Case 1. The tree Ts corresponding to As contains two nodes v1 and v2 of the same rank. Since time coordinates are independent, there exists a node w in T and a real number ε such that the following is satisfied. Let T'' be the tree obtained by changing the time coordinate of w in T by ε so that the ranked topologies of T and T'' coincide. Then the geodesic γ'' from T'' to R traverses the same ranked topologies as γ up until Ts and instead of Ts it traverses the tree topology obtained from that of Ts by resolving the ranks of v1 and v2. In this case, either s increases (if |As|  =  n - 3 for γ) or |As| decreases (otherwise).

Case 2. The tree Ts corresponding to As does not contain nodes of the same rank. Let v be the node in Ts such that the degree of v is at least 5 and v has the greatest time coordinate among such nodes. Node v exists because n  -  1  -  |As|  >  1 and Ts does not have nodes of the same rank. Let C be the set of taxa in the [formula] in Ts. Let w be the [formula].

The time coordinate of v in Ts is a monotonically increasing function of the time coordinate of w in T.

Follows the proof of Lemma [\ref=NNIpathLemma].

We shall modify the time coordinates of w (and the nodes above w) in T to obtain the tree with desired properties.

Lemma [\ref=NNIpathLemmaGeneral] together with property ([\ref=mrcaInequality]) imply that there exists a number H such that the following condition is satisfied: if the time coordinate of w and those of the nodes in T above w are increased by H then the degree of node v in Ts will decrease, the degrees of other nodes in Ts will not increase, and no nodes of the same rank will be created. This modification results in an increase in s (if deg (v)  =  5) or in a decrease in |As| (otherwise) and Case 2 follows.

Informally, this means that we can adjust the time coordinate of the partitions in T so that instead of passing the face corresponding to As of codimension 2 or greater, the geodesic passes first a face As' of codimension smaller than that of As and then another face As'' of codimension [formula]. This happens because the change of the time coordinate results in the geodesic developing faster in the direction of the coordinate, so the geodesic first reaches the face corresponding to As' and then the one corresponding to As'' rather than both As' and As'' simultaneously as geodesic γ does.

Clearly, this algorithm of computing T' is polynomially equivalent to the maximum of complexities of T and γ. It remains to note that on our way of adjusting the time coordinates of tree T, we computed all the partitions that define the geodesic γ'.

We note that if the geodesic between a pair of trees is a cone path in [formula]-space then so are the geodesics in [formula] and τ-space. We have seen that for every pair of simplices in [formula]-space, a non-trivial part of them consists of trees between which the geodesic is not a cone path. Hence, the volume of pairs of trees between which the geodesic is a cone path is smaller in [formula]-space than in [formula] or τ-space. This is because geodesics in [formula]-space often follow [formula]-paths. However, they do not necessarily follow shortest [formula]-paths. Indeed, it is possible to show that any tree on the geodesic between two caterpillar trees in [formula]-space is a caterpillar tree. This property is violated in [formula] space: consider two caterpillar trees (((((((((1,2),3),4),5),6),7),8),9),10) and (((((((((1,4),5),6),7),8),9),2),3),10). It is not hard to see that no tree, apart from these two, is a caterpillar tree on an [formula]-geodesic between them. Furthermore, if two trees T and R share a partition of taxa, the partition is shared by all trees along the geodesic between T and R in [formula]-space. However, it is not the case in [formula] space. These two properties suggest that [formula]-space might be algorithmically simpler than [formula].

Conclusion and further directions

We have considered two standard parameterisations of the space of ultrametric phylogenetic trees: (1) using lengths of coalescent intervals and (2) using times of divergence events. By considering suitable polyhedral complexes, we have found two possible representations of the space of trees called τ-space and [formula]-space respectively. Despite their similarity, the two parameterisations have significantly different geometric and algorithmic properties. Although it required quite different geometric approaches, we proved that shortest paths are unique in both τ- and [formula]-space. We also proved that shortest paths are efficiently computable in τ-space. We have implemented the algorithm for computing exact shortest paths in Java. We also implemented the algorithms for efficiently approximating Fréchet means, standard variances, and some other geometric and statistical characteristics of finite samples of trees. Although the algorithmic complexity of [formula]-space remains unknown, the space has several properties that are desirable for statistical analysis of tree space. For instance, we proved that the paths that traverse a star tree are often shortest in τ-space and are rarely shortest in [formula]-space. This feature of [formula]-space is a desirable property for phylogenetic applications, and particularly for summarising posterior samples by a point estimate. Indeed, one of the unpleasant features of [formula] space is that parts of the summary tree are often the star-tree, when incompatible subtrees are supported by the posterior. As we have demonstrated in this paper, this feature is a consequence of a fundamental geometric property of the space. The property is that for some pairs of trees the shortest path traverses a star-tree no matter what the branch lengths of the trees are. Both [formula] and τ-space suffer from this feature, while [formula]-space is free from it. Thus we expect summary trees produced using [formula]-space to be more informative and realistic.

Although all results in this paper are presented for ultrametric trees, they can straightforwardly be extended to the set of all time trees, as well as to the set of all sampled ancestor trees.

An obvious direction of further research is to test our algorithms on simulated and real data sets, compare them with known algorithms, and suggest what extra formal properties of a parameterisation of the tree space are desirable. As is suggested in our work, there are other possible ways that equidistant tree space can be parameterised. We have considered two obvious parameterisations and established that they are already quite different. One can certainly come up with many other ways to parameterise the space. The question arises:

Is there, in some sense, a single optimal parameterisation of the tree space? If not, what is the class of acceptable parameterisations?

Our paper suggests a number of directions for further theoretical investigations. An important statistical question is

What parameterisation should be used for coalescent models? Birth-death models? Must the parameterisations used for these two types of models be different?

The first step towards an answer for this question is obviously to consider the coalescent and the birth-death priors in τ- and [formula]-spaces. Are these priors continuous in these spaces? Can the distance between two trees be made a (simple) function of their prior probabilities?

Although much work has been done to investigate [formula] simplicial complexes, no satisfactory characterisation of the complexes is known . Further research is needed with an eye towards effectiveness properties. The problem in general is expected to be hard because even constructing non-trivial examples of [formula] simplicial complexes requires significant effort and only a few such examples are known . In this paper, we have provided such an example--the [formula]-space. Hence the following question, which we ask for [formula]-space, is also important for [formula] simplicial complexes in general.

Is there an efficient (in any sense) algorithm for computing shortest paths between trees in [formula]-space? If yes, how large a data set can be handled using the algorithm?

As we have established in this paper, the measure (volume) of the set of pairs of trees between which the shortest path traverses a star-tree is positive in τ-space and [formula]-space. This measure is positive in [formula] space as well. Furthermore, this measure in [formula]-space is smaller than in [formula] and τ-space. Hence the obvious question to understand the geometry of the space is to find this measure. More precisely:

Let μn be the uniform measure of the set of pairs of trees on n taxa between which the geodesic is a cone path. What is the value of μn for [formula] space? For τ-space? For [formula]-space? Is the sequence {μn}n∈ω convergent? If so, what is the limit lim nμn? What is the meaning of this limit?

Clearly, μ3 = 1 in all [formula], τ- and [formula]-space. To find μ4 is an entertaining exercise.

Acknowledgements

We are grateful to Mike Steel, David Bryant, and Steffen Klaere for useful comments and advice on possible approaches to the problems considered in this paper. We thank Sasha Gavryushkina, Tim Vaughan, and Stéphane Guindon for valuable advice on presentation of the results, and Dmitry Berdinsky and Jacek witkowski for navigating us through modern combinatorial geometry.

AJD was partially supported by a Rutherford Discovery Fellowship and Marsden Fund from the Royal Society of New Zealand. AG was supported by the Rutherford Discovery Fellowship awarded to AJD and by Marsden Fund grant from RSNZ.