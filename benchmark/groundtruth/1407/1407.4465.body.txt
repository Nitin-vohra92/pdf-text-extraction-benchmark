spotrod: a semi-analytic model for transits of spotted stars

Introduction

In a transiting planetary system, spots on the face of the host star can result in deviations in the transit lightcurve from the well-known model described by [\citet=2002ApJ...580L.171M]. An unocculted spot -- since it is darker than the stellar surface -- causes a blend in the opposite sense as a background star, leading to a deeper transit [\citep=2009A&A...505.1277C]. On the other hand, a spot causes an anomalous rebrightening when it is eclipsed by the planet, because the planet blocks less flux than it would if the spot was not behind it.

Such spot-induced transit lightcurve anomalies were first observed by [\citet=2003ApJ...585L.147S] in HST observations of HD 209458. Other systems exhibiting similar features include HD 189733 [\citep=2007A&A...476.1347P] and TrES-1 [\citep=2009A&A...494..391R]. [\citet=2009A&A...505.1277C] found a correlation between stellar brightness and transit depth in the system CoRoT-2, which they attribute to varying levels of stellar activity, and show how this effect, when unaccounted for, causes a bias in the planet size estimate.

In the era of the Kepler satellite, a large number of planets transiting active stars have been discovered and observed with high temporal and photometric resolution, providing further examples of transit anomalies. Two such systems are Kepler-17 [\citep=2011ApJS..197...14D] and HAT-P-11 [\citep=2010ApJ...710.1724B]. Spots revealed by transit anomalies can be used, for example, to constrain the projected obliquity and the stellar inclination [\citep=2011ApJ...740...33D] [\citep=2011ApJ...743...61S]. Measuring the spot contrast allows one to constrain the temperature of the spots [\citep=2003ApJ...585L.147S] [\citep=2009A&A...494..391R]. However, there is a degeneracy between the spot size and contrast [\citep=2007A&A...476.1347P] [\citep=2013MNRAS.428.3671T], which makes high quality data necessary to infer temperatures.

The large number of photometric observations of transit anomalies motivates the development of astrophysical models. Examples include the model by [\citet=2003ApJ...585L.147S], the one by [\citet=2009A&A...504..561W], SOAP-T by [\citet=2013A&A...549A..35O], and prism by [\citet=2013MNRAS.428.3671T]. These models all assume homogeneous, circular spots, with four input parameters for each spot (two for position, one for size, one for darkness). The first two models simplify the geometry by assuming that the spots are circular in projection, while the other two properly account for the elliptical projected shape given spots that are circular on the stellar surface. These models all define a large resolution two dimensional grid either on the stellar surface or in the projection plane, and numerically integrate over two coordinates to calculate the transit lightcurve.

Integration in two dimensions can be computationally expensive. [\citet=2012MNRAS.427.2487K] introduced macula, an analytic model for a related but different phenomenon: spots on the rotating stellar surface modulating out-of-transit lightcurves of spotted stars. Its analytic nature makes macula faster than numerical models for the same phenomenon, like SOAP [\citep=2012A&A...545A.109B].

In this paper, we present spotrod, a counterpart of macula for transit lightcurves of spotted stars. We describe the problem as a two dimensional integral in polar coordinates in the projection plane. Using assumptions similar to those of previous models, we derive an analytic formulation for the integral with respect to the polar angle, so that numerical integration needs to be performed only with respect to the radial coordinate. This semi-analytic nature provides improved speed over previous models requiring two dimensional numerical integration. In particular, if the resolution of the integration grid is n in each dimension, then a double numerical integral takes [formula] time to evaluate, whereas spotrod runs in O(n) time. Typical values are [formula] for SOAP, [formula] for the model of [\citet=2003ApJ...585L.147S], and the grid spacing being one hundredth of the planet diameter for prism, resulting in [formula] for a typical hot Jupiter or [formula] for HAT-P-11b. In this work we use n = 1000.

We describe the semi-analytic model in Section [\ref=sec:geom]: we state the simplifying assumptions, describe the two dimensional integral in polar coordinates, and introduce the subroutines of spotrod, the free and open source implementation available for the astronomical community. In Section [\ref=sec:application], we apply spotrod to Kepler observations of HAT-P-11, investigate model artifacts like observational biases and correlations of fit parameters for individual spots, validate spotrod on synthetic data generated by prism, study the distribution of spot size and contrast on HAT-P-11 that we believe to be physical, and look at the model residuals for validation. Section [\ref=sec:conclusion] concludes our findings. Technical details of the model pertaining to calculating angles and handling spots that are partially behind the limb are given in Appendix [\ref=sec:derivations].

Spot anomaly model

Assumptions

Our model has two major assumptions. The first one is that the boundary of each spot is a circle on the surface of the spherical star. We define the radius a of the spot to be the radius of this circle in three-dimensional space, in units of stellar radius. We assume that 0 < a < 1. Note that the analytic rotational modulation model macula [\citep=2012MNRAS.427.2487K] takes as input parameter the half angle α of the cone with this circle as its directrix and the center of the star as its apex, which is related to the radius by a  =   sin α.

We define the center of the spot as the intersection point of the surface of the sphere and the axis of this cone. Note that the center of the spot does not lie in the plane of the boundary. The advantage of this definition is that the center is on the stellar surface, allowing for easier conversion between input parameters of spotrod and macula, and easier treatment of stellar rotation. A further advantage of characterizing the spot location with the projection of a point on the stellar surface over the projection of the geometrical center of the spot boundary in the interior of the star is that its domain does not depend on the spot radius, which also makes it easier to define an isotropic prior for the location of the spot.

The second assumption is that each spot is homogeneous and observes the same limb darkening law as the star. This means that as viewed by the observer, the ratio of the flux from a spot and the flux from the unspotted stellar surface at the same projected distance r from the center of the star does not depend on the distance r. We denote this dimensionless flux ratio by f in accordance with [\citet=2012MNRAS.427.2487K]. Note that flux ratio is sometimes called contrast, for example, by [\citet=2013MNRAS.428.3671T].

Assuming a constant flux ratio across the stellar disk is consistent with the findings of [\citet=2003SoPh..213..301W]: they study a sample of 18 000 spots on the Sun, and observe no dependence of spot contrast on where the spot is seen. Note that what they call contrast can be expressed as f - 1 using our notation. As for the homogeneity of spots, we shall see in Section [\ref=sec:penumbra] how to compose more complicated structures, like a spot with umbra and penumbra, using two homogeneous spots.

Integration

Let I(r) denote the stellar intensity according to the limb darkening law up to an arbitrary scaling factor, where [formula] is the projected distance from the center of the star in units of stellar radius. Let Cr denote the circle of radius r in the projection plane concentric with the stellar disk. Then the total out-of-transit flux of the unspotted stellar surface can be calculated as a two dimensional integral over the polar coordinates (ϑ,r), with the inner integral along Cr, and the outer integral with respect to the radial coordinate:

[formula]

Here [formula] is the area of an infinitesimal element in the projection plane. The integrand does not depend on ϑ, therefore the inner integral can be evaluated as the product of the integrand I(r) and the length 2π of the integration interval.

Now consider the case of a single spot visible on the star. Let γ(r) be half the central angle of the arc of Cr that overlaps with a spot, as shown on Figure [\ref=fig:observer]. Then the total flux is

[formula]

Here the inner integral is composed of two parts: inside the spot, on an arc of total length 2γ(r), the intensity is fI(r), whereas outside the spot, on the remaining arc of length 2π - 2γ(r), the intensity is I(r). The integrands do not depend on ϑ, therefore each integral reduces again to the product of the integrand and the length of the corresponding interval. In the final step, we factor out 2I(r), and collect the terms with γ(r).

If there are s non-overlapping spots, with corresponding flux ratios fi and half central angle functions γi(r), then each inner integral evaluates to 2γi(r)fiI(r), and the unspotted stellar surface will have an arc length of [formula], giving a total flux of

[formula]

Just as we factored out 2I(r) and collected γ(r) in Equation ([\ref=eq:factoredout]), we can do the same for each γi(r) to account for the contribution of multiple spots in a single summation:

[formula]

During transit, let δ(r) be the half central angle of the arc of Cr that is obscured by the planet. Let γ*i(r) be the half central angle of the arc on the same circle that overlaps with spot i, but is not obscured by the planet. See spot 2 on Figure [\ref=fig:observer] for an example. Then the total flux can be calculated by substituting γ*i(r) for γi(r) in Equation ([\ref=eq:multispot]), and subtracting 2δ(r) from the arc length of the unspotted stellar surface:

[formula]

The contribution of the planet in this formula is formally equivalent to a spot with flux ratio f = 0. The final product of our proposed model is the dimensionless normalized transit lightcurve

[formula]

At this step, the arbitrary scaling factor in I(r) cancels out.

Note that we define γi(r) and γ*i(r) to be zero in case the corresponding arcs do not exist, that is, Cr does not intersect the spot in projection. Similarly, δ(r) is understood to be zero if the planet does not eclipse Cr. See Appendix [\ref=sec:calc] on calculating γi, γ*i, and δ.

In case there are no spots on the stellar surface, even though our model still yields the correct lightcurve asympotically for large grid resolution n, we suggest using the fully analytic algorithm of [\citet=2002ApJ...580L.171M] if speed is a consideration.

Implementation

The model described in this paper is implemented as a software package called spotrod. It provides four functions:

elements takes the planetary period, semi-major axis, k = e cos ϖ, h = e sin ϖ, and an array of observation times of a transiting planet with respect to the time of midtransit as input parameters, and calculates the arrays of planar orbital elements ξ and η using the formalism of [\citet=2009MNRAS.396.1737P].

circleangle takes the planetary radius [formula], the distance z of the centers of the planet and the stellar disk in projection plane, and an array of radii r as input parameters, and calculates the array δ(r).

ellipseangle takes the projected spot semi-major axis a, the distance z of the centers of the projected spot boundary and the stellar disk in projection plane, and an array of r as input parameters, and calculates the array γ(r). This function is executed internally by integratetransit, so the user does not have to call it direcly.

integratetransit takes [formula], arrays of the projected coordinates of the planet and the spots, spot radii and flux ratios, an array of the radii r and weights for numerical integration (the latter are calculated from the integration quadrature and the limb darkening law), and precalculated values of δ(r) for each value of r and each observation time as input parameters. It calculates the normalized lightcurve [formula], using analytic integration with respect to the polar angle, and numerical integration with respect to r.

The software can employ any integration quadrature, that is, numerical method that works by evaluating the integrand at given values of r and summing up using given weights. It evaluates the inner integral analytically in the form of the sum given in Equations ([\ref=eq:multispot]) and ([\ref=eq:transit]) on each annulus defined by the input array of r values. Then it performs numerical integration with respect to r by adding up the products of these values and the corresponding weights.

Among the simplest integration quadratures are the trapezoidal rule and the midpoint rule. We recommend an integration mesh of [formula] values uniformly spaced between 0 and 1. More complicated rules can also be prescribed. For example, since the integrand of the outer integral grows rapidly with r in Equations ([\ref=eq:nospot]-[\ref=eq:transit]), one might wish to use a nonuniform mesh that is coarser for small r and finer for large r.

spotrod can also handle arbitrary limb darkening laws, even ones without an analytic formula: it only relies on limb darkening values evaluated at the values of r used in the integration rule. The limb darkening law and the integration quadrature weights are then multiplied together before they are passed to integratetransit, since it is only their product that is ever used.

Repeated evaluations of integratetransit at the same observation times with fixed planetary orbital parameters are required, for example, for fitting or a Monte Carlo Markov Chain (MCMC) exploring spot parameters. The code has been optimized for such use: one needs to calculate the arrays ξ and η, then the projected planetary coordinates at each observation, and finally an array of δ only once at the beginning. These values do not depend on spot parameters, and recalculating the same values of δ in each iteration would be very costly, since it has to be calculated for each observation time and each r: hundreds of thousands of times in a typical application. Instead, we evaluate δ hundreds of thousands of times only once, before we start the fit or MCMC, and then use these precalculated values.

We can also avoid evaluating the function ellipseangle hundreds of thousands of times in each iteration if we neglect the effect of stellar rotation during a single transit. In this case, for a given set of spots, γi(r) does not depend on time, therefore we only need to calculate it n times: once for each value of r.

It is, of course, also possible to model a transit in the extreme case of a star that rotates so rapidly that spots move substantially during the duration of the planetary transit. In this case, one needs to recalculate the spot positions and call the function integratetransit with a time array of length one for each observation. This method, however, is slower than if we assumed that spots were stationary within the duration of a single transit.

spotrod is free and open source software, released under the GNU General Public License. It is implemented in C in the interest of speed, and provides bindings for use in Python. Bindings for different programming languages should be reasonably easy to add.

spotrod is publicly available for download at https://github.com/bencebeky/spotrod, including the C code, Python bindings, two example programs in Python, compilation instructions, and a copy of the license.

Umbra, penumbra, and faculae

Note that in Equations ([\ref=eq:multispot]-[\ref=eq:transit]), the contribution of spots add up, regardless of whether they overlap or not. As [\citet=2012MNRAS.427.2487K] points out in his Section 2.4, this feature can be used to build a composite spot with a central umbra of radius [formula] and flux ratio [formula] and a surrounding penumbra of radius [formula] and flux ratio [formula] by feeding two concentric spots with radius-flux ratio pairs [formula] and [formula] into the model.

Spots should have flux ratio between 0 and 1, f = 0 for a completely dark spot, and f = 1 for one indistinguishable from the stellar surface. We note that as the model can handle any value of flux ratio f, faculae and plages (bright areas on the stellar photosphere and chromosphere, respectively) can also be modelled using a flux ratio value exceeding 1, as suggested, for example, by [\citet=2012A&A...545A.109B] [\citet=2012MNRAS.427.2487K].

Application to HAT-P-11

HAT-P-11 is 9.6 visual magnitude K4 dwarf star in the field of the Kepler space telescope [\citep=2010Sci...327..977B]. It has been known to host HAT-P-11b, a transiting hot Neptune on a 4.9 day orbit [\citep=2010ApJ...710.1724B], before the launch of the Kepler mission, and therefore has been observed with short (one minute) cadence from the beginning, during quarters 0-6, 9-10, 12-14, and 16-17. Missing data in quarters 7, 11, and 15 are due to the failure of a readout module in 2010 January. In quarter 8, only long cadence observations were taken. We perform our analysis on this dataset, using the flux values in the SAP_FLUX column, and dividing each transit by a linear fit to the out-of-transit data within 0.12 days from the midtransit time to normalize the transit lightcurves. Visual inspection shows that a linear fit is satisfactory, because the out-of-transit lightcurve modulation timescale is the rotation period of HAT-P-11, which is 29.2 days [\citep=2010ApJ...710.1724B] [\citep=2014ApJ...788.....1], much larger than the 0.24 days of the total width of our window.

For our analysis, we adopt the orbital eccentricity and argument of periastron values reported by [\citet=2010ApJ...710.1724B] based on RV data and Hipparcos parallax for HAT-P-11. However, we use the revised transit ephemeris, planetary radius and orbital semi-major axis relative to the stellar radius, orbital inclination, and limb darkening parameters of [\citet=2011ApJ...740...33D]. Their treatment relies on the above eccentricity and argument of periastron values, but accounts for eclipsed and uneclipsed spots, that biased earlier analyses. We number the transits according to this ephemeris, with the midtransit time of transit 0 being T0  =  2  454  605.891  55  ±  0.000  13 (barycentric dynamical time).

Rebrightening events in the transit lightcurve of HAT-P-11 due to spots were first predicted by [\citet=2010ApJ...723L.223W], and first reported independently by [\citet=2011ApJ...743...61S] and [\citet=2011ApJ...740...33D]. They are used to constrain the stellar rotational period by [\citet=2014ApJ...788.....1], who also compare a model out-of-transit lightcurve based on the MCMC chains described in this section, and find that it is consistent with the assumption that out-of-transit variation is dominated by rotation of spots.

Analysis of individual spots

First, we present the analysis of two individual starspots in order to study correlations between spot parameters inherent to the model. Each spot is described by four parameters: x and y are the coordinates of the spot center in stellar radius units, as seen by the observer, in a Cartesian coordinate system whose origin is the center of the stellar disk, and where the planet is moving approximately in the positive x direction during transit. (More precisely, for inclined orbits the y axis is defined by projecting the line of sight on the orbital plane, then projecting that on the sky plane. For an inclined eccentric orbit, the projected velocity of the planet is not exactly parallel to the x axis at mid-transit, except for special values of the argument of periastron.) The other two parameters are the spot radius a and the flux ratio f described in Section [\ref=sec:assumptions].

Figure [\ref=fig:transit218] presents the lightcurves of transits 74 and 218. For both transits, we identify the deviation from the lightcurve model of [\citet=2002ApJ...580L.171M] as an indication for the planet eclipsing a single spot on the surface of the star. The lightcurve anomalies are observed about 0.4 hours before midtransit during transit 74, and about half an hour after midtransit during transit 218. We also plot the best fit (least sum of squared residuals) spotrod lightcurves for both transits in red on this figure.

In fact, for transit 218, we find two best fit solutions: in the projection plane, the spot can either be situated above or below the transit chord. To illustrate this bimodality, we present on Figure [\ref=fig:spots] an observer's view of the star (large empty circle), the planet (black filled circle), and the best fit solutions for the single spot (gray ellipses) during transits 74 and 218. The transit chord is also drawn, as wide as the diameter of the planet. We do not find the same bimodality in case of transit 74, therefore only one solution is depicted. Note that in fact we plot two model lightcurves for transit 218 on Figure [\ref=fig:transit218], corresponding to the best fits for each mode. However, they are indistinguisable on this figure, which is closely related to our inability to infer which solution describes the spot in reality.

We run parallel tempered MCMC simulations [\citep=2005PCCP....7.3910E] for both transits, using the emcee software package [\citep=2013PASP..125..306F], at 10 different temperatures, with 100 concurrent chains at each temperature. We first run both simulations for 1000 steps for burn-in. By inspecting the evolution of the mean and scatter of each parameter, we find that the chain already converges after about half this many steps. Then we run the simulation for another 1000 steps to sample what we believe to be the equilibrium distribution. The lowest, zero temperature chain provides us with the equilibrium distribution, whereas the higher temperature chains guarantee that we explore the entire parameter space, and have samples in disconnected modes in numbers proportional to the corresponding posterior probabilities.

Figure [\ref=fig:mcmc] illustrates the results of the MCMC simulation for the single spot models for transits 74 and 218: joint distributions for four pairs of parameters as well as histograms for each parameter are presented. A dashed line is drawn at the y coordinate of the planet at midtransit, which is very close the the impact parameter b (in fact they would be the same for a circular orbit), to help distinguish the two modes and inspect symmetry with respect to the transit chord. We immediately confirm that there is only one mode for transit 74, and two modes for transit 218. The reason for this is that the anomaly during transit 74 can be well described by a spot that lies under the transit chord, therefore the two modes overlap. On the other hand, the lightcurve of transit 218 can only be well modelled if the spot is further away from the transit chord, in which case the two modes are disconnected. We note that we experience bimodality for roughly one quarter of all spots in the entire Kepler dataset for HAT-P-11.

Figure [\ref=fig:mcmc] also tells us about the correlations of spot parameters. First, we note that in both cases, x is better constrained than y, even within a single mode. Recall that x is the coordinate (almost exactly) parallel to the transit chord, therefore it directly relates to when the anomaly is observed, which is well defined by the observations. On the other hand, we shall see that y correlates with other parameters that together shape the transit anomaly, resulting in a larger uncertainty.

We also note that the two solutions of transit 218 have slightly different best fit x values, even though x is fairly well constrained. The explanation for this is that since the spot is elliptical in projection, with its semi-major axis not quite parallel to the y axis, therefore the two spot solutions must have different x coordinates in order to intersect the transit chord at roughly the same x coordinate. This effect can also be observed on Figure [\ref=fig:spots].

The joint distribution of a and y for the spot in transit 218 on Figure [\ref=fig:mcmc] tells us that the larger the spot is, the further it has to be from the transit chord. This is expected from geometrical arguments, as the duration of the transit anomaly can be well constrained from the observations. This correlation between spot parameters has been first pointed out by [\citet=2003ApJ...585L.147S]. However, this effect does not show for transit 74, probably due to the spot being close to the transit chord.

If we inspect the joint distribution of f and y for either transit, we notice that if the spot is brighter (has a larger flux ratio), then it is likely to be closer to the transit chord. Such a correlation was first noted by [\citet=2009A&A...504..561W], and it remains to be explained.

Finally, we notice that there is a strong correlation between a and f for transit 74: the brighter the spot is, the larger it has to be. This correlation has been reported by [\citet=2007A&A...476.1347P], [\citet=2009A&A...504..561W] and [\citet=2013MNRAS.428.3671T]. This phenomenon is naïvely explained by that the rebrightening amplitude is proportional to how much the flux blocked by the planet is less than it would be for the unspotted photosphere. If a spot is not that much darker than the typical stellar surface, a larger area is required to produce the same flux deficit. This argument is expected to hold for spots centered on the transit chord, for which the spot radius directly determines the occulted area. On the other hand, we do not observe the same a-f correlation for transit 218, becase a correlates strongly with y, resulting in a more complex effect on the occulted spot area.

Test on synthetic lightcurves

In this section, we generate synthetic transit lightcurves, and apply to them the same analysis as in the last section. We use prism [\citep=2013MNRAS.428.3671T] for generating lightcurves, and analyze them using spotrod. Using different models for data generation and analysis allows us to validate them against each other, that is, make sure that parameters like spot radius and flux ratio are interpreted identically, and they produce the same result.

We take the best fit parameters of the spots in transits 74 and 218, convert the projected coordinates to equatorial coordinates as expected by prism, and generate two model transits. The difference from the spotrod model with the same input parameters has mean 10- 8 and standard deviation [formula] across all observation times, which indicates a good agreement between the two models. For comparison, the mean photon noise is [formula] for the same data points.

We find that the spotrod best fit has residuals with a standard deviation approximately 1.3 times that predicted by the SAP_FLUX_ERR data column of the Kepler dataset, therefore we add independent, normally distributed noise scaled to 1.3 times the corresponding SAP_FLUX_ERR value to each data point calculated by prism. We run an MCMC simulation on the resulting synthetic lightcurves for both transits, in a fashion identical to that explained in the previous section. The resulting chain distribution is presented on Figure [\ref=fig:synthetic].

Comparing Figures [\ref=fig:mcmc] and [\ref=fig:synthetic], we find that the chains converge to roughly the same parameters, further confirming that prism and spotrod interpret input parameters in compatible ways. We also find that the extent and shape of the equilibrium distributions, that is, the correlations between spot parameters, are roughly the same. In case of transit 218, even though the synthetic lightcurve is generated based on only one of the two modes, we are unable to determine which mode it is from the MCMC analysis: the distribution is bimodal, just like it was for Kepler observations.

The ultimate test to decide whether bimodality and parameter correlations are inherent properties of lightcurve models, and not unique to the implementation we use, would be to run MCMC analysis using prism or another model, other than spotrod. However, since all previously known models require numerical integration in two dimensions, this would be prohibitively computationally expensive. Instead, we rely on the very small difference of the two lightcurve models when run with the same input parameters to conclude that spotrod reproduces the results of prism.

Distribution of spot parameters

In order to study the spot ensemble distribution, we look for anomalies in 204 transits of HAT-P-11b of which there are complete, high quality short cadence Kepler data. First, we identify transit anomalies by visual inspection, fit spot parameters using guesses as initial values, and run MCMC simulations. In a few cases, we find that the chain abandons our initial fit and converges to a solution of a much larger spot with flux ratio close to one, representing a much longer duration and smaller amplitude lightcurve anomaly. We attribute this to either noise or the effect of a large number of small spots, neither of which we prefer to incorrectly treat as a single, very large spot. We therefore decrease the number of modelled spots by one for such transits, or omit transits that exhibit such a behaviour with a single spot model, in five cases in total. For another ten transits, at most 25% samples of the chain are in an isolated mode representing such an unphysical spot, which samples we discard while keeping the rest of the chain.

We end up with 203 spots in 130 transits. For each transit, we independently run the same parallel tempered MCMC simulations as described in Section [\ref=sec:individual], using the emcee software package, at 10 different temperatures. For 73 transits with one spot each, we use 100 concurrent chains, for 43 transits with two spots each, 200 concurrent chains, for 12 transits with three spots each, we employ 300 chains, and for 2 transits with four spots each, 400 chains. We have four dimensions of parameter space for each spot: x, y, a, and f. We run the simulations for 1000 steps that we discard. Again, inspection of the chain shows that roughly half of this is already enough for convergence. Then we run the chain for another 1000 steps to sample the supposedly equilibrium distribution. This yields the dataset that we use for our analysis in this paper, and the same dataset is used by [\citet=2014ApJ...788.....1].

The next step is to quantify how much better fit these models provide than if we modelled the lightcurve without the spots. In order to do so, we calculate the Bayesian Information Criterion (BIC), which is the sum of χ2 and an additional term penalizing extra model parameters to avoid overfitting [\citep=Schwarz1978]. We find that every single one of the 203 spots yields a BIC value at least 25.0 lower than the model without that spot, which is a very significant improvement, justifying every spot in our analysis. This suggests that probably more spots could be carefully included.

We present the spot radius-flux ratio distribution of all spots on Figure [\ref=fig:mcmcall]. Note that the distribution of most individual spots overlap, except for a few, which appear as separate clusters on the figure. The distribution is bounded from the side of small radius and large flux ratio by an observational bias: whether we visually inspect the lightcurves or apply an algorithmic transit anomaly search, small amplitude anomalies will be lost in photon noise. The maximum eclipsed spot area is the smaller of [formula] and a2 relative to the stellar disk, therefore the maximum transit anomaly amplitude for given a and f is [formula] (not accounting for limb darkening and projection distortion). The actual amplitude of the transit anomaly can be less, depending on y. Figure [\ref=fig:mcmcall] shows the [formula] curve in red, where 0.0002 is an arbitrarily chosen value, which seems to act as an approximate amplitude threshold for anomalies that we detected.

We note that for small spots, individual spot distributions spread along constant [formula] curves. The reason is that this quanitity describes the total amount of flux missing due to the spot, which is directly related to the shape of the transit lightcurve anomaly, and therefore can be well constrained. For small spots, the anomaly does not last long, therefore there are fewer data points than for large spots. This makes it difficult to resolve the degeneracy between radius and flux ratio. For large spots, however, the transit anomaly has a larger amplitude, which can directly be used to infer the flux ratio. Note that consistently with this argument, the rightmost panels of Figure [\ref=fig:mcmc] show that the flux ratio of the small spot seen in transit 74 has a much larger uncertainty than that of the large spot seen in transit 218, even though they have comparable relative uncertainties of their radii.

This effect results in small spots having a weaker constraint on flux ratio. However, as we will see later in this section, this does not indicate the presence of small, dark spots. Because of this large flux ratio uncertainty of small spots, we are not able to detect a significant correlation between spot radius and flux ratio for the 203 spots studied.

Figure [\ref=fig:mcmcall] also presents the spot radius-x coordinate joint distribution of all identified spots. We find two active latitudes, at x  ≈   - 0.2 and 0.4, where there are the most spots, and where spots seem to be the largest. This is in agreement with the findings of [\citet=2011ApJ...740...33D] [\citet=2011ApJ...743...61S]. Note how this panel illustrates that the x coordinate can be very well constrained by the time of transit anomalies.

Finally, the bottom left panel of Figure [\ref=fig:mcmcall] shows the joint distribution of spot radius and y coordinate for all spots. Because of the polar orbit of HAT-P-11b, the latter roughly corresponds to the longitude of the spot on the stellar surface. In this case, we can assume that there is no physical correlation between the two parameters, therefore we have to interpret the joint distribution in terms of observational biases. The observed radius is bounded from below, because very small spots would not cause a detectable signal in the lightcurve. For values of y further from the transit chord, the smallest detectable radius increases for geometrical reasons: the spot has to overlap with the strip that the planet scans on the stellar surface. Finally, the spot radius is bounded from above by the physical distribution of spots, and we expect this to be independent from y. However, this is not reflected on Figure [\ref=fig:mcmcall]: we see that MCMC states with radius above 0.2 prefer values of y further from b. We interpret this as an artifact: we suspect that the lightcurve anomaly due to irregularly shaped spots or spot groups, when mistakenly interpreted as a single spot, results in a large spot further from the transit chord. We believe this radius is unphysical, because we never see transit anomalies that last long enough to require a spot of similar size with y  ≈  b as an explanation. Therefore we conclude that the upper limit of physical spot radius distribution is at most somewhat lower than 0.2, the radius of the largest detected spot with y  ≈  b. It is also possible that this is not a single spot either, so the actual upper radius limit might be smaller than this.

The four side panels on Figure [\ref=fig:mcmcall] show histograms of spot radius, flux ratio, and x and y coordinates, generated from the MCMC chains for all spots. The same observational biases are reflected here: there are no very small ([formula]) spots, and no very bright ([formula]) spots, because these would be undetectable. x has a bimodal distribution according to the two active latitudes, and y is concentrated around the impact parameter, because this is where even small spots are eclipsed by the planet.

To investigate the radius and flux ratio distribution of spots, we plot the median of these parameters in increasing order on Figure [\ref=fig:afsorted]. The top panel presents spot radius, the bottom shows flux ratio. The horizontal axes indicate the rank of the spot in the order of median values. In addition to the median, we shade the 1σ and 3σ intervals of the parameter distribution of each individual spot. The advantage of this presentation over the histograms of Figure [\ref=fig:mcmcall] is that we can disentangle the spread of a spot parameter for an individual spot due to uncertainties from the spread of the ensemble distribution due to spots being different.

Together with the histograms of Figure [\ref=fig:mcmcall], Figure [\ref=fig:afsorted] helps us confirm the observational biases agains small size and large flux ratio. In addition, we note that most spots are smaller than [formula] (three times the radius of HAT-P-11b, which is approximately [formula]), with very few spots around the size of [formula]. We believe that larger spots are artifacts, because they are only seen with y different from b.

On the other hand, even though bright spots are more frequent than dark ones, our first impression is that there is a number of almost completely black spots, that is, spots with f close to zero. (Note that a large number density in terms of a spot parameter, that is, large bin count in the histogram corresponds to a less steep curve when data points are plotted in increasing order of that parameter.) However, when closely inspecting the parameter uncertainties of individual spots, we see that the ones that seem to be consistent with being very dark show a flux ratio distribution that includes much larger flux ratios as well. In fact, only two spots have a 3σ confidence interval that excludes flux ratios above 0.5, even though 30 spots have median flux ratio and 36 spots have best fit (least sum of squared residuals) flux ratio lower than 0.5. On the other hand, more than half of all spots studied have a 3σ confidence interval that allows flux ratios below 0.5. Therefore we cannot either prove or disprove the existence of spots darker than f = 0.5. On the other hand, many spots with flux ratios from approximately 0.6 to 0.9 have small flux ratio uncertainties, suggesting the existence of spots brighter than f = 0.5.

Spot temperature

Assuming that the stellar photosphere and the spots both radiate as black bodies, one can calculate the spot temperature [formula] from the flux ratio f and the effective photospheric temperature [formula]. This method was first applied to infer the spot temperature in the context of spot-induced transit lightcurve anomalies by [\citet=2003ApJ...585L.147S].

We can use the same method to calculate spot temperatures on HAT-P-11 from spotrod MCMC results. We use the photospheric effective temperature result [formula] of [\citet=2010ApJ...710.1724B], and we integrate Planck's law over the Kepler response function to determine the flux ratio as a function of spot temperature. The temperature difference [formula] corresponding to certain values of flux ratio f are displayed on the right vertical axis of the bottom panel on Figure [\ref=fig:afsorted].

As we noted in Section [\ref=sec:spotparameterdistribution], we cannot infer anything about the existence of spots with flux ratio less than 0.5. Therefore we cannot determine whether there are spots with spot temperature below the corresponding temperature of [formula], or a temperature difference of [formula].

On the other hand, Figure [\ref=fig:afsorted] tells us that there are spots with well constrained flux ratios ranging approximately from f = 0.6 to 0.9. In terms of temperature, this means that there exist spots ranging approximately from [formula] to [formula] ([formula] to [formula]). It is possible that HAT-P-11 also has brighter spots (that are not detected due to observational bias), and darker spots.

For comparison, [\citet=2003SoPh..213..301W] show that the Sun exhibits spots ranging from [formula] (with [formula]) up to [formula] (with [formula]), where the flux ratio is measured at 672.3 nm with 10 nm bandpass. This shows that HAT-P-11 is not the only star where individual spots are thought to exhibit a large range of flux ratios.

An advantage of transit anomalies over spectroscopic methods is the ability to measure temperatures of individual spots. For example, [\citet=2004AJ....128.1802O] study TiO absorption features to determine the spot temperature to be [formula] on EQ Vir, a BY Dra-type flare star with [formula], of spectral type K5 Ve, close to K4 of HAT-P-11. This corresponds to a flux ratio of [formula] in the Kepler bandpass. We note that this value is lower than the flux ratio of the majority of spots we found on HAT-P-11, though we were not able to either confirm or exclude the existence of spots with such low flux ratios. However, the result of [\citet=2004AJ....128.1802O] is averaged over all spots visible on the stellar disk, and the temperature range of individual spots cannot be determined by their method.

Transit anomaly duration and amplitude

In addition to investigating the parameters taken by spotrod: x, y, a, and f, it is also interesting to study directly observable properties of spot eclipses: the duration and amplitude of the transit anomaly. Given the results of MCMC calculations, the easiest way to extract these properties is to measure them on model lightcurves. We therefore draw 1000 states from each chain, and generate model lightcurves with one spot each. We calculate the amplitude of the transit anomaly as the maximum deviation from a spotless model, and the duration of the transit anomaly as the length of the time interval on which the model with one spot predicts more flux than the spotless model. The resulting distribution is plotted on Figure [\ref=fig:durationamplitude].

The transit anomaly duration-amplitude distribution is confined from three sides. The amplitude is bounded from below, as described in Section [\ref=sec:spotparameterdistribution]. We draw a red line on Figure [\ref=fig:durationamplitude] at A = 0.0002, the same amplitude value as on Figure [\ref=fig:mcmcall]. Note, however, that the transit anomaly amplitude is represented directly on Figure [\ref=fig:durationamplitude], whereas on Figure [\ref=fig:mcmcall], we could only calculate the maximum possible value [formula] for given values of a and f.

Figure [\ref=fig:durationamplitude] tells us that visual inspection as performed by the authors results in an amplitude limit that is mostly constant across anomaly durations. Anomalies selected programmatically, however, might have a different boundary, as it is possible to identify an anomaly with a smaller amplitude in noisy data if it lasts sufficiently long.

From the side of short anomalies, the distribution is bounded by geometrical arguments. The amplitude of the anomaly tells us how much flux is missing with respect to a spotless transit. This places a lower limit on the geometrical extent of the spot, which then translates to the duration of the event. To characterize this boundary, we feed 10 000 random black spots with to spotrod, and plot the envelope of their duration-amplitude distribution in black on Figure [\ref=fig:durationamplitude]. Gray spots (f > 0) would cause anomalies with the same duration but smaller amplitude than if they were black (f = 0), therefore we only draw black spots to determine this boundary. We notice that the MCMC distribution extends close to this boundary, which means that the chains contain spot states that are almost entirely black. As discussed in Section [\ref=sec:spotparameterdistribution], however, this does not mean that the best fit for those spots is necessarily black.

From the right and above, however, the distribution does not extend to its theoretical limits: the maximum conceivable amplitude would be the transit depth (for a black spot that is larger than the planet), and the maximum conceivable transit duration would be the transit duration. The largest amplitude we observe is roughly half of this, and the longest anomaly lasts only about one quarter of the entire transit. We interpret these limits as indications of the actual spot parameter distribution, namely the lack of large dark spots, and the upper limit on spot size [formula]. We also note that on Figure [\ref=fig:durationamplitude], the longest transit anomalies seem to have small amplitudes, for which we cannot offer an explanation.

While measuring directly observable quantities like transit anomaly duration and amplitude on models generated by spotrod is very convenient, we note that this inevitably introduces biases. For example, if we observe an anomaly with duration and amplitude that would place it on the left of the black curve on Figure [\ref=fig:durationamplitude], that could not be reproduced by spotrod, and consequently we would measure different duration and amplitude values with our method. However, our MCMC analysis disentangles multiple spots and measures transit anomaly durations efficiently, and still yields meaningful conclusions about the darkness of spots and the amplitude threshold for detection.

Residuals

Finally, we study the distribution of residuals to assess the goodness of fit, and to compare our model with 203 spots to the spotless lightcurve model. We calculate lightcurves using spotrod and the Mandel-Agol model for the two cases, respectively. We only consider the residuals at observations that took place during transits (between first and fourth contact). We use the SAP_FLUX_ERR column calculated by the Kepler Photometric Analysis module as the error estimate of the lightcurve data in the SAP_FLUX column. Figure [\ref=fig:residuals] displays the normalized residual distribution histograms: in black when calculated using the spotless model, and in red when calculated using our model with spots, with a logarithmic vertical scale. The spotless model residuals have a large excess on the positive side, which we attribute to the presence of spot-induced transit lightcurve anomalies. On the other hand, our spotrod model accounts for enough spots to make the residual distribution fairly symmetric. We note that this might potentially be used as a detection method to identify targets that exhibit spot-induced transit anomalies.

In terms of the Mandel-Agol fit, it is interesting to note that the largest residual is 25.75σ. Comparing this to the transit depth of roughly 50 sigma, we see that the largest transit anomaly has an amplitude of half the transit depth, just as we noted in Section [\ref=sec:durationamplitude]. (The exact transit depth expressed in units of photon noise varies due to the quarterly rotations of the Kepler satellite.)

The relative error of HAT-P-11 photometry is very small ([formula]). Assuming that it is dominated by photon noise, the error distribution can be approximated with an independent normal distribution for each data point. In this case, it is valid to calculate χ2, and from that, reduced χ2. For the models without and with spots, we get the strikingly different values [formula] and [formula], respectively.

The total number of observations taken during the 130 transits is N = 18  135. Since we fix orbital parameters, transit ephemeris, and limb darkening, the spotless model has no fit parameters. With the number of data points as the degrees of freedom, we get [formula], which, being much larger than unity, motives a model with more free parameters.

Our spot model has four fit parameters for each spot, that is [formula] fit parameters in total. Note, however, that [\citet=2010arXiv1012.3754A] prove that it is not justified to calculate the degrees of freedom as K = N - P for non-linear models like spotrod, and in fact no reliable method is known to calculate K in general. Therefore we give the value [formula] for reference only, and are left with the symmetry of the histogram as the only way to quantify the goodness of the fit.

Conclusion

In this paper, we present spotrod, a transit lightcurve model accounting for both eclipsed and uneclipsed starspots. The advantage of our model over previous methods is that in polar coordinates, we integrate analytically with respect to the polar angle, therefore time-consuming numerical integration only remains to be performed along a single dimension, the radial coordinate. This feature makes our model fast enough not only for fitting, but also for efficient statistical investigations using, for example, MCMC. A free and open source implementation of our model is publicly available.

The model assumes that spots follow the same limb darkening law as the stellar photosphere, consistent with observations of the Sun [\citep=2003SoPh..213..301W]. It also assumes that spots are homogeneous. Umbra-penumbra structure can be mimicked by superimposing two concentric spots, while bright features can also be modelled using a flux ratio exceeding unity.

We apply our model to Kepler data of HAT-P-11 transits. We investigate correlations between fit parameters of individual spots, and confirm findings of previous investigations using similar models. We also study the size and flux ratio distributions. We establish an upper limit of [formula] for the spot radius, and find strong indication for the presence of spot with flux ratio ranging from 0.6 to 0.9, corresponding to an effective temperature 100 to 450 K lower than that of the spotless photosphere. We cannot prove nor disprove the existence of spots with flux ratio less than 0.5. We do not find a significant correlation between spot size and flux ratio.

While HAT-P-11 is unique in its brightness and large transit anomaly amplitudes within the Kepler field, spotrod can potentially be used to model Kepler observations of other transiting planetary hosts. In addition, comparable quality photometric observations are expected to taken of a much larger number of stars, for example, by the K2 mission of the Kepler satellite [\citep=2014AAS...22322801H], and by the Transiting Exoplanet Survey Satellite [\citep=2010AAS...21545006R].

While our model provides a good fit to observations of HAT-P-11, it is important to keep in mind that our perfectly circular and homogeneous spots are a simplified version of what the stellar surface actually looks like. However, mapping out the projected stellar surface by, for example, two dimensional deconvolution with the planetary disk, is an underdetermined and potentially numerically unstable inversion problem. The general advantage of model simplifications is that the small degree of freedom makes fitting robust. This is exactly what spotrod provides: a simplistic, approximate, but robust and fast way to model transit lightcurves of spotted stars.

Acknowledgements

Work by B.B. and M.J.H. was supported by NASA under grant NNX09AB28G from the Kepler Participating Scientist Program and grants NNX09AB33G and NNX13A124G under the Origins program. D.M.K. is funded by the NASA Carl Sagan Fellowships. This paper includes data collected by the Kepler mission. Funding for the Kepler mission is provided by the NASA Science Mission directorate. The MCMC computations in this paper were run on the Odyssey 2.0 cluster supported by the FAS Science Division Research Computing Group at Harvard University. B.B. is grateful to Robert Noyes for useful comments on the manuscript, and to John A. Johnson for suggesting the name spotrod.

Derivations

Geometry

Let and denote the coordinates of the center of the spot as seen by the observer, in a Cartesian coordinate system with the center of the stellar disk as the origin, in stellar radius units. Then the angle between the plane of the spot boundary and the line of sight is

[formula]

Figure [\ref=fig:sideview] shows a side view. Note that this is the same β that [\citet=2012MNRAS.427.2487K] defines in his Equation (1).

In projection (as seen by the observer), the spot is an ellipse with semi-major axis a, and semi-minor axis

[formula]

The center of this ellipse is the projection of the intersection point of the axis of the cone and the plane in which the spot boundary lies, not the projection of the center of the spot which is on the stellar surface. The center of the ellipse lies at a distance of [formula] from the center of the star, therefore in projection, the distance between the center of the stellar disk and the center of the ellipse is

[formula]

Expressing [formula] from Equation ([\ref=eq:z]) and substituting into Equation ([\ref=eq:b]), we can express b in terms of a and z:

[formula]

The input parameters of the subroutine integratetransit are , , and a: it calculates z from Equation ([\ref=eq:z]), and passes it to ellipseangle, which in turn calculates b using Equation ([\ref=eq:b1]).

Calculating γ, γ*, and δ

To calculate γ(r), consider a Cartesian coordinate system in the projection plane with the center of the ellipse as the origin, the x axis parallel to the semi-major axis, the y to the semi-minor axis. Let the center of the stellar disk be at (0,z), and let (x,y) denote an intersection point of the ellipse and Cr. See Figure [\ref=fig:ellipse]. Then (x,y) satisfies the following set of quadratic equations:

[formula]

If there are no intersection points, then Cr is either located entirely outside the ellipse, thus γ = 0, or entirely inside, in which case γ  =  π. If there are one, two, three, or four intersection points, then they must be located symmetrically around the y axis, because if (x,y) is a solution, then so is ( - x,y) (and they coincide if x = 0). After solving for y, we calculate γ using

[formula]

Appendix [\ref=sec:limb] discusses the case of four intersection points. One or three intersection points are singular cases between other cases, and can be treated along with the case on either side.

Let [formula] denote the radius of the planet, and [formula] its projected separation from the center of the stellar disk, both in stellar radius units. To calculate δ(r), we could repeat the above derivation with [formula]. Or we can use the law of cosines in the triangle defined by the center of the star, the center of the planet, and the intersection point of the edge of the planet with Cr:

[formula]

as seen on Figure [\ref=fig:cosines]. Again, the cases of Cr being disjoint from or entirely occulted by the planet should be tested for separately, yielding δ = 0 and δ  =  π, respectively.

Finally, let θ denote the angle between the center of the spot and the center of the planet as seen from the center of the star, which we also calculate using the law of cosines. We always choose the angle for which [formula]. Now γ*(r) is determined by γ(r), δ(r), and θ according to the following cases:

[formula]

In the first case, the arcs are disjoint, therefore none of the spot arc is eclipsed by the planet. This happens to spot 1 on Figure [\ref=fig:observer]. In the second case, the entire planet arc gets subtracted from the spot arc. The part of the spot arc that is not occulted by the planet is now composed of two arcs on either side of the planet, and we define γ* as half the total central angle of them. In the third case, the planet occults the entire spot arc. "Otherwise" for the last two cases means that the triangle inequality holds between γ, δ, and θ. In the fourth case, the planet and spot arcs overlap in a single arc. This happens to spot 2 on Figure [\ref=fig:observer]. In the last case, they overlap in two arcs. This can happen only if at least one of the planetary disk and the spot ellipse contain the center of the stellar disk in projection. This situation is illustrated by Figure [\ref=fig:circular].

The function circleangle calculates β from r, [formula], and [formula], ellipseangle calculates γ from r, z, and a, and finally integratetransit calculates γ* based on Equation ([\ref=eq:cases]), evaluates the integrals of Equations ([\ref=eq:multispot]) and ([\ref=eq:transit]), and calculates [formula] according to Equation ([\ref=eq:normalized]).

Spots partially behind the limb

The boundary of the spot is assumed to be a circle, therefore its projection (as seen by the observer) is an ellipse. However, we must investigate whether the boundary of what we see of the spot coincides with the projection of its boundary on the stellar surface. It is easy to see that it is indeed the case as long as no part of the spot covers another part of it. That is, as long as the entire spot is visible, we will always see it as an ellipse. (Remember the caveat that the center of this ellipse is not the projection of what we defined as the center of the spot.)

However, when the spot partially hides behind the stellar limb, we will see it as a shape bounded by an arc of an ellipse (the projection of the spot boundary) and an arc of a circle (the edge of the stellar disk), as illustrated on Figure [\ref=fig:limbspot]. We prove in the next section that in this case, the ellipse touches the stellar limb from the inside.

The two cases (the entire spot visible, or part of it is behind the limb) are delineated by a critical value of β, or equivalently, a critical value of z, both of which we expect to depend only on a. From Figure [\ref=fig:sideview], we can see that in this critical case,

[formula]

using Equation ([\ref=eq:z]) to express z in terms of a and β.

If [formula], then the entire spot is visible. If [formula], then the ellipse touches the edge of the stellar limb at one point, as we prove in the next section. If [formula], then part of the spot is behind the stellar limb. Note that since we describe the spot with the parameter z (implicity, through xs and ys), z = 1 corresponding to the spot center being on the stellar limb, therefore we cannot deal with spots that are partially visible, but their center is behind the limb. Such spots, however, will have a small contribution to Fs and [formula], because only a very small part of them is visible, furthermore this small part is on the limb, which is usually darker to start with. Furthermore, since [formula] as long as [formula], omitting such a spot will have a very small effect on [formula].

Number of intersection points

In this section, we prove that as long as [formula], the spot boundary and Cr can have at most two intersection points. We also explain how to correctly model the ellipse in terms of γ if [formula] and there are four intersection points. Finally, we prove that if [formula], then the spot boundary ellipse touches the stellar limb at one point, and if [formula], then at two points.

Let us express x2 from Equation ([\ref=eq:quad1]) and substitute into Equation ([\ref=eq:quad2]). This results in a quadratic equation for y:

[formula]

Equation ([\ref=eq:quad1]) tells us that each solution y represents two intersection points if |y| < b, one if |y| = b, or none if |y| > b. Now let us consider the following inequality:

[formula]

This inequality is a sufficient condition for that y- does not represent real intersection points, that is, there are at most two intersection points (corresponding to y+) Now we increase the left hand side of Inequality ([\ref=ineq:proveme]). This will make it sharper, leading to a more restrictive, therefore still sufficient (but not necessary) condition. If we find at the end that this still holds whenever [formula], that proves our original statement:

[formula]

Assume that z > 0, in which case we also have a > b and thus A > 0. Then multiplying by [formula] does not change the direction of inequality:

[formula]

Substituting b from Equation ([\ref=eq:b1]), we get:

[formula]

Both sides of Inequality ([\ref=ineq:gettingthere]) are positive, therefore we can square them to get an equivalent inequality:

[formula]

We are also allowed to multiply by (1 - a2)2, which has to be positive. Finally, we arrive exactly at the critical value of z that we have already established.

This derivation shows that if Inequality ([\ref=ineq:final]) holds, then so does Inequality ([\ref=ineq:proveme]). That is, if the spot is entirely visible, then there are at most two intersection points.

To understand the dependence of the number of intersection points on r, we plot y± as a function of r on Figure [\ref=fig:ypm]. So far we have proven that if [formula], then y- <  - b for all values of r, which case is illustrated on the top panels. We have one intersection point if and only if |y+| = b, which happens at r = z  ±  b, when Cr touches the ellipse.

In case [formula], let us investigate how to properly account for the spot shape. If r < z - b, then Cr is disjoint from the spot. At r = z - b, the circle Cr touches the ellipse, we have y+ = b, yielding x = 0 as a multiple root for the intersection point. Further increasing r will result in y+ < b, representing two distinct real solutions for x. When r reaches z + b, Cr will touch the ellipse from the inside at a point corresponding to y- =  - b, x = 0: this is the third point of intersection.

This can happen if and only if the radius R of the osculating circle at the endpoint of the semi-minor axis is larger than r = z + b. As a sanity check, let us investigate what it means in terms of z:

[formula]

This inequality is [formula] times Inequality ([\ref=ineq:samecrit]) with the inequality sign in the other direction. Inequality ([\ref=ineq:samecrit]), in turn, is equivalent to Inequality ([\ref=ineq:final]). That is, the condition on the curvature of the ellipse is equivalent to Inequality ([\ref=ineq:final]) with the inequality sign in the other direction: [formula]. This is consistent with our previous statements.

Further increasing r will yield four distinct intersection points, with - b < y- < y+ < b. This scenario is also demonstrated on Figure [\ref=fig:limbspot]. By continuity, the outside pair of intersection points corresponds to y+, because they exist ever since r = z - b. The inside pair only appeared at r = z + b, and therefore corresponds to y-, which crossed - b at the same value of r.

Our code always calculates γ based on y+. This means that the entire arc between the outside intersection points is considered to be part of the spot, which correctly describes the shape of the spot as the observer sees it. That is, the code gives the correct result even in case [formula].

Finally, if r = 1, then the inside and outside pair of intersection points coincide according to Figures [\ref=fig:limbspot] and [\ref=fig:ypm]: the ellipse touches the stellar limb from the inside. Another way of saying this is y- = y+, which happens exactly if the discriminant of Equation ([\ref=eq:quadratic]) is zero. We now prove this statement.

[formula]

The last equation trivially holds true, which proves that if r = 1, then y-  =  y+. Note that this is true regardless of the value of z: if [formula], then y-  =  y+  <   - b (no real solution for x, no intersection points); if [formula], then y-  =  y+  =   - b (touching in a single point with x = 0, quadruple root); and if [formula], then y-  =  y+  >   - b (touching at two points, multiple roots each, like on Figures [\ref=fig:limbspot] and [\ref=fig:ypm]), as seen from Ineqalities ([\ref=ineq:root]-[\ref=ineq:final]). This concludes our proof.