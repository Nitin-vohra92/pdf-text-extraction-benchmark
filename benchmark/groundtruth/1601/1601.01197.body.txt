Corollary Lemma Observation Conjecture Example =0 =

Three-coloring triangle-free graphs on surfaces VII. A linear-time algorithm

3 Jan 2015.

Daniel Král'

Robin Thomas

Introduction

This paper is the last part of a series aimed at studying the 3-colorability of graphs on a fixed surface that are either triangle-free, or have their triangles restricted in some way (throughout the paper, all colorings are proper, i.e., adjacent vertices have different colors). The main result of this paper is a linear-time algorithm to decide 3-colorability of a triangle-free graph embedded in a fixed surface. Embeddability in a surface is not a sufficient restriction by itself, as 3-colorability of planar graphs is NP-complete [\cite=garey1979computers]. Restricting the triangles is natural in the light of the well-known theorem of Grötzsch stating that every planar triangle-free graph is 3-colorable.

A graph G is 4-critical if every proper subgraph of G is 3-colorable, but G itself is not. Clearly, a graph is 3-colorable if and only if it has no 4-critical subgraph. As was shown by Thomassen [\cite=thomassen-surf] and later (with better bounds) by us [\cite=trfree3], for every surface Σ, there are only finitely many 4-critical graphs of girth at least 5 that can be embedded in Σ. Hence, to decide whether a graph of girth at least 5 embeddable in Σ is 3-colorable, it suffices to test the presence of these finitely many subgraphs, which can be done in linear time using the algorithm of Eppstein [\cite=bib-eppstein99].

The situation is more complicated with triangle-free graphs. The Mycielski graph of any odd cycle embeds in any surface other than the sphere. Furthermore, Youngs [\cite=Youngs] gave more general infinite families of 4-critical triangle-free graphs embeddable in any non-orientable surface. However, in [\cite=trfree4] we showed that most of the faces of such a graph are of length 4. In order to state the result precisely, let us first give a few definitions.

A surface is a compact connected 2-manifold with (possibly null) boundary. Each component of the boundary is homeomorphic to a circle, and we call it a cuff. For non-negative integers a, b and c, let Σ(a,b,c) denote the surface obtained from the sphere by adding a handles, b crosscaps and removing the interiors of c pairwise disjoint closed discs. The classification theorem of surfaces shows that every surface is homeomorphic to Σ(a,b,c) for some choice of a, b and c. The Euler genus g(Σ) of a surface Σ homeomorphic to Σ(a,b,c) is defined as 2a + b. Consider a graph G embedded in the surface Σ; when useful, we identify G with the topological space consisting of the points corresponding to the vertices of G and the simple curves corresponding to the edges of G. A face f of G is a maximal connected subset of Σ - G. By the length |f| of f, we mean the sum of the lengths of the boundary walks of f (in particular, if an edge appears twice in the boundary walks, it contributes 2 to |f|). A face f is 2-cell if it is homeomorphic to an open disk, and it is closed 2-cell if additionally its boundary forms a cycle in G.

Finally, we are ready to state the result.

There exists a constant κ with the following property. Let G be a graph embedded in a surface of Euler genus g. Let t be the number of triangles in G and let c be the number of 4-cycles in G that do not bound a 2-cell face. If G is 4-critical, then

[formula]

Furthermore, in the previous paper of the series [\cite=trfree6], we designed a 3-coloring algorithm for graphs with almost all faces of length 4. A graph H is a quadrangulation of a surface Σ if all faces of H are closed 2-cell and have length 4 (in particular, the boundary of Σ is formed by a set of pairwise vertex-disjoint cycles in H, called the boundary cycles of H). A vertex of G contained in the boundary of Σ is called a boundary vertex.

For every surface Σ and integer k, there exists a linear-time algorithm with input

G: a quadrangulation of Σ with at most k boundary vertices, and

ψ: a 3-coloring of the boundary cycles of G,

which correctly decides whether there exists a 3-coloring φ of G such that φ(v) = ψ(v) for every boundary vertex v of G. In the affirmative case, the algorithm also outputs such a coloring φ.

By combining Theorems [\ref=thm:ctvrty] and [\ref=thm-quadalg], we obtain a straightforward algorithm to test 3-colorability of a triangle-free graph embedded in a fixed surface, at least under the assumption that all 4-cycles in G bound 2-cell faces--enumerate all subgraphs H of G such that

[formula]

and test whether they are 3-colorable. It can be shown that are at most |V(G)|5κg subgraphs of G satisfying ([\ref=eq-shf]), and thus for any fixed surface, we obtain a polynomial-time algorithm. However, the exponent of the polynomial bounding the complexity of this algorithm depends on the surface. In this paper, we use a more involved argument to design a linear-time algorithm deciding 3-colorability. Furthermore, similarly to Theorem [\ref=thm-quadalg], we can allow a bounded number of precolored vertices in the considered graph. The following is our first main result.

For every surface Σ and integer k, there exists a linear-time algorithm with input

G: a triangle-free graph embedded in Σ with at most k boundary vertices, and

ψ: a function from boundary vertices of G to {1,2,3},

which correctly decides whether there exists a 3-coloring φ of G such that φ(v) = ψ(v) for every boundary vertex v of G.

Note that unlike Theorem [\ref=thm-quadalg], Theorem [\ref=thm-mainalg] does not return a 3-coloring if one exists; indeed, the algorithm only decides whether there exists a critical subgraph. Let us remark that this is often the case; even in the case of planar graphs, a linear-time algorithm to actually find a 3-coloring guaranteed by Grötzsch's theorem was only designed recently [\cite=DvoKawTho]. In order to report a 3-coloring, we need to go deeper into the proof of Theorem [\ref=thm:ctvrty]. The proof is based on the method of discharging and reducible configurations, and in Section [\ref=sec-repalg], we convert it to the following algorithm.

For every surface Σ and integer k, there exists a quadratic-time algorithm with input

G: a triangle-free graph embedded in Σ with at most k boundary vertices, and

ψ: a function from boundary vertices of G to {1,2,3},

which correctly decides whether there exists a 3-coloring φ of G such that φ(v) = ψ(v) for every boundary vertex v of G, and outputs such a coloring in the affirmative case.

Let us remark that we believe that there exists a linear-time algorithm to output a 3-coloring using ideas similar to those of Theorem [\ref=thm-mainalg]; however, there are significant technical challenges in designing it and we leave this as an open problem. Let us also remark that in Theorems [\ref=thm-mainalg] and [\ref=thm-mainalgrep], it would suffice to only forbid the existence of contractible triangles, as we can deal with non-contractible ones by cutting the surface along them (see Theorem [\ref=thm-mainalg-spec4] for a similar idea used to eliminate non-contractible 4-cycles).

In the following section, we recall the results and definitions from the previous papers of the series we are going to need. In Section [\ref=sec-freedom], we define a key notion of a free set of faces and apply it to the special case of graphs embedded in the disk. In Section [\ref=sec-linalg], we give the linear-time decision algorithm. Finally, in Section [\ref=sec-repalg], we give the algorithm to output a 3-coloring if one exists.

Definitions and previous results

We need a stronger form of Theorem [\ref=thm:ctvrty] which deals with graphs with precolored cycles. First, let us give several definitions. Suppose that a graph G is embedded in a surface Σ so that every cuff of Σ traces a cycle in G, let H be a subgraph of G, and let h be a face of H. Let Σh denote the surface whose interior is homeomorphic to h, let θh:Σh  →  Σ be a continuous function whose restriction to the interior of Σh is a homeomorphism to h, and let Gh  =  θ- 1h(G). Let [formula] be defined by

[formula]

To each 2-cell face f of G, we assign a weight w0(f) = s(|f|). If f is not 2-cell, then let w0(f) = |f|. For a surface Π of Euler genus g with c cuffs, let s(Π) = 6c - 6 if g = 0 and c  ≤  2, and s(Π) = 120g + 48c - 120 otherwise. For a real number η and a face f of G, let wη(f) = w0(f) + ηs(Σf). Let

[formula]

There exists a constant η > 0 such that the following holds. Let G be a triangle-free graph embedded in a surface Σ without non-contractible 4-cycles, so that every cuff of Σ traces a cycle in G, and let B be the union of boundary cycles of G. There exists a subgraph H of G such that B  ⊆  H, wη(H)  ≤  wη(B) and for every face h of H, every 3-coloring of the boundary of h extends to a 3-coloring of Gh.

Throughout the rest of the paper, let η denote the constant of Theorem [\ref=thm-almstruct]. We also need a stronger variant for the disk, see Corollary 5.4 in [\cite=trfree4].

Let G be a triangle-free graph embedded in the disk with boundary cycle B. Then either every 3-coloring of B extends to a 3-coloring of G, or there exists a connected subgraph H  ⊆  G such that [formula] and w0(H)  ≤  s(|B| - 2).

If some 3-coloring φ of B does not extend to a 3-coloring of G, then let [formula] be a minimal subgraph of G such that φ does not extend to a 3-coloring of H. By Grötzsch's theorem and the minimality of H, we conclude that H is connected. Furthermore, it is easy to see that H is B-critical (in the sense defined in Section 2 of [\cite=trfree4]), and by [\cite=trfree4], we have w0(H)  ≤  s(|B| - 2).

Consider a graph G embedded in a surface Σ. A cycle K is contractible if there exists a closed disk Δ  ⊆  Σ with boundary equal to K. For a cuff C, let Σ  +  Ĉ denote the surface obtained from Σ by adding an open disk disjoint from Σ and with boundary equal to C; we say that Σ  +  Ĉ is obtained from Σ by patching a cuff. A cycle K surrounds a cuff C if K is not contractible in Σ, but it is contractible in Σ  +  Ĉ.

For algorithms, we need to specify how a graph G embedded in Σ is represented. Let g be the Euler genus of Σ and c the number of cuffs of Σ. We use the following variant of the polygonal representation. Let H be a graph drawn in Σ such that

the boundary of every cuff traces a cycle in H,

every edge of H is either equal to an edge of G, or intersects G only in vertices,

H has exactly one face and this face is homeomorphic to an open disk Λ, and

H has at most 2(g + c - 1) vertices of degree three.

The graph G embedded in Σ is represented by a graph G' drawn in a closed disk Δ, such that there exists a continuous surjection θ:Δ  →  Σ satisfying

G' = θ- 1(G),

the restriction of θ to the interior of Δ is a homeomorphism to Λ, and

θ maps the boundary of Δ to the boundary walk of the face Λ of H.

Note that there exist pairwise internally disjoint closed intervals A1, B1, A2, B2, , Ap, Bp for some p  ≤  3(g + c) + 1 such that the restriction of θ to each of them is injective, θ(Ai) = θ(Bi) for 1  ≤  i  ≤  p, and [formula] is the subgraph of H consisting of edges not contained in any of the boundary cycles of G. Hence, the surface Σ is obtained from the disk Δ by identifying Ai with Bi for 1  ≤  i  ≤  p, in the direction prescribed by θ. We call this representation of an embedded graph a normal representation. Let us remark that a normal representation can be obtained from any other common representation of an embedded graph in linear time.

We also use a data structure we designed in [\cite=trfree6], see Lemma 4.6.

For any integer d  ≥  0 and every surface Σ, there exists a data structure as follows. The data structure represents a graph G with a 2-cell embedding in Σ and supports the following operations in amortized constant time (depending only on d and Σ):

Removal of an edge or an isolated vertex.

For any vertex v∈V(G), deciding whether there exists a closed walk W of length at most d with v∈V(W) such that W is not null-homotopic even after patching any one cuff of Σ with a disk, and finding such a walk if that is the case.

For any vertex v∈V(G) and any set D of cuffs of Σ, letting Σ' be a surface obtained from Σ by patching all the cuffs in D and letting Λ  ⊆  Σ' be an open disk containing all the patches, deciding whether there exists a closed walk W in G of length at most d such that W contains v and is homotopically equivalent (in Σ) to the boundary of Λ, and finding such a walk if that is the case.

Given a normal representation of G, the data structure can be initialized in O(|V(G)|) time.

In [\cite=trfree6], we designed several useful algorithms. One of them can be used to eliminate contractible (  ≤   4)-cycles.

For any surface Σ, there exists a linear-time algorithm that for any graph G with a 2-cell embedding in Σ returns its subgraph H such that

H is 2-cell embedded in Σ and all boundary cycles of G belong to H,

all contractible cycles in H of length at most 4 bound 2-cell faces, and

all vertices and edges of G that do not belong to H are drawn in 2-cell (  ≤   4)-faces of H.

We will need this result in combination with the algorithm of Dvoák, Kawarabayashi and Thomas [\cite=DvoKawTho].

There exists a linear-time algorithm as follows. Let G be a plane triangle-free graph with the outer face bounded by a cycle C of length at most 5. Given a 3-coloring ψ of C, the algorithm returns a 3-coloring of G that extends ψ.

In particular, in the situation of Lemma [\ref=lemma-elim24], any 3-coloring of H can be extended to a 3-coloring of G in time [formula].

Consider a graph G embedded in a surface Σ. A subgraph H of G is non-essential if there exists Λ  ⊂  Σ containing H, where Λ is either an open disk, or an open disk with a hole whose boundary is equal to a cuff of Σ. A subgraph H of G is essential if it is not non-essential. We say that a surface Σ' is at most as complex as Σ if Σ' has smaller genus than Σ, or Σ' has the same genus and fewer cuffs than Σ, or Σ' is homeomorphic to Σ. For a graph G embedded in Σ, let b(G) denote the multiset of the lengths of the boundary cycles of G. For two multisets S, T of integers such that |S| = |T| = m, we say that S dominates T if there exists an ordering [formula] of the elements of S and an ordering [formula] of the elements of T such that si  ≥  ti for [formula].

The following algorithm is useful when dealing with essential subgraphs; let us recall that the notations Σh and Gh were defined at the beginning of this section.

Let ν(Σ,k) be any function. For any surface Σ and integer k  ≥  0, there exists a constant σ and a linear-time algorithm as follows. Let G be a graph 2-cell embedded in Σ with boundary cycles B1, , Bc of total length at most k. The algorithm returns a subgraph H of G with at most σ vertices such that [formula] and for each face h of H, Gh (in its embedding in Σh) does not contain any connected essential subgraph with fewer than ν(Σh,kh) edges, where kh is the sum of the lengths of the boundary cycles of Gh. Furthermore, Σh is at most as complex as Σ, and if Σh is homeomorphic to Σ, then b(G) dominates b(Gh).

We also need a similar algorithm to deal with the cylinder case.

Let d be a positive integer. There exists a linear-time algorithm that, given a graph G that is 2-cell embedded in the cylinder Σ with boundary cycles B1 and B2 of length at most d, returns a sequence C0, C1, , Cm of non-contractible cycles of G of length at most d such that

C0 = B1 and Cm = B2,

for 0  ≤  i < m, the cycle Ci is contained in the part of Σ between B1 and Ci + 1, and

either Ci intersects Ci + 1, or the subcylinder of Σ between Ci and Ci + 1 contains no non-contractible cycle of length at most d distinct from Ci and Ci + 1.

Freedom

Let G be a triangle-free graph with a 2-cell embedding in a surface Σ. Let S be a set of faces of G and let W be a contractible closed walk in G forming the boundary of an open disk Λ  ⊂  Σ. We say that W binds S (with respect to Λ) if [formula] and

[formula]

We say that S is k-free if no closed walk of length at most k binds S. The key observation is that the presence of a large free set ensures the possibility to extend a precoloring.

Let G be a triangle-free graph with a 2-cell embedding in the disk Δ, with boundary cycle B. If G contains a (|B| - 2)-free set S of faces such that [formula], then every 3-coloring of B extends to a 3-coloring of G.

Suppose for a contradiction that some 3-coloring of B does not extend to a 3-coloring of G. By Theorem [\ref=thm-diskcase], there exists a connected H  ⊆  G with [formula] such that w0(H)  ≤  s(|B| - 2). Note that |h|  ≤  |B| - 2 for every face h of H. Since S is (|B| - 2)-free, we have

[formula]

where we only write the non-strict inequality since h may belong to S. Therefore,

[formula]

which is a contradiction.

We will need the following consequence. If G is a graph embedded in Σ and Λ is an open disk whose boundary is contained in G, then let G - Λ be the graph obtained from G by removing all vertices and edges drawn in Λ.

Let G be a triangle-free graph with a 2-cell embedding in a surface Σ, let W be a closed walk in G bounding an open disk Λ  ⊂  Σ, and let S be a set of faces such that [formula]. If S is (|W| - 2)-free, then every 3-coloring of G - Λ extends to a 3-coloring of G.

Let us design an algorithm enabling us to perform this reduction efficiently. We need an observation enabling us to simplify closed walks of a given homotopy. By drilling a hole in a face f of an embedded graph, we mean deleting the interior of an arbitrary closed disk contained in f (so we obtain a new cuff disjoint from the boundary of f).

Let G be a graph with a 2-cell embedding in a surface Σ, let S be a set of faces of G and let Σ' be the surface obtained from Σ by drilling holes in the faces of S. Let Λ  ⊆  Σ be an open disk such that [formula]. Let W be a closed walk in G homotopically equivalent in Σ' to the boundary of Λ, and let HW be the subgraph of G consisting of the vertices and the edges of W. Let T be the set of faces of HW in its embedding in Σ that intersect [formula].

If G (in Σ) contains no connected essential subgraph with at most |W| edges, then each face of T is 2-cell and [formula].

Since G contains no connected essential subgraph with at most |W| edges, we conclude that there exists ΛH  ⊆  Σ containing HW such that ΛH is either an open disk, or an open disk with a hole whose boundary is equal to a cuff C of Σ. In the latter case, let Λ'H be the open disk obtained from ΛH by patching the hole corresponding to C. In the former case, let Λ'H  =  ΛH.

Consider HW as embedded in Λ'H. Let f0 be the face of HW containing the boundary of Λ'H, and if Λ'H  ≠  ΛH, then let f1 be the face of HW containing [formula]. Since HW is connected, all faces of HW except for f0 are 2-cell. Since W is homotopically equivalent to the boundary of Λ, we have [formula]. Consequently, all faces of T are 2-cell. Furthermore, if two faces of T share an edge e, then e appears in W at least twice (since W has the same winding number ±  1 around both of the faces). Therefore, [formula].

We can now design the following subroutine.

For any integer k  ≥  0 and a surface Σ, there exists a linear-time algorithm as follows. Let G be a triangle-free graph with a 2-cell embedding in a surface Σ such that every connected essential subgraph of G has at least k + 1 edges, and let f be a face of G. The algorithm decides whether {f} is k-free, and if not, returns a closed walk W of length at most k that binds {f} with respect to an open disk Λ  ⊆  Σ such that among all such walks, |W| is minimal, and additionally {Λ} is k-free in G - Λ.

Let Σ' be the surface obtained from Σ by drilling a hole inside f, and let Λ' be the open disk removed from Σ in order to create Σ'. Build the data structure of Lemma [\ref=lemma-dataemb] for G with d = k, and find (in linear time) a shortest walk W0 of length at most k such that W0 is homotopically equivalent in Σ' to the boundary of Λ'. If no such walk exists, then {f} is k-free.

Otherwise, let t = |W0|. Let H0 be the subgraph of G consisting of the vertices and edges of G contained in W0, and let Λ0 be the face of H0 containing f. By Lemma [\ref=lemma-simpc], Λ0 is an open disk bounded by a closed walk W'0 of length at most t. By the minimality of |W0|, it follows that |W'0| = t.

We now proceed as follows. Set W = W'0 and Λ  =  Λ0, and remove in the data structure all vertices and edges drawn in Λ so that the data structure now represents G - Λ. We process all remaining vertices not contained in W in order, and for each of them test in constant time whether there exists a closed walk of length t passing through it and homotopically equivalent to the boundary of Λ'. Whenever we find such a walk, we repeat the procedure of the previous paragraph and replace W and Λ by the obtained walk and the open disk bounded by it, and remove the vertices and edges so that the data structure represents G - Λ.

At the end of this procedure, we end up with a closed walk W and an open disk Λ satisfying the conclusions of the lemma (if Λ = f, then {f} is k-free).

Let us remark that in the situation of Lemma [\ref=lemma-testfree1], if {f} is not k-free, then the reduction of Corollary [\ref=cor-surfdisk] applies ({f} is (|W| - 2)-free since |W| is minimal). Another subroutine is used to search for a binding walk around several faces.

For all integers k,b  ≥  0 and a surface Σ, there exists a linear-time algorithm as follows. Let G be a triangle-free graph with a 2-cell embedding in a surface Σ such that every connected essential subgraph of G has at least k + 1 edges, and let S be a set of faces of G such that |S|  ≤  b. The algorithm decides whether S is k-free, and if not, returns a shortest closed walk W that binds S.

Using the algorithm of Lemma [\ref=lemma-testfree1], we test whether single-element subsets of S are k-free, and record the obtained shortest walks binding them (if any).

Now, for every D  ⊆  S such that |D|  ≥  2, let t  ≤  k be the largest integer such that [formula], and proceed as follows. Let Σ' be the surface obtained from Σ by drilling a hole inside each face of D. Let Λ be an open disk in Σ containing [formula]. Build the data structure of Lemma [\ref=lemma-dataemb] for G with d = t, and determine whether there exists a closed walk W0 of length at most t that is homotopically equivalent in Σ' to the boundary of Λ.

Suppose that we found such a walk W0, chosen to be the shortest possible. Let HW0 be the subgraph of G consisting of the vertices and edges of W0 and let T be the set of faces of HW0 intersecting [formula]. By Lemma [\ref=lemma-simpc], we have

[formula]

and either |T| = 1 or the last inequality is strict. Hence, there exists h∈T bounded by a closed walk W such that [formula], and either the inequality is strict, or [formula]. Therefore, W binds S, and we record W.

In the end, we return a shortest recorded walk that binds S (or that S is k-free if no walk was recorded).

Again, if S is not k-free, then the minimality of |W| ensures that in the situation of Lemma [\ref=lemma-testfree2], S is (|W| - 2)-free. We can now describe the reduction algorithm.

For an integer k  ≥  4, a rational number r  ≥  0 and a surface Σ, there exists a linear-time algorithm as follows. Let G be a triangle-free graph with a 2-cell embedding in a surface Σ such that every connected essential subgraph of G has at least k + 1 edges. The algorithm returns G'  ⊆  G whose embedding in Σ induced by the embedding of G is 2-cell such that

every boundary cycle of G belongs to G',

every 3-coloring of G' extends to a 3-coloring of G, and

either w0(G')  ≤  r, or G' contains a k-free set of faces S such that

[formula]

Let b = ⌈r / s(5)⌉ + 1. Note that there exist only finitely many multisets M of integers greater than 4 such that [formula]. Let m0 denote the number of such multisets.

We construct a sequence (G0,S0), (G1,S1), , (Gm,Sm) such that for [formula], Gi is a subgraph of G, Si is a set of faces of Gi, and

the embedding of Gi in Σ is 2-cell and every boundary cycle of G belongs to Gi,

every 3-coloring of Gi extends to a 3-coloring of G,

|Si|  ≤  b, and

for every f∈Si, |f|  ≥  5 and the set {f} is k-free in Gi.

Let G0 be the subgraph of G obtained by applying the algorithm of Lemma [\ref=lemma-elim24] and suppressing all faces of length two, and let [formula]. Assuming we already constructed (Gi,Si) for some i  ≥  0, we proceed as follows.

We apply the algorithm of Lemma [\ref=lemma-testfree2] to test whether Si is k-free in Gi. If not, let W0 be the closed walk returned by the algorithm that binds Si with respect to an open disk Λ0  ⊂  Σ. By Corollary [\ref=cor-surfdisk], every 3-coloring of Gi  -  Λ0 extends to a 3-coloring of Gi, and thus also to a 3-coloring of G. Apply the algorithm of Lemma [\ref=lemma-testfree1] to Gi  -  Λ0 and its face Λ0, and let W be the closed walk returned by the algorithm that binds {Λ0} with respect to an open disk Λ  ⊂  Σ, or set W = W0 and Λ  =  Λ0 when {Λ0} already is k-free. Let Gi + 1 = Gi  -  Λ and let Si + 1 be obtained from Si by removing the faces contained in Λ and by adding Λ. Note that by Corollary [\ref=cor-surfdisk], every 3-coloring of Gi + 1 extends to a 3-coloring of Gi  -  Λ0, and thus also to a 3-coloring of G. Furthermore, |Si + 1|  ≤  |Si|  ≤  b.

Hence, assume that Si is k-free in Gi. If either [formula] or Si contains all faces of Gi of length at least 5, then we set m = i and end the procedure. Otherwise, note that |Si|  ≤  r / s(5)  ≤  b - 1, and let [formula] be a face of Gi of length at least 5. Let Λ  ⊂  Σ be an open disk found using Lemma [\ref=lemma-testfree1] applied for f such that f  ⊆  Λ and Λ is k-free in Gi  -  Λ. By the choice of G0, the boundary walk of Λ has length at least 5. Let Gi + 1 = Gi  -  Λ and let Si + 1 be obtained from Si by removing the faces contained in Λ and by adding Λ. Note that by Corollary [\ref=cor-surfdisk], every 3-coloring of Gi + 1 extends to a 3-coloring of Gi, and thus also to a 3-coloring of G.

This finishes the description of the construction of the sequence G0, G1, , Gm. Let us now give a bound on the length of the sequence. For i  ≥  0, let Mi denote the sequence of the lengths of faces in Si in the non-increasing order. Observe that in order to obtain Si + 1, some subset X of faces in Si is replaced by another face Λ, and every face in X is strictly shorter than Λ by the assumption that {f} is k-free in Gi for every f∈Si. Hence, Mi + 1 is lexicographically strictly larger than Mi. Consequently, Mi  ≠  Mj for every i  ≠  j, and thus there exist at most m0 values of i such that [formula]. Furthermore, observe that if Si is not k-free, then |Si + 1| < |Si|, and thus there do not exist b consecutive values of i such that Si is not k-free. We conclude that the described algorithm terminates after m  ≤  b(m0 + 1) steps, which is a constant depending only on r.

By the construction, either Sm is k-free in Gm and [formula], or w0(Gm)  ≤  r. Therefore, we can set G' = Gm.

As a corollary, we obtain the special case of Theorem [\ref=thm-mainalg] when Σ is the disk.

For every integer n, there exists a linear-time algorithm with input

G: a triangle-free graph embedded in the disk Δ with the boundary cycle B of length at most n, and

ψ: a 3-coloring of B,

which either correctly decides that there exists a 3-coloring φ of G extending ψ, or returns a subgraph G'  ⊆  G such that B  ⊆  G', wη(G')  ≤  s(|B| - 2) and ψ does not extend to a 3-coloring of G'.

Let G' be the subgraph of G obtained by applying the algorithm of Lemma [\ref=lemma-liberate] with k = |B| - 2 and r = s(|B| - 2). Note that ψ extends to a 3-coloring of G if and only if it extends to a 3-coloring of G'. If w0(G')  ≤  r = s(|B| - 2), then we can decide whether ψ extends to a 3-coloring of G' using the algorithm of Theorem [\ref=thm-quadalg], by testing all the possible colorings of the vertices incident with faces of G' of length greater than 4 (there are at most 5s(|B| - 2) / s(5) such vertices). Otherwise, G' contains a (|B| - 2)-free set of total weight greater than s(|B| - 2), and Lemma [\ref=lemma-disk] implies that ψ extends to a 3-coloring of G'.

Linear-time decision algorithm

The algorithm for general surfaces is now only mildly more complicated. Let us prepare by giving its special case where the graph has no non-contractible 4-cycles or small connected essential subgraphs.

For every surface Σ and integer k, there exists a linear-time algorithm with input

G: a triangle-free graph 2-cell embedded in Σ with boundary cycles B, without non-contractible 4-cycles, and without connected essential subgraphs with at most wη(B) edges, such that |V(B)|  ≤  k, and

ψ: a 3-coloring of B,

which either correctly decides that there exists a 3-coloring φ of G extending ψ, or returns a subgraph G'  ⊆  G such that B  ⊆  G', wη(G')  ≤  wη(B) and ψ does not extend to a 3-coloring of G.

We proceed by induction on the number of cuffs of Σ; hence, we can assume that the algorithm exists for all surfaces obtained from Σ by patching at least one cuff. Firstly, for each cuff C of Σ, run the algorithm for the embedding of G in the surface obtained from Σ by patching C and for the restriction of ψ to B - V(C). Suppose that the coloring does not extend, and thus we obtain a subgraph G''  ⊆  G with wη(G'')  ≤  wη(B - V(C)) such that the restriction of ψ to B - V(C) does not extend to a 3-coloring of G''. Then, it suffices to set [formula] and observe that wη(G')  ≤  wη(B) and that ψ does not extend to a 3-coloring of G.

Hence, we can assume that for every cuff C, the restriction of ψ to B - V(C) extends to a 3-coloring of G. Consequently, if H  ⊇  B is a subgraph of G such that ψ does not extend to a 3-coloring of H, then H is connected.

Now, apply the algorithm of Lemma [\ref=lemma-liberate] with k = r = wη(B), and let G' be the resulting subgraph. Let us first consider the case that w0(G')  ≤  r. We can decide whether ψ extends to a 3-coloring of G' using the algorithm of Theorem [\ref=thm-quadalg], by testing all the possible colorings of the vertices incident with faces of G' of length greater than 4 (there are at most 5wη(B) / s(5) such vertices). If it does, then ψ also extends to a 3-coloring of G. If ψ does not extend to a 3-coloring of G', then G' is the subgraph as required in the conclusion of the theorem.

Next, consider the case that G' contains a k-free set S of faces of total weight greater than wη(B). Let H be the subgraph of G as in Theorem [\ref=thm-almstruct]. Since wη(H)  ≤  wη(B) = k, every face h of H has length at most k. If the embedding of H is 2-cell, then [formula] since S is k-free. However, that would imply [formula], which contradicts the choice of S.

Therefore, H contains a face that is not 2-cell. Since all faces of H have length at most k and H does not contain any connected essential subgraph with at most k edges, it follows that H is not connected. However, as we ensured before, this implies that ψ extends to a 3-coloring of H, and consequently to a 3-coloring of G' and of G.

Easily, we can allow the boundary cycles to have length 4 by a minor modification to the algorithm of Theorem [\ref=thm-mainalg-spec]: before running the algorithm, subdivide an edge in each cuff of length 4 by a vertex and extend ψ by giving the new vertex a color distinct from the colors of its neighbors.

For every surface Σ and integer k, there exists an integer NΣ,k and a linear-time algorithm with input

G: a triangle-free graph 2-cell embedded in Σ, without non-contractible 4-cycles other than the boundary cycles, and without connected essential subgraphs with at most NΣ,k edges, such that the union B of the boundary cycles of G has at most k vertices, and

ψ: a 3-coloring of B,

which correctly decides whether there exists a 3-coloring φ of G extending ψ.

Next, let us deal with other non-contractible 4-cycles.

For every surface Σ and integer k, letting NΣ,k be as in Corollary [\ref=cor-mainalg-spec], there exists a linear-time algorithm with input

G: a triangle-free graph 2-cell embedded in Σ without connected essential subgraphs with at most NΣ,k + 8 edges, such that the union B of the boundary cycles of G has at most k vertices, and

ψ: a 3-coloring of B,

which correctly decides whether there exists a 3-coloring φ of G extending ψ. Furthermore, if Σ is the cylinder (the sphere with two holes), then we can omit the restriction on the connected essential subgraphs.

By Corollary [\ref=cor-mainalg-disk], we can assume that either Σ has non-zero genus or at least two cuffs.

Suppose first that Σ is the cylinder. Apply the algorithm of Lemma [\ref=lemma-splitcyl] with d = k, and let C0, C1, , Cm be the resulting cycles. For [formula], we can decide which 3-colorings of [formula] extend to the subgraph Gi of G drawn between [formula], as follows. If the distance between Ci - 1 and Ci is at most NΣ,2k, then let P be a shortest path between Ci - 1 and Ci. Using Corollary [\ref=cor-mainalg-disk] for the subgraph(s) of G contained in the 2-cell face(s) of [formula], we can decide which 3-colorings of [formula] extend to a 3-coloring of Gi, and thus also which 3-colorings of [formula] extend to a 3-coloring of Gi. If the distance between Ci - 1 and Ci is greater than NΣ,2k, then since Σ is a cylinder, we conclude that Gi does not contain any connected essential subgraph with at most NΣ,2k vertices, and thus which 3-colorings of [formula] extend to Gi can be decided using the algorithm of Corollary [\ref=cor-mainalg-spec].

Finally, we can combine the information by straightforward dynamic programming to determine whether ψ extends to a 3-coloring of G.

Hence, we can assume that Σ is not the cylinder. For each cuff C of Σ, let ΣC be the surface obtained from Σ by patching C, and let fC be the face of G bounded by C in its embedding in ΣC. Let WC be the closed walk obtained by applying the algorithm of Lemma [\ref=lemma-testfree1] to {fC} with k = 4, and let ΛC be the open disk bounded by WC. Note that for any distinct cuffs C1 and C2, the closures of ΛC1 and ΛC2 are disjoint, since every connected essential subgraph of G has more than 8 edges, and since Σ is not the cylinder.

Let C1, , Ct be the cuffs of Σ, let [formula] and let G' be the subgraph of G embedded in Σ'. Note that Σ' is homeomorphic to Σ, that G' does not contain any non-contractible 4-cycles other than the boundary cycles, and that G' does not contain any connected essential subgraphs with at most NΣ,k edges. By Corollary [\ref=cor-mainalg-spec], we can decide which 3-colorings of the boundary cycles [formula] of G' extend to a 3-coloring of G'. For [formula], we can decide which 3-colorings of [formula] extend to the subgraph of G drawn between Ci and Wi, by the cylinder case when Wi and Ci are vertex-disjoint, and by Corollary [\ref=cor-mainalg-disk] otherwise. By combining this information, we can decide whether ψ extends to a 3-coloring of G.

To give the full algorithm, it now suffices to deal with the essential subgraphs.

Without loss of generality, we can assume that the embedding of G in Σ is 2-cell.

Let ν(Π,t) = NΠ,t for every surface Π and integer t, where NΠ,t is as in Corollary [\ref=cor-mainalg-spec]. Apply the algorithm of Lemma [\ref=lemma-qstruc] to G, obtaining a subgraph H of G. For every face h of H, determine which 3-colorings of the boundary of h extend to a 3-coloring of Gh by applying the algorithm of Theorem [\ref=thm-mainalg-spec4]. By combining this information, we can determine which 3-colorings of H extend to a 3-coloring of G, and thus also whether ψ extends to a 3-coloring of G.

Finding a 3-coloring

Note that the argument of Lemma [\ref=lemma-disk] gives no way to find the 3-coloring that it proves to exist. Hence, to get such a 3-coloring, we need to delve deeper into the proof of Theorem [\ref=thm:ctvrty].

The basic case we need to consider is that of graphs of girth at least 5. Note that in this case for every face h, [formula], and thus [formula] for every graph H of girth at least 5 embedded in a surface. In particular, the size of the subgraph H in Theorem [\ref=thm-almstruct] becomes bounded by a constant dependent only on Σ and the lengths of the boundary cycles.

Let Σ be a surface and let G be embedded in Σ so that every (  ≤   4)-cycle is one of the boundary cycles of G. Let B be the union of the boundary cycles of G. We say that G is near-planar if there exists a cuff C of Σ and an open subset Λ of Σ equal to an open disk with a hole bounded by C such that G consists of a component contained in Λ (which we call the main component of G) and of boundary cycles. For a near-planar graph G, let m(G) denote the maximum size of the face of the main component of G in its embedding in Λ. We say that a near-planar graph G is very exceptional if either there exists an edge e with both ends in C such that C + e in its embedding in Λ has a 2-cell face of length at most 6, or there exists a vertex v with neighbors v1,v2,v3∈V(C) such that C + {vv1,vv2,vv3} in its embedding in Λ has two 2-cell faces of length 5. We need the following bound on the size of critical graphs of girth 5 in the disk, see Theorem 8.5 of [\cite=trfree2].

There exists a constant α as follows. Let G be a graph of girth at least 5 embedded in the disk with boundary cycle B. Suppose that G does not contain a very exceptional subgraph. If some 3-coloring ψ of B does not extend to a 3-coloring of G, then there exists a subgraph H  ⊆  G such that B  ⊂  H, ψ does not extend to a 3-coloring of H, |V(H)|  ≤  α|B| and every face of H has length at most |B| - 5.

In particular, if |B|  ≤  9 this implies that every 3-coloring of B extends to a 3-coloring of G. This was proved before by Thomassen [\cite=thom-torus], and closer analysis of his argument gives a quadratic algorithm to find such a 3-coloring of G.

There exists a quadratic-time algorithm with input

G: a graph of girth at least 5 embedded in the disk with boundary cycle B of length at most 9, such that B is an induced cycle and no vertex of G has more than two neighbors in B, and

ψ: a 3-coloring of B,

which outputs a 3-coloring φ of G such that φ(v) = ψ(v) for every v∈V(B).

Let G be a graph embedded in a surface without contractible cycles of length less than 5, and let C be a contractible cycle in G bounding an open disk Λ. We say that C is clearable if |C|  ≤  9 and the subgraph of G drawn in the closed disk bounded by C does not contain a very exceptional subgraph.

The arguments proving all the mentioned results are based on the method of reducible configurations. Let G be a triangle-free graph 2-cell embedded in a surface Σ. Suppose that every 4-cycle of G is contained in the union B of the boundary cycles of G, and let ψ be a 3-coloring of B. By a reducible configuration in G we mean a connected subgraph F of G of bounded size, such that there exists a graph G' (which we call the reduction with respect to ψ) satisfying the following conditions.

G' is a graph obtained from G by possibly adding non-crossing edges between vertices of F into some faces of G, by contracting some edges between vertices of F in the resulting graph, and by removing some vertices of F (thus, G' is a minor of a graph embedded in Σ, and thus it is also embedded in Σ).

B is a subgraph of G' (i.e., no two vertices of B were identified in the reduction, and no vertex or edge of B was removed).

Every 3-coloring of G' whose restriction to B is equal to ψ can be extended to a 3-coloring of G with the same restriction to B, in constant time.

G' is triangle-free, and every 4-cycle of G' is contained in B.

We say that a subgraph of G' touches F if it contains either a vertex created by contractions during the reduction of F, or an edge added during the reduction of F.

Suppose F  ⊆  G is one of the following:

a vertex of degree at most 2 not contained in B, or

an even cycle of vertices of degree three that is vertex-disjoint from B, or

an odd cycle C of vertices of degree three that is vertex-disjoint from B and two adjacent vertices [formula], such that each of them has a neighbor in C.

In the first two cases, the reduction G' is equal to G - V(F). In the last case, G' = G - V(C). It is easy to check that every 3-coloring of G' extends to a 3-coloring of G.

The key result of [\cite=trfree2] was showing the existence of reducible configurations in large enough graphs of girth 5. The following is a reformulation of Lemmas 5.10, 6.1, 6.2, 7.1 and 7.3 of [\cite=trfree2].

For every surface Σ and an integer k, there exists a constant RΣ,k and a linear-time algorithm whose input is a triangle-free graph G with closed 2-cell embedding in a surface Σ such that

the union B of the boundary cycles of G has at most k vertices and |V(G)|  ≥  RΣ,k,

every 4-cycle and every non-contractible cycle of length at most 7 is contained in B,

every connected essential subgraph of G has at least 5 edges,

if a path P of length at most 4 has both ends in a boundary cycle K, then the distance between the ends of P in K is at most |P|, and

no two vertices of degree two of G contained in B are adjacent,

and a 3-coloring ψ of B. The algorithm outputs either a clearable cycle in G, or a reducible configuration F with at most 17 vertices and the corresponding reduction G' with respect to ψ.

In the latter case, the reduction G' has the following property. Suppose that we are given a near-planar subgraph H' of G' such that B  ⊆  H', the main component of H' is 2-connected, only the main component of H' touches F, and every vertex of H' not belonging to B has degree at least three. Then,

we can in linear time construct a near-planar subgraph H of G such that B  ⊆  H, |V(H)|  ≤  |V(H')| + 10 and m(H)  ≤  m(H') + 5, and

H' is not very exceptional.

Note that in this proof, we extensively refer to the concepts defined in [\cite=trfree2]; we do not restate their definitions here, as the proof can only be understood in the context of [\cite=trfree2] anyway.

In order to use the results [\cite=trfree2], we need to consider conditions (I0), , (I9) for G. Note that (d) together with (b) and (c) implies that every vertex of [formula] has at most one neighbor in B, that the boundary cycles are induced, and that the distance between any two boundary cycles is at least 5, which implies (I4) and (I7).

If G did not satisfy (I0), (I1), or (I2), it would contain one of the reducible configurations described in Example [\ref=ex-redu], and these reducible configurations trivially satisfy the conclusion of Theorem [\ref=thm-redconf] (with H = H', which is not very exceptional by (I4)). Note that conditions (I1) and (I2) do not specify an upper bound on the lengths of the cycles, but the inspection of their usage shows that they are only needed for cycles of length at most 9. In particular, the presence of these configurations can be tested in linear time, since any graph contains at most a linear number of (  ≤   9) cycles consisting of vertices of degree three.

Condition (I3) is implied by the assumption that the embedding of G is closed 2-cell and by (b). Condition (I5) is implied by (I0) and (e). Condition (I6) is implied by the assumption that the embedding of G is closed 2-cell. Condition (I8) is implied by (b). Finally, if condition (I9) is not satisfied, then G contains a clearable cycle, which can be detected in linear time using the ideas of [\cite=trfree6].

Hence, we can assume that G satisfies conditions (I0)-(I9). Together with (c) and (d), this implies that G is well-behaved.

Let M = B, let g be the genus of Σ, let c be the number of cuffs of Σ, and let RΣ,k = 8g  +  8c  +  9|E(B)|. By [\cite=trfree2] and (a), a configuration isomorphic to one of R1, , R7 appears in G and does not touch (in the sense of [\cite=trfree2]) M = B. By [\cite=trfree2] and (a), a good configuration γ strongly appears in G. We can find such a configuration (in fact, all of them) in linear time, because every good configuration has a connected subgraph with at most 12 vertices, each of them of degree at most four in G, such that every vertex of the configuration has a neighbor in the subgraph.

Let G' be the γ-reduction of G with respect to ψ. By [\cite=trfree2], G' is triangle-free and every 4-cycle of G' is contained in B, and thus γ forms a reducible configuration (with at most 17 vertices involved in the reduction, giving the bound on the size of F). Let H' be a near-planar subgraph H' of G' such that B  ⊆  H', the main component of H' is 2-connected, only the main component of H' touches F, and every vertex of H' not belonging to B has degree at least three. By [\cite=trfree2], H' is not very exceptional.

At the beginning of Section 7 of [\cite=trfree2], we assign to each face f'' of H' (playing the role of G'' in that section) a subgraph Jf'' of G. Let H be the subgraph of G equal to the union of such subgraphs Jf'' over all faces f'' of H'; clearly, this subgraph can be constructed in linear time. By [\cite=trfree2], we have |V(H)|  ≤  |V(H')| + 10 and m(H)  ≤  m(H') + 5 as required.

Let us now give the algorithm for graphs of girth 5. For a graph G embedded in a surface with boundary cycles C1, , Ct, let [formula].

For every surface Σ and an integer k  ≥  0, there exists a quadratic-time algorithm whose input is a triangle-free graph G with closed 2-cell embedding in Σ such that q(G)  ≤  k and every 4-cycle of G is a boundary cycle, and a 3-coloring ψ of the union B of the boundary cycles of G, and the algorithm decides whether ψ extends to a 3-coloring of G and returns such a 3-coloring if that is the case.

We proceed by induction on the complexity of the surface; that is, we assume that such an algorithm exists for all surfaces with smaller genus than Σ, and for the surfaces with the same genus and with fewer cuffs.

Using the algorithm of Theorem [\ref=thm-mainalg], we can decide whether ψ extends to a 3-coloring of G. Hence, we can assume that this is the case, and we only need to construct a 3-coloring φ of G that extends ψ. If |V(G)| < RΣ,k, then we can find φ in constant time by brute force; hence, assume that |V(G)|  ≥  RΣ,k.

For a surface Π and integer m, let [formula] (thus, ν is a constant function). We apply the algorithm of Lemma [\ref=lemma-qstruc] to G; let H be the resulting subgraph of G. Suppose that H  ≠  B. Then note that for every face h of H, the surface Σh is at most as complex as Σ. Furthermore, Gh has strictly fewer faces than G, thus ensuring that the recursion eventually terminates. We use the algorithm of Theorem [\ref=thm-mainalg] to find a 3-coloring ψ' of H such that ψ' extends to a 3-coloring of G, and the restriction of ψ' to B is equal to ψ'. By recursive calls to the algorithm we are designing, we find an extension of ψ' to a 3-coloring of Gh for every face h of H, and thus obtain a 3-coloring of G that extends ψ.

Hence, we can assume that H = B, and thus G does not contain any connected essential subgraph with fewer than ν(Σh,|V(B)|) edges. In particular, if a path P of length at most 4 has both ends in B, then both ends of P belong to the same boundary cycle C. If the distance between the ends of P in C is more than |P|, we proceed as in the previous paragraph, with H = B + P. Hence, assume that for any such path P, the distance between the ends of P in C is at most |P|. Similarly, if G contains a non-contractible cycle K of length at most 7 distinct from the boundary cycles (such a cycle can be found in linear time using the data structure of Lemma [\ref=lemma-dataemb]), then K surrounds a cuff, and we can proceed as in the previous paragraph, with H = B + K. Hence, assume that no such cycle exists.

Suppose that B contains two adjacent vertices v1 and v2 whose degree in G is two. Let C be the boundary cycle containing the edge v1v2. Since the embedding of G is closed 2-cell, C is not a triangle. If Σ is the disk and |C|  ≤  5, then we can find a 3-coloring of G that extends ψ by the algorithm of Theorem [\ref=thm-diskle9]. If either Σ is not the disk or |C|  ≥  6, then using the observations of the previous paragraph, we conclude that the edge v1v2 is not contained in any (  ≤   5)-cycle distinct from C. Let G' be the graph obtained from G by contracting the edge v1v2. Let B' be the boundary cycle of G' and let ψ' be a 3-coloring of B' that matches ψ on [formula]. By a recursive call, we obtain a 3-coloring of G' that extends ψ', and this gives a 3-coloring of G that extends ψ. Hence, assume that B does not contain adjacent vertices whose degree in G is two.

It follows that G satisfies the assumptions of Theorem [\ref=thm-redconf]. Let us run the algorithm of Theorem [\ref=thm-redconf] for G and ψ. Suppose that the algorithm returns a clearable cycle C, bounding an open disk Λ. By a recursive call, we obtain a 3-coloring φ1 of G - Λ that extends ψ. Using algorithm of Theorem [\ref=thm-diskle9], we find a 3-coloring of GΛ that extends the restriction of φ1 to C. By combining these colorings, we obtain a 3-coloring of G that extends ψ.

Finally, suppose that the algorithm returns a reducible configuration F and a reduction G'. By the algorithm of Theorem [\ref=thm-mainalg-spec] (subdividing the edges in boundary 4-cycles as necessary to accommodate its assumptions), we test whether ψ extends to a 3-coloring of G'. If it does, then by a recursive call we obtain a 3-coloring of G' that extends ψ, and by the properties of reducible configurations, we transform it in constant time in a 3-coloring of G that extends ψ.

Hence, suppose that ψ does not extend to a 3-coloring of G'. In this case, the algorithm of Theorem [\ref=thm-mainalg-spec] also returns a subgraph H' of G' such that B  ⊆  H', ψ does not extend to a 3-coloring of H', and wη(H')  ≤  wη(B). Since H' is triangle-free and all 4-cycles in H' are contained in B, this implies that [formula]. It follows that every connected component of H' is non-essential. By repeatedly deleting vertices and edges x of H' not belonging to B such that ψ does not extend to a 3-coloring of H' - x, we can assume that ψ extends to a 3-coloring of every proper subgraph of H' that contains B. Since every planar graph of girth at least 5 is 3-colorable, no component of H' is contained in an open disk in Σ. Hence, for each cuff C of Σ, there exists a subset ΛC of Σ that is an open disk with a hole whose boundary is equal to C, such that for distinct cuffs C and C', we have [formula], ΛC contains a single component H'C of H', and each component of H' is contained in one of these sets.

Since |E(H')| < ν(Σ,k) - |F| and F is connected, and since no connected essential subgraph of G has fewer than ν(Σ,k) edges, it follows that at most one component H'C of H' touches F. Since ψ extends to a 3-coloring of G, it also extends to a 3-coloring of every component of H' which forms a subgraph of G. Since ψ extends to a 3-coloring of every proper subgraph of H' that contains B, but does not extend to a 3-coloring of H', we conclude that [formula], and thus H' is near-planar. Also, H' is 2-connected, as otherwise, H'C contains a 1-cut, and removing the component of the 1-cut that does not contain C from H' results in a proper subgraph that has no 3-coloring extending ψ, which contradicts the choice of H'. The last conclusion of Theorem [\ref=thm-redconf] implies that H' is not very exceptional, and by Theorem [\ref=thm-diskcase5], it follows that every face of H'C in its embedding in ΛC has length at most |C| - 5.

Let H be the subgraph of G with B  ⊆  G obtained by the next-to-last conclusion of Theorem [\ref=thm-redconf]. Note that every face of the main component of H has length at most |C|. Using the algorithm of Theorem [\ref=thm-mainalg], we determine a 3-coloring ψ' of H that extends to a 3-coloring of G and whose restriction to B is equal to ψ. For every face h of H, we determine a 3-coloring of Gh that extends ψ' by a recursive call. By combining these colorings, we obtain a 3-coloring of G that extends ψ.

To analyze the time complexity of the algorithm, note that in each case, we spend a linear time processing G, and we recurse on several graphs G1, , Gk, such that the sum of the numbers of faces of G1, , Gk is at most the number of the faces of G. Since the number of faces of G is linear in the number of its vertices, this implies that the time complexity of the algorithm is quadratic.

Finally, let us deal with 4-cycles.

Again, we construct the algorithm by induction on the complexity of the surface. Firstly, we use the algorithm of Theorem [\ref=thm-mainalg] to determine whether ψ extends to a 3-coloring of G. If it does not, we output this answer and end. Hence, suppose that ψ extends to a 3-coloring of G.

In linear time, we decide whether G contains a non-contractible (  ≤   5)-cycle K distinct from the boundary cycles. If that is the case, we let [formula] and we use the algorithm of Theorem [\ref=thm-mainalg] to find a 3-coloring ψ' of H that extends to a 3-coloring of G and whose restriction to B is equal to ψ. For every face h of H, we determine a 3-coloring of Gh that extends ψ' by a recursive call. By combining these colorings, we obtain a 3-coloring of G that extends ψ. Hence, assume that G contains no non-contractible (  ≤   5)-cycle. Similarly, we can assume that every boundary cycle is induced, and that the distance between any two boundary cycles is at least three.

Next, in linear time we decide whether G contains a contractible (  ≤   5)-cycle K that does not bound a face. If such a cycle K exists, then let Λ be the open disk bounded by K. We first extend ψ to a 3-coloring of G - Λ by a recursive call, and then extend the coloring to GΛ using the algorithm of Theorem [\ref=thm-ext45]. Hence, assume that every contractible (  ≤   5)-cycle in G bounds a face. Similarly, we can assume that every vertex of G of degree at most two belongs to B. Furthermore, using the ideas of this and the previous paragraph, we can assume that the embedding of G is closed 2-cell.

If G does not contain any 4-face, then we apply the algorithm of Lemma [\ref=lemma-colorgirth5]. Hence, let f = v1v2v3v4 be a 4-face in G. Since the boundary cycles of G are induced and the distance between them is at least three, we can assume that [formula]. Suppose that v1,v3∈V(B). Then both v1 and v3 belong to the same boundary cycle C, and since G is triangle-free, the distance between v1 and v3 in C is at least two. Hence, if h is a face of H = B + v1v2v3, then either Σh is strictly less complex than h, or Σh is homeomorphic to Σ and all the boundary cycles of Gh are at most as long as the corresponding boundary cycles of G. We use the algorithm of Theorem [\ref=thm-mainalg] to find a 3-coloring ψ' of H that extends to a 3-coloring of G and whose restriction to B is equal to ψ, and extend ψ' to a 3-coloring of G by recursive calls on the graphs Gh for all faces h of H.

Finally, suppose that that [formula]. By symmetry, we can assume that [formula]. Using Theorem [\ref=thm-mainalg], we find a 3-coloring ψ' of B + v1v2v3v4 that extends to a 3-coloring of G and whose restriction to B is equal to ψ. Note that either ψ'(v1) = ψ'(v3) or ψ'(v2) = ψ'(v4). By symmetry, we can assume the former. Suppose that G contains a path P of length at most 3 joining v1 with v3 and disjoint from {v2,v4}, and let K be the cycle P + v1v2v3. Since |K|  ≤  5 and K is distinct from the boundary cycles, it follows that K is contractible, and thus K bounds a face. However, then v2 has degree two, which is a contradiction. Therefore, there exists no such path, and thus the graph G' obtained from G by identifying v1 with v3 is triangle-free. Furthermore, since ψ' extends to a 3-coloring of G, it follows that ψ extends to a 3-coloring of G'. We can find such a 3-coloring of G' by a recursive call, and extend it to G by giving v1 and v3 the color of the corresponding vertex of G'.

To analyze the time complexity of the algorithm, note that in each case, we either call the quadratic algorithm of Lemma [\ref=lemma-colorgirth5], or we spend a linear time processing G and recurse on several graphs G1, , Gk, such that the sum of the numbers of faces of G1, , Gk is at most the number of the faces of G. Since the number of faces of G is linear in the number of its vertices, this implies that the time complexity of the algorithm is quadratic.