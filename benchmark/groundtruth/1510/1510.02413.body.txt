Learning Data-driven Reflectance Priors for Intrinsic Image Decomposition

Introduction

The human visual system is remarkable in its ability to decompose the jumbled mess of confounds that is our visual world into simpler underlying factors. Nowhere is this more apparent than in our impressive ability, even from a single still image, to tease apart the effects of surface reflectance vs. scene illumination. Consider the mini-sofa in Figure [\ref=fig:teaser](a): on one hand, we can see that its seat (point X) is much brighter than its frontal face (point Y), but at the same time, we can also clearly tell that they are both "made of the same stuff" and have the same surface reflectance. This is remarkable because, by the time the light has bounced off the sofa toward the eye (or the camera), the contributions of reflectance and illumination have been hopelessly entangled, which the brain then needs to undo.

In computer vision, the decomposition of an image into reflectance (albedo) and illumination (shading) maps is usually, if somewhat inaccurately, referred to as the intrinsic image decomposition [\cite=bt78]. The intrinsic image model states that the observed luminance image is the product of the reflectance image times the shading image. Clearly, the inverse problem of inferring the underlying reflectance and shading images is ill-posed and under-constrained in this pure form since any given pixel intensity could be explained equally well by reflectance or shading [\cite=adelson96]. To address this, additional constraints (priors) are typically imposed on the decomposition process to capture the statistical and/or physical regularities in natural images. However, those priors are typically hand-crafted and overly weak. For example, one popular prior proposed originally in the Retinex algorithm of Land and McCann [\cite=retinex] assumes that large intensity gradients correspond to reflectance edges, while low-frequency changes are mainly due to shading. While this prior works well in many cases, it fails in the presence of strong shadows, sharp changes in surface orientation, and smoothly-varying planar textures. Since then, many other clever priors have been proposed, including texture statistics [\cite=oh01] [\cite=liu12], shape, albedo, and illumination [\cite=barron12a] [\cite=barron12b] [\cite=barron13], meso- and macro-scales of shading [\cite=liao13], chromaticity segmentation [\cite=garces12], sparsity on reflectances [\cite=omer04] [\cite=gehler11], etc., or combination thereof [\cite=bbs-iiw-14], in the hopes of finding the silver bullet which could fully explain the intrinsic image phenomenon, but to date none has emerged. One is faced with the possibility that there might not exist a simple, analytic prior and that a more data-driven approach is warranted.

In this paper we propose to learn priors for intrinsic image decomposition directly from data. Compared to other work that trains a reflectance vs. shading classifier on image patches (e.g. [\cite=tappen05] [\cite=tappen06]), our main contribution is to train a relative reflectance prior on pairs of patches. Intuitively, the goal is to learn to detect surface regions with similar reflectance, even when their intensities are different. We take advantage of the recently released Intrinsic Images in the Wild (IIW) database of Bell  [\cite=bbs-iiw-14], in which a large set of relative reflectance judgments are collected from human subjects for a variety of real-world scenes. Other contemporary work, developed independently, have also employed the IIW dataset. Narihira  [\cite=takuya-cvpr15] use the IIW dataset to learn a perceptual lightness model. The key difference is that we not only learn a relative reflectance prior from pairwise annotations, but also utilize it for intrinsic image decomposition. In these same proceedings, Zoran  [\cite=zoran15] use a similar approach to ours to estimate ordinal relationships between pairs of points, but globalizes them with a different energy optimization.

Our relative reflectance model is an end-to-end trained convolutional neural network that predicts a probability distribution over the relative reflectance ('brighter', 'darker', 'same') between two query pixels. We show how to naturally integrate this learned prior into existing energy minimization frameworks for intrinsic image decomposition, and demonstrate the benefits of such relative reflectance priors, especially for scenes under challenging illumination conditions.

Learning a model of reflectance

Let ri∈R be a reflectance estimate at pixel i, where R is the set of all reflectance values in a scene. For two reflectance values ri,rj∈R let ri < rj denote that reflectance ri is darker than reflectance rj, and ri = rj means that the reflectances are roughly equivalent.

Estimating reflectance directly is hard and usually requires a specialized sensor, such as a photometer. Not even the human visual system can infer absolute reflectance reliably (see Adelson [\cite=ted] for examples). Humans are much better at estimating relative reflectance between two point ri and rj in a scene [\cite=bbs-iiw-14]. We follow this intuition and learn a classifier that predicts this relative reflectance between different parts of a scene in Section [\ref=sec:rel_light]. However, just like human reflectance estimates, this classifier might not be globally consistent. Section [\ref=sec:abs_light] recovers the globally consistent reflectance estimate following our relative estimates. We then use this global reflectance model in Section [\ref=sec:decomp] to guide an intrinsic image decomposition.

Relative reflectance classifier

For two pixels i and j in a scene, our goal is to estimate the relative reflectance between them as being equal ri  =  rj, darker ri  <  rj or brighter ri  >  rj. Our relative reflectance classifier is a multi-stream convolutional neural network (see Fig. [\ref=fig:net]), accounting for 1) local features around pixel i, 2) local features around pixel j, 3) global scene features of the input image, and 4) spatial coordinates of both input pixels, respectively. The network weights are shared between the two local feature extraction streams. All features are then concatenated, and fed through three fully-connected layers that predict classification scores over the relative reflectance labels ('same', 'darker', 'brighter'). Each convolution and fully-connected layer (except for the last prediction layer) is followed by a rectified linear unit.

We train this network from scratch using the pairwise human judgments of the Intrinsic Images in the Wild dataset [\cite=bbs-iiw-14] and millions more obtained through symmetry and transitivity properties of the original annotations (see Section [\ref=sec:dataaug] for details on data augmentation). The network is learned end-to-end in Caffe [\cite=jsdkl-caffe-14] using a softmax loss. Our network outperforms all state-of-the-art methods in terms of relative reflectance predictions, as we will show in Section [\ref=sec:results]. However the resulting predictions are not always globally consistent. This is in part due to inconsistencies in the human-annotated training data. Roughly 7.5% of all training annotations are inconsistently labeled [\cite=bbs-iiw-14] and our network learns part of that inconsistency.

Next, we show how to recover a globally consistent reflectance estimate from the noisy pairwise predictions produced by the classifier.

Globally consistent reflectance estimate

The network output gives an estimate for the relative reflectance between a pair of pixels i and j. Let w= ,i,j, w< ,i,j and w> ,i,j be the classifier score of 'same', 'darker', and 'brighter', respectively. A higher score enforces a larger consistency for a specific pairwise comparison. We constrain all weights to be non-negative, and formulate global reflectance estimation as a constrained optimization problem, where each classifier output imposes a pairwise constraint on the global ordering

[formula]

Here, ξ is a slack variable that tries to enforce all constraints as well as possible. All pairwise reflectance measures are evaluated on a set of sparse edges E.

This constrained optimization naturally translates into a global energy minimization:

[formula]

where μ<, μ>, and μ= penalizes the disagreement between our classifier and the globally consistent ranking.

For objective Eq. [\ref=eq:emin] this translates into a hinge loss, that penalizes the degree to which the consistent reflectance estimate disagrees with our classifier:

[formula]

For continuous values ri the energy minimization [\ref=eq:energy_sparse] is convex. For discrete values ri it can be expressed as a binary submodular problem on an extended sparsely connected graph [\cite=kvt-imtcm-11]. We use GraphCuts to globally optimize it [\cite=bk-ecmae-04].

While objective [\ref=eq:emin] computes a global ordering on the reflectance, it does not provide information about the absolute reflectance in an image. In the next section we will show how to incorporate the reflectance prior into a standard intrinsic image decomposition pipeline to recover an absolute estimate of reflectance.

Intrinsic image decomposition

We start out with the intrinsic image decomposition framework of Bell  [\cite=bbs-iiw-14]. Given an input image I, their system recovers a reflectance image [formula] and shading image [formula]. They model intrinsic image decomposition as an energy minimization in a fully connected CRF [\cite=kk-eifcc-11].

[formula]

where ψi is a unary term that captures some lightweight unary priors on absolute shading intensity or chromaticity of the reflectance as an L1 norm between the original image and the estimated properties. The unary term also constrains the reflectance and shading to reconstruct the original image. Most of the heavy lifting of the model is done by the pairwise terms ψr and ψs that enforce smoothness of reflectance and lighting respectively.

The pairwise shading term is modeled as a fully connected smoothness prior:

[formula]

where [formula] is the position of a pixel i, and β1 is a parameter controlling the spatial extent of the prior. This prior captures the intuition that the shading varies smoothly over smooth surfaces.

The pairwise reflectance term is modeled as a color sensitive regularizer encouraging pixels with a similar color value in the original image to take a similar reflectance:

[formula]

where [formula] is color value of a pixel i, and β2 and β3 control the spatial and color extent of the prior. This reflectance term is quite arbitrary, as original color values are usually not a good sole predictor of reflectance. In the rest of this section we will show how to replace this term with our data-driven pairwise reflectance prior.

The overall energy [formula] is optimized using an alternating optimization for [formula] and [formula]. The reflectance term [formula] is optimized using the mean-field inference algorithm of Krähenbühl and Koltun [\cite=kk-eifcc-11], while the shading term is optimized with iteratively reweighted least squares (IRLS).

Data-driven reflectance prior

We now show how to incorporate our relative reflectance classifier into the mean-field inference for reflectance. Specifically we define our new pairwise term as

[formula]

The main difficulty here is to evaluate the pairwise term densely over the image. The mean-field inference algorithm relies on an efficient evaluation of [formula], which is known as message passing. This message passing step naturally decomposes into a matrix multiplication with μo and a filtering term with wo. The matrix multiplication can be evaluated efficiently as it is independent for each pixel and scales linearly in the number of pixels. The filtering step on the other hand requires an exchange of information between each pair of pixels in the image. Krähenbühl and Koltun [\cite=kk-eifcc-11] showed that for a Gaussian pairwise term the filter can be approximated efficiently. The same Gaussian pairwise term is used in the original model of Bell  [\cite=bbs-iiw-14]. In our model this filter is no longer a simple Gaussian kernel, but guided by the output of a classifier. The filtering has the following form

[formula]

for each comparison o∈{ < , > , = }. For our data-driven pairwise term we would need to evaluate a classifier densely over each pair of pixels in the image, which is computationally intractable for more than a few thousand pixels.

However, the classifier output is quite low rank. If we denote |R| as the number of unique reflectance values in a scene, which is usually small [\cite=omer04] [\cite=gehler11], then the output of an ideal classifier is of at most rank |R|. This comes from the fact that each reflectance value r∈R forms a binary basis B, with a value of Bi,r = 1 if pixel i takes reflectance r, and Bi,r = 0 otherwise. Thus any ideal classifier output can be expressed as a product of [formula], where W̃o is a |R|  ×  |R| matrix describing the weighting between different reflectance values. Any rank beyond this can be attributed to noise or inconsistencies in the classifier. We measured the rank of the classifier matrix by randomly sampling K = 500 points in the image and computing the full pairwise term between those points. This results in a K  ×  K pairwise comparison matrix. We never encountered this classifier matrix to be of rank more than 100. This suggests that the low rank approximation models w<, w= and w> well.

Nyström approximation

We use Nyström's method [\cite=nystrom] to approximate wo. The main caveat with Nyström is that it requires a symmetric pairwise comparison matrix wo. While the equality constraint matrix w= is symmetric, the inequality matrices are not [formula]. We address this by rearranging all classifier outputs in a larger comparison matrix W:

[formula]

This extended matrix is symmetric and can be well approximated using Nyström's method. It is still low rank, as the three submatrices it comprises of are all low rank. We can compute the filtering in Eq. [\ref=eq:filter] by multiplying W with a vector [formula] and extracting every other elements from it.

The Nyström approximation samples 2K rows from matrix W. Let C denote those sampled rows. We always sample pairs of consecutive rows, to not introduce a bias towards any of the operations =  ,<   or >  , Nyström then approximates the dense pairwise classifier matrix as

[formula]

where D is a K  ×  K matrix corresponding to the dense pairwise classifier scores between all sampled points, and + refers to the pseudo-inverse. We sample K = 64 on a regular grid, which allows us to compute the matrices C and D within 10 seconds including the classifier evaluation. The Nyström approximation allows us to compute a message passing step within a few hundred milliseconds, while a naive evaluation would take multiple days to compute.

In summary, we evaluate the pairwise reflectance classifier from K sampled points to all other points in the image. The Nyström approximation then allows us to approximate a fully-connected dense pairwise comparison matrix using those few samples, which in turn allows for a natural integration into the fully connected CRF framework of Krähenbühl and Koltun. Notice that Nyström approximation for dense CRF has recently been explored in [\cite=wang15]. However, [\cite=wang15] merely approximates the commonly used Gaussian kernel, while we show how to integrate a more general output of a classifier into the dense CRF framework.

Experiments

In this section, we evaluate the performance of each component of our pipeline using two data sources: 1) Intrinsic Images in the Wild (IIW) dataset [\cite=bbs-iiw-14] and 2) Image Lighting Composition (ILC) dataset [\cite=webcam]. Our main baseline is the state-of-the-art intrinsic image decomposition algorithm by Bell  [\cite=bbs-iiw-14]. All models are trained and evaluated on the dataset split of Narihira  [\cite=takuya-cvpr15].

Data augmentation

IIW dataset provides 875,833 comparisons across 5,230 photos, which we extensively augment by exploiting the symmetry and transitivity of the comparisons. The augmentation not only helps reduce overfitting (as shown in Sec. Section [\ref=sec:sec:np]), but also generates pixel pairs that are spatially distant from each other (in contrast to ones originally derived from edges of a Delauney triangulation [\cite=bbs-iiw-14]). We create the augmented training and test annotations as follows:

Remove low-quality comparisons with human confidence score <  0.5.

For each remaining pairwise comparison (ri,rj), augment the annotation for (rj,ri) by either flipping (if ri  ≠  rj) or keeping (if ri  =  rj) the sign.

For any unannotated pair of reflectances (ri,rj) that share a comparison with rk, we augment it using the following rules: 1) ri = rj, iff ri = rk and rj = rk for all connected rk; 2) ri  >  rj, iff ri  ≥  rk  >  rj or ri  >  rk  ≥  rj; 3) ri  <  rj, iff ri  <  rk  ≤  rj or ri  ≤  rk  <  rj. If any pairwise comparisons are inconsistent we do not complete them. This step is done repetitively for each image until no further augmentation is possible.

Our augmentation generates 22,903,366 comparisons in total, out of which 18,621,626 are used for training and 4,281,740 for testing.

Network performance

We use Adam [\cite=adam] with β1  =  0.9, β2  =  0.999, an initial learning rate of 0.001, step size of 20,000, a step multiplier γ = 0.8. We train with mini-batches of 128 pairs and weight decay of 0.002.

For evaluation, we first use the same weighted human disagreement rate (WHDR) metric as [\cite=bbs-iiw-14] on the test split. WHDR measures the percent of human judgments that a model incorrectly predicts, weighted by the confidence of each judgment. Note that the human judgments are not necessarily consistent in the IIW dataset as human performance using this metric is 7.5 [\cite=bbs-iiw-14]. As shown in Table [\ref=tab:err], our full model trained on the augmented data performs the best with WHDR =  15.7.

Additionally, we evaluate the error rate of different algorithms on our augmented annotations. Our full model again obtains the lowest error rate of 24.6. More surprisingly, on this metric other baselines surpass the recent top performer [\cite=takuya-cvpr15]. This is likely due to a subtle bias in the original IIW annotations - spatially close pixels often have the same reflectance. This bias is no longer present in our augmented annotations as they contain more long-range pairs. This is further verified by the performance of our full model trained only on the original annotations: it too does poorly on the augmented data.

Globally consistent reflectance estimate

We measure the performance of recovering a globally consistent reflectance estimate with the energy optimization presented in Sec. [\ref=sec:abs_light]. Specifically, for each test image in the IIW dataset, we build a sparse graph over the annotated pixel pairs, and apply the relative reflectance network to each of the sampled pixels. The predicted scores are then jointly optimized by Eq. [\ref=eq:energy_sparse] using GraphCuts [\cite=bk-ecmae-04] to recover the globally consistent ordering. The recovery performance is measured using WHDR, and we obtain 18.0 over the entire test split. Compared to the direct network output (WHDR =  15.7), global ordering recovery loses 2.3 percent of the performance due to the inconsistency and noise of the network output.

Nyström approximation

We experimented with different point sampling strategies (including random sampling, spatial grid sampling and Poisson disk sampling) as well as different sample sizes, and found that grid sampling with 64 samples to work well. More samples tend to yield better approximation at the cost of computation. The overall WHDR on the IIW test split using Nyström approximated pairwise comparison is 17.2, which is slightly worse than the direct network output (15.7).

Intrinsic image decomposition

To understand the effect of our reflectance prior on intrinsic image decomposition, we perform an ablation study on several variants of the decomposition framework:

Chromaticity only

each pixel being assigned to the reflectance label that is most similar in chromaticity. This simple variant achieves WHDR =  33.6 on the original annotations, and error rate =  38.5 on the augmented data.

Chromaticity + our prior

dense CRF with chromaticity similarity as the unary potential and our reflectance prior as the pairwise potential. This variant greatly improves the performance over using chromaticity only with WHDR =  22.5 and error rate = 29.6 on the original and augmented annotations, respectively, indicating the effectiveness of our reflectance prior.

Chromaticity + our prior + shading

previous variant with additional shading costs from Bell  [\cite=bbs-iiw-14]. This variant achieves the best decomposition performance with WHDR =  19.9 and error rate = 27.3. It improves on the decomposition of Bell  both quantitatively and qualitatively.

We visualize our final decomposition output (chrom. + our prior + shading), and compare with Bell  [\cite=bbs-iiw-14] in Figure [\ref=fig:decomp] for examples from both IIW dataset and ILC datasets. In general, our decomposition tends to distinguish between reflectance and shading boundaries better than the baseline, especially under challenging lighting conditions (e.g. examples from the ILC dataset). For instance, for the kitchen scene in the first row of Fig. [\ref=fig:decomp], Bell  failed to separate the shading layer from the reflectance layer correctly, leading to large shadow boundaries (see cupboards and the floor) left over in the reflectance layer. Similarly for the example in row 6 of Fig. [\ref=fig:decomp], Bell  failed to recognize that the drastic intensity change on the ceiling and floor is due to illumination from the lamp, whereas our decomposition was able to correctly identify the shadows, and attribute them to the shading layer. However, the hand-crafted reflectance smoothness prior still works more favorably in some cases (e.g. the last row of Fig. [\ref=fig:decomp]).

Robustness to illumination variation

An ideal reflectance model should be invariant to illumination changes. To measure the degree of illumination invariance, we use image sequences of indoor scenes taken by a stationary camera under different lighting conditions provided by [\cite=webcam], and perform relighting experiments on decomposition outputs of our method and Bell . Specifically, given two images IA and IB taken from the same scene and their decomposition IA  =  RASA and IB  =  RBSB respectively, perfect decomposition would imply equal reflectance RA  =  RB, and the difference between IA and IB is entirely explained by the shading/lighting components SA and SB. In other words, for ideal decompositions, we should be able to relight RA using SB to reconstruct IB (and similarly use RB and SA to reconstruct IA). Thus, we propose to use mean pixel reconstruction error (MPRE), [formula], for measuring illumination invariance, where N is the number of images, and P is the number of pixels per image. We report the MPRE results for the three indoor scene sequences in Table [\ref=tab:mpre], and a qualitative comparison in Fig. [\ref=fig:relight]. We significantly outperform Bell et al. both quantitatively and perceptually.

Feature visualization

Finally, we visualize the features learned by our relative reflectance network using the t-SNE algorithm [\cite=tsne]. Specifically, we randomly extract 50,000 patches from the test set of IIW and find a 2-dimensional embedding of their 64-dimensional Conv4 features. Fig. [\ref=fig:embed] shows this embedding. The overall layout appears to be highly predictive of reflectance (light to dark from top-left to bottom-right). Moreover, it seems to discover some surface or material properties beyond reflectance (see Fig. [\ref=fig:embed] for more details).

Discussion

One limitation of our paper is that although the learned reflectance prior accounts for most of the decomposition performance, hand-crafted unaries on chromaticity and shading are still used for achieving state-of-the-art results. However, while it is beyond the scope of this paper, we believe hand-crafted unaries can be replaced by learned unaries (c.f. concurrent work of Narihira  [\cite=takuya-iccv15]). Acknowledgements This research is supported by ONR MURI N000141010934, Intel research grant, and Nvidia hardware donation.