=10000

Future Localization from an Egocentric Depth Image

Introduction

Consider a dynamic scene such as Figure [\ref=Fig:teaser] where you, as the camera wearer, plan to pass through the corridor in the shopping mall while others walk in different directions. You need to plan your trajectory to avoid collisions with others and objects such as walls and fence. Looking ahead, you would plan a trajectory that enters into the shop by turning left at the corner although such space cannot be seen directly from your perspective.

The fundamental problem we are interested in is future localization: where am I supposed to be after 5, 10, and 15 seconds? This challenging task requires understanding of the scene in terms of a long term temporal human behaviors with respect to the spatial scene layout, with missing data due to occlusions.

We study the future localization problem using a first person depth (stereo) camera. We present a method to predict a set of plausible trajectories of ego-motion given a depth image captured from a egocentric view. As a byproduct of predicted trajectories, the occluded space behind foreground objects is discovered. Our method purely relies on the depth measurements, i.e., no image based features such as semantic labeling/segmentation or object detection/recognition are required.

Inspired by proxemics [\cite=hall:1963], we represent the space around a camera wearer using an EgoSpace map which reassembles an illustrated tourist map: an overhead map with objects seen from first person video projected onto it.

A predictive future localization model, using the EgoSpace map, is learned from in-situ first person stereo videos from various life logging activities such as commutes, shopping, and social interactions. By leveraging structure from motion, camera trajectories are reconstructed. These camera trajectories are associated with its depth image at each time instant, i.e., given the depth image, a future camera trajectory is precisely measured while the depth image is obtained by the stereo cameras as shown in Figure [\ref=Fig:stereo].

In a training phase, we discriminatively learn the relationship between the EgoSpace map and future camera trajectory. We model a trajectory of ego-motion using a linear combination of compact trajectory bases. By the nature of the alignment between ego-motion and gaze direction, the trajectory is highly structured. We empirically show that 4~  6 linear trajectory bases are sufficient enough to express all plausible trajectories of ego-motion with high precision (99% accuracy). This compact representation allows us to efficiently find a set of trajectories that are compatible with the associated depth image using EgoSpace map matching. This provides an initialization of the predicted trajectories. However, not all these 're-imagined' trajectories avoid objects in the current first person view. We refine it by minimizing a cost function that takes into account compatibility between the obstacles in EgoSpace map and trajectory. This cost function explicitly models partial occlusion of a trajectory which allows us to discover the space behind foreground objects.

Why EgoSpace map? Two cues are strongly related to predict a trajectory of ego-motion, e.g., where is he or she going? (1) ego-cue: a vanishing point is often aligned with gaze direction; and 2D visual layout of the obstacles in the first person view implicitly encodes the semantics of the scene. (2) exo-cue: objects in a 3D scene such as road, buildings, and tables constrain the space where the wearer can navigate. Such cues can be explicitly extracted by an ego-depth image where the gaze direction of the wearer can be calibrated with respect to a ground plane (exocentric coordinate) while the depth provides obstacles with respect to the wearer (egocentric coordinate). Our EgoSpace map representation exploits these two cues where we measure depth from an egocentric view, and create an illustrated tourist map representation capturing both 2D visual arrangement of the obstacles (in first person view) and their 3D layout (in overhead view). This representation allows us to analyze and understand different scene types and gaze directions in the same coordinate system.

Contributions To our best knowledge, this is the first paper that predicts ego-motion from a depth image without semantic scene labels or object detection via in-situ first person measurements. Core technical contributions of our paper are (a) a predictive model that describes a spatial distribution of objects with respect to an egocentric view, allowing us to register different scenes in a unified coordinate system; (b) a compact subspace representation of the predicted trajectories enabling a search for trajectory parameters feasible without explicit modeling of dynamics of human behaviors; (c) occluded space discovery through trajectory prediction; and (d) the EgoMotion dataset with a depth and its long term camera trajectory, which includes diverse daily activities across camera wearers. We evaluate our algorithm to predict ego-motion in real world scenes.

Related Work

Our framework lies an intersection between behavior prediction and egocentric vision.

Human Behavior Prediction

Predicting where-to-go is a long standing task in behavioral science. This task requires to understand the interactions of agents with objects in a scene that afford a space to move. There is a large body of literature on human behaviors prediction algorithms. Pentland and Lin [\cite=pentland:1995] modeled human behaviors using a hidden Markov dynamic model to recognize driving patterns. Such Markovian model is an attractive choice to encode human behaviors because it reflects the way humans make a decision [\cite=ziebart:2008] [\cite=lee:2011] [\cite=levine:2012]. These models, especially partially observable Markov decision process (POMDP), have influenced motion planning in robotics [\cite=pineau:2007] [\cite=kurniawati:2009] [\cite=ragi:2013].

In computer vision, Ali and Shah [\cite=ali:2008] developed a flow field model that predicts spatial crowd behaviors for tracking extremely cluttered crowd scenes. Inspired by the social force model [\cite=helbing:1995], Mehran et al. [\cite=mehran:2009] predicted pedestrian behaviors in a crowd scene to detect abnormal behaviors, and Pellegrini et al. [\cite=pellegrini:2009] used a modified model to track multiple agents. Ryoo [\cite=ryoo:2011] presented a bag-of-word approach to recognize social activities at the early stage of videos. Vu et al. [\cite=vu:2014] predicted plausible activities from a static scene by associating the scene statistics and labeled actions. In terms of the trajectory prediction task, our work is closely related with three path planning frameworks by Gong et al. [\cite=gong:2011], Kitani et al. [\cite=kitani:2012], and Alahi et al. [\cite=alahi:2014]. Gong et al. presented a method to generate multiple plausible trajectories of each agent in the scene constructed by homotopy classes, which allows them to produce a long term trajectory for visual tracking in crowd scenes. Kitani et al. leveraged inverse optimal control theory to learn human preference with respect to the scene semantic labels, which enables them to predict the paths an agent follows. Alahi et al. introduced a geometric feature, social affinity model that captures a spatial relationship of neighboring agents to predict destinations of a crowd.

Unlike previous methods that use semantic labels/segmentation or object detection/tracking which are often noisy in real world scenes, our measurements are a single depth image that can be reliably obtained by stereo cameras or depth sensors. Estimating optimal parameters for Markovian models is often intractable. In contrast, our trajectory representation in a egocentric view can be encoded using compact trajectory bases, thus it makes learning tractable because of the reduced number of parameters.

Egocentric Vision

A first person camera is an ideal camera placement to observe human activities because it reflects the attention of the camera wearer. This characteristics provides a powerful cue to understand human behaviors [\cite=fathi:2011] [\cite=kitani:2011] [\cite=fathi:2013] [\cite=pirsiavash:2012] [\cite=ryoo:2013].

Kitani et al. [\cite=kitani:2011] used scene statistics produced by camera ego-motion to recognize sport activities from a firse person camera. Traditional vision frameworks such as object detection, recognition, and segmentation frameworks are successfully integrated in first person data: Pirsiavash and Ramanan [\cite=pirsiavash:2012] recognized daily activities using deformable part models, Lee et al. [\cite=lee:2012] found important persons and objects, Fathi et al. [\cite=fathi:2011] discovered objects, and Li et al. [\cite=li:2013] [\cite=li_cvpr:2013] segmented pixels corresponding to hands. In a social setting, Fathi et al. [\cite=fathi:2012] presented a method to recognize social interactions by detecting gaze directions of people and Park et al. [\cite=park:2012] introduced an algorithm to reconstruct joint attention in 3D by leveraging 3D reconstruction of camera ego-motion. This reconstruction allows prediction of joint attention possible by learning the spatial relationship between a social formation and joint attention [\cite=park:2015].

Such characteristics of first person cameras were used to generate interesting applications in vision, graphics, and robotics. Lee et al. [\cite=lee:2012] summarized a life logging video, Xiong et al. [\cite=xiong:2014] detected iconic images using a web image prior. Arev et al. [\cite=arev:2014] used 3D joint attention to edit social video footages and Kopf et al. [\cite=kopf:2014] used 3D camera motion to generate a hyperlapse first person video. In robotics, Ryoo et al. [\cite=ryoo:2015] predicted human activities for human-robot interactions.

Unlike most previous methods, our task primarily focuses on predicting future behaviors by leveraging in-situ measurements from 3D reconstruction of camera ego-motion. This also allows us to tackle a more challenging problem--to discover an empty space that is not observable because of visual occlusion.

Representation

Inspired by proxemics [\cite=hall:1963], we present a characterization of space with respect to the egocentric coordinate system, called EgoSpace map.

EgoSpace Map

EgoSpace Map is a representation for space experienced from first-person view but visualized in an overhead bird-eye map, akin to an illustrated tourist map.

It has three key ingredients. First, we define an egocentric coordinate system centered at the feet location, the projection of the center of eyes onto the ground plane as shown in Figure [\ref=Fig:notation]. The normal direction, [formula], of the ground plane is aligned with the Y-axis, and the height of the eye location is h, i.e., [formula] where [formula] is the 3D location of the center of eyes. The gaze direction defines tangential directions of the ground plane: the Z-axis is aligned with the projection of the gaze direction, [formula], i.e., [formula].

Second, the EgoSpace encodes depth cue from a first person view onto an overhead view on the ground plane. Using a log-polar φ(r,θ) parametrization of the X-Z (ground) plane, we define EgoSpace Map as a function [formula], measuring likelihood of occlusion introduced by foreground objects from the gaze direction. One can think of the eye gaze is a light source shining on foreground objects casting shadows onto the ground plane. On the shadow image we record the object height which is proportional to the occlusion likelihood.

Formally, φ(r,θ) measures the height of the point, [formula], from the ground plane that intersects the ray, [formula], from the center of eyes, [formula], to (r,θ) with an occluding object, O, i.e.,

[formula]

where [formula] such that [formula]. {Oi}Oi = 1 is a set of objects in the scene.

We discretize the polar coordinate system by uniform sampling in angle between π / 6 and 5π / 6 and uniform sampling in the inverse of radius which results in uniform sampling in the egocentric view as shown in Figure [\ref=Fig:depth]. Note that the locations to measure the EgoSpace map are almost radially uniform from the first person view point. Figure [\ref=Fig:feature] shows the EgoSpace map for Figure [\ref=Fig:depth].

For future localization, ground plane provides a free space for us to move into. On the EgoSpace map, φ(r,θ) = 0 if from the first person view the point (r,θ) lies on the ground plane. More interestingly, the space behind an object also indicates potential places to navigate. Since the EgoSpace map is represented in the ground plane, not in first person view, the space behind the object are marked as occluded area (the right few columns of the map).

Third, the area outside of a first person view depth image boundary is set to φ max = 2m. On the EgoSpace map, shape of the mask is uniquely defined by the gaze direction (roll and pitch angles of the head direction). For example, Figure [\ref=Fig:depth] shows a case where the wearer is looking ahead almost parallel to the ground, the ground area close to the wearer (r  <  0.5m) was not visible e.g., φ(r  <  0.5m,θ) is marked as φ  =  φ max. If the wearer is looking down, the masked area on EgoSpace would be for large values of r.

The EgoSpace representation supports learning future localization from first person videos by combining cues from 3D scene geometry and gaze direction. Its benefits include: 1) the gaze direction normalized coordinate system provides a common 3D reference frame to learn; 2) overhead view representation removes the variations in first person 3D experience due to the head's pitch angle, 3) the log-polar encoding and sampling gives more importance to nearby space, and 4) the depth masking encodes implicitly both roll and pitch angle of head, making it more situation aware.

Compact Trajectory Representation

Let [formula] be a 2D trajectory on the ground plane of the egocentric coordinate system, where F is the number of future frames to predict and xi and zi are two coordinates at the ith time instance as shown in Figure [\ref=Fig:notation]. In practice, this trajectory can be obtained by projecting 3D camera poses between the f + 1 and f + F time instances at the fth time instant onto the ground plane. This allows us to represent all trajectories in the same egocentric coordinate system, which are normalized by gaze direction because the Z axis is aligned with the gaze direction.

The gaze direction normalized trajectory is highly compressible. Most trajectory of ego-motion can be encoded using a linear combination of trajectory bases learned using Principal Coordinate Analysis (PCA) from the EgoMotion dataset described in Section [\ref=Sec:data]:

[formula]

where [formula] is a mean trajectory and [formula] is a collection of trajectory bases, i.e., each column of [formula] is a trajectory basis where K is the number of basis. In practice, K is selected as 4~  6 which can express all ego-motion trajectories with 99% accuracy as shown in Figure [\ref=Fig:traj] and Figure [\ref=Fig:reconstruction_error]. [formula] is the trajectory coefficient, which is the low dimensional parametrization of [formula]. In Figure [\ref=Fig:reconstruction_error], we compare reconstruction error produced by PCA bases and DCT generic bases [\cite=akhter:2011].

Prediction

A trajectory of ego-motion is associated with an EgoSpace map, i.e., given a depth image, we know how we explored the space in the training data (Section [\ref=Sec:data]). By leveraging a computational representation of egocentric space and trajectory described in Section [\ref=Sec:representation], in this section, we present a method to predict a set of plausible trajectories given an EgoSpace map and to discover the occluded space using the predicted trajectories.

Ego-motion Prediction

Estimating [formula] that conforms to a depth image is to find a path that stays in the ground plane minimizing the following cost function along the trajectory:

[formula]

where [formula] is the Cartesian coordinate representation of the EgoSpace map, φ and [formula] is a matrix composed of the (2(i - 1) + 1)th and 2ith rows of [formula]. Therefore, [formula] is the point (xi,zi) at the ith time instant.

Equation ([\ref=Eq:min1]) finds a trajectory that stays on the ground given a depth image. This approach has been used in robotics communities for various path planning tasks. However, this does not take into account the trajectory that is partially occluded by objects because the occluded part of the trajectory always produces higher cost. Instead, we introduce a novel cost function that minimizes a trajectory cost difference between the given depth image and the retrieved depth image from the database:

[formula]

where [formula] and [formula] are the EgoSpace map and trajectory parameter retrieved from the training dataset. This minimization finds a partially occluded trajectory as long as there exists a trajectory in the database that has similar occlusion cost.

There exist infinite number of trajectories that are compatible with a given EgoSpace map. More importantly, the cost function in Equation ([\ref=Eq:min]) is nonlinear where an initialization of the solution is critical.

We initialize [formula] using a trajectory retrieved from the training data by EgoSpace map matching. The dataset is divided into 3 gaze directions (3 pitch angles) to reduce the false matches dominated by the area beyond the depth image. Given an EgoSpace map, k-nearest neighbors (KNN) are found using K-d tree [\cite=muja:2014]. Other search or planning methods such as structured SVM [\cite=tsochantaridis:2005] and Rapidly Exploring Random Tree (RRT) [\cite=lavalle:1998] can be complimentary to the KNN search.

Occluded Space Discovery

The predicted trajectories of ego-motion allow us to discover the hidden space occluded by foreground objects because the trajectories can be still predicted in the hidden space. We build a likelihood map of the occluded space as follows:

[formula]

where [formula] is the likelihood of the occluded space that a trajectory can pass through at the evaluating point [formula] in the ground. [formula] is the jth predicted trajectories, J is the number of predicted trajectories, and σ is the bandwidth for the Guassian kernel. Equation ([\ref=Eq:discovery]) takes into account the likelihood of the predicted trajectories weighted by the likelihood of the occlusion. [formula] is high when many trajectories are predicted at [formula] while [formula] is high.

EgoMotion Dataset

We present a new dataset, EgoMotion dataset, captured by first person stereo cameras. This dataset includes various indoor and outdoor scenes such as Park, Malls, and Campus with various activities such as walking, shopping, and social interactions.

Data Collection

A stereo pair of GoPro Hero 3 (Black Edition) cameras with 100mm baseline are used to capture EgoMotion dataset as shown in Figure [\ref=Fig:stereo]. All videos are recorded at 1280×  960 with 100fps. The stereo cameras are calibrated prior to the data collection and synchronized manually with a synchronization token at the beginning of each sequence.

Depth Computation We compute disparity between the stereo pair after stereo rectification. A cost space of stereo matching is generated for each scan line and match each pixel by exploiting dynamic programming in a coarse-to-fine manner.

3D Reconstruction of Ego-motion We reconstruct a camera trajectory using a standard structure from motion pipeline with a few modifications to handle a large number of images. We partition the dataset such that each dataset includes less than 500 images with sufficient overlap with neighbor image sets (100 image overlap). We reconstruct each dataset independently and merge them by minimizing cross reprojection error between two dataset, i.e., a point in one dataset is reprojected to a camera in the other dataset. Then, we project the reconstructed camera trajectory onto the ground plane estimated by fitting a plane using RANSAC [\cite=fischler:1981].

Scenes We collect both indoor and outdoor data, which consists of 21 scenes with 55,933 frames of 7.7 hours long in total, including walking on campus, in parks and downtown streets, shopping in the mall, cafe and grocery, as well as taking public transportation. The data consists of various activities (walking, talking, and shopping), scenes (campus, park, malls, and downtown streets), cities, and time. We also collect repeated daily routines multiple times at a campus. The dataset is summarized in Table [\ref=table:dataset].

Data Analysis

We define the EgoSpace map with respect to a gaze direction, which allows us to canonicalize all trajectories in one coordinate system and further to represent it with compact bases. This stems from a primary conjecture: a gaze direction is aligned with ego-motion. In this section, we empirically prove the conjecture from our EgoMotion dataset.

We compute the pitch angle of a gaze direction by calibrating the relationship between the first person camera and gaze direction [\cite=park:2012]. The pitch angle is cos - 1vz by definition in Section [\ref=Sec:feaure] and the position after 10 seconds is used to measure the direction of destination. Figure [\ref=Fig:pitch] shows a distribution of the direction of destination with respect to the gaze pitch angle, which indicates that the gaze direction is aligned with the pitch axis. Figure [\ref=Fig:yaw] shows a yaw distribution of the direction of destination given pitch angle (a horizontal cross section of Figure [\ref=Fig:pitch]). This also indicates that gaze direction is highly correlated with the direction of destination.

Result

We apply our method to predict ego-motion and hidden space in real world scenes by leveraging the EgoMotion dataset. We divide all scenes into two categories: indoor and outdoor scenes as ego-motion has different characteristics, e.g., speed and scene layout. Note that for all evaluations, we predict a scene that is not included in training data, i.e., training and testing scenes are completely separated.

Quantitative Evaluation

We quantitatively evaluate our trajectory prediction by comparing with ground truth trajectories achieved by 3D reconstruction of the first person camera. Our evaluation addresses the future localization problem.

Multiple trajectories are often equally plausible, e.g., Y-junction, while one ground truth trajectory is available per image. This results in a large prediction error. To address this multiple path configuration, we measure predictive precision--how often one of our predicted trajectories aligns with the ground truth trajectory, i.e., [formula], where N is the number of testing images. Di = 1 if [formula], and Di = 0 otherwise where [formula] is the location at the tth time instant of the kth predicted trajectory and [formula] is the ground truth trajectory. We set ε  =  1.5m. Note that unlike previous approaches measured a spatial distance between trajectories [\cite=kitani:2012], our evaluation measures a spatiotemporal distance between trajectories because the time scale also needs to be considered.

Four baseline methods are used to compare our approach: one method solely based on gaze direction, two methods with a subsampled depth image at the same resolution of our EgoSpace map, and one method with EgoSpace map but without trajectory refinement by Equation ([\ref=Eq:min]). (1) Going straight: we generate a trajectory aligned with the gaze direction to test gaze bias; (2) Pure 2D: we retrieve a set of trajectories using KNN solely based on a subsampled depth image; (3) 2D+ground plane: we retrieve trajectories using the subsampled depth image but transform the coordinates of the trajectories such that they lie on the ground plane of the test image. This coordinate transform takes into account the 3D camera direction with respect to the ground plane of the test image; (4) EgoSpace w/o trajectory optimization: the trajectories are retrieved by the EgoSpace map but no adaptation to the test image by Equation ([\ref=Eq:min]). In fact, this method provides an initialization of our predicted trajectories.

Figure [\ref=Fig:quant] shows evaluations on indoor and outdoor depth images. We retrieve k neighbors from dataset and measure precision. Our method outperforms the baseline algorithms with large margin. These experiments indicate that the EgoSpace representation has strong predictive power comparing to the camera pose oriented feature produced by the subsampled depth image. Also the scene adaptation by the trajectory optimization allows us to produce more accurate prediction (see the performance gap from the initialization). As noted in Section [\ref=Sec:analysis], a gaze direction is a good predictor but it is not strong enough to predict a long term behavior. Note that the precision at early k may be significantly improved by using N-best algorithms [\cite=park:2011] based on homotopy class [\cite=gong:2011] because KNN retrieves many redundant trajectories. In Table [\ref=table:recon], we measure the average precision across all scenes in Section [\ref=Sec:data].

Occluded Space Discovery We quantitatively evaluate our occluded space discovery by measuring detection rate, D / N where D is the number of true positive detection and N the total number of detection produced by the space discovery. We threshold the likelihood of the occluded space, ψ, from Equation ([\ref=Eq:discovery]) and manually evaluate whether the detection is correct. Note that no ground truth label is available unless the camera wearer already had passed through the space. The detection rate in Table [\ref=table:detection] indicates that our method predicts the outdoor scenes better than the indoor scenes. This is because the indoor scenes such as Grocery and IKEA, the camera wearer had a number of close interactions with objects such as shelves or products where the view of the scenes are substantially limited.

Qualitative Evaluation

We apply our method on real world examples to predict a set of plausible trajectories of ego-motion and the occluded space by foreground objects. Our training dataset is completely separated from testing data, e.g., Grocery scene was trained to predict IKEA scene. Given a depth image, we estimate the ground plane by a RANSAC based plane fitting with gravity and height prior. This ground plane is used to define the EgoSpace map with respect to the camera direction.

Figure [\ref=Fig:teaser] and Figure [\ref=Fig:qual] illustrate our results from the EgoMotion dataset. In a testing phase, only a depth image was used while 3D reconstruction of camera poses were used in the training phase. In Figure [\ref=Fig:qual], we show (1) image and ground truth ego motion; (2) input depth image; (3) EgoSpace map overlaid with the predicted trajectories (gray) and ground truth trajectory (red); (4) reprojection of the trajectories; (5) reprojection of occluded space computed by the EgoSpace map (inset image). For all scenes, our method predicts the plausible trajectories that pass through unexplored space.

Obstacle Avoidance Our cost function in Equation ([\ref=Eq:min]) minimizes cost difference between trajectories from training data and testing data. This precludes a trajectory passing through an object unless the retrieved trajectory was partially occluded. EgoSpace map captures the obstacle avoidance as shown in Campus and Grocery.

Multiple Plausible Trajectories Our prediction produces a number of plausible trajectories that conform to the testing scene. Trifurcated trajectories in Campus; bifurcated trajectories in Bus stop; and multiple directions of trajectories in Mall I.

Occluded Space Discovery The space occluded by foreground objects is discovered by the predicted trajectories. The space inside of the shop and behind the person in Figure [\ref=Fig:teaser]; the space occluded by the left fence and persons in Campus; the space behind the cars and the parking vending machine in Bus stop; the space behind the persons and trees in Park; the space inside the shop and around the left corner; the space behind the column; and the space occluded by the fence.

Discussion

In this paper, we present a method to predict ego-motion and occluded space by foreground objects from a first person depth image. EgoSpace map that encodes a likelihood of occlusion is used to represent a scene around a camera wearer. We associate a trajectory with the EgoSpace map in the training phase to predict a set of plausible trajectories given a test depth image. The trajectories that are parametrized by a linear combination of compact trajectory bases are refined to conform with the test depth image. The occluded space is detected by measuring how often the predicted trajectories invade the occluded space.

Limitation Our framework needs three ingredients: similar scene training data, ground estimation, and depth computation. These failure cases are illustrated in Figure [\ref=Fig:fail].