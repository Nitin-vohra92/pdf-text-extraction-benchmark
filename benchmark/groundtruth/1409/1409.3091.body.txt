Equivalence of two different approaches to global δf gyrokinetic simulations

Introduction

Tokamak and stellarator turbulence has characteristic lengths of the order of the ion gyroradius ρi in the direction perpendicular to the magnetic field, and characteristic time scales of order L / vti, where L is the characteristic length of the device , and vti is the ion thermal speed [\cite=mckee01]. Gyrokinetics [\cite=catto78] [\cite=frieman82] is the appropriate model for this type of turbulence because it permits averaging out the gyromotion, fast compared to the turbulence characteristic time, while keeping finite gyroradius effects.

Because the perpendicular characteristic length of the turbulent eddies [formula] is of the order of the ion gyroradius, the typical perpendicular correlation length of the turbulence is smaller than the size of the device by a factor [formula]. It is then natural to assume that the turbulence characteristics depend only on the local values of density, temperature, electric field and magnetic field, and on their gradients. The flux tube formulation [\cite=beer95] uses magnetic field aligned coordinates and periodic boundary conditions in the directions perpendicular to the magnetic field to give equations for the turbulence that only depend on the local background quantities. The justification for the periodic boundary conditions is statistical periodicity, i.e., beyond a perpendicular correlation length, the turbulence is statistically the same and uncorrelated, and as a result, we can simulate the turbulence in a box with periodic boundary conditions as long as the box is several correlation lengths across. This formulation has been implemented successfully in a number of codes [\cite=dorland00] [\cite=dannert05] [\cite=watanabe06] [\cite=peeters09c] [\cite=numata10]. The fact that the results of these codes converge when resolution scans are performed suggests that the flux tube formulation is self-consistent, that is, it is the rigorous limit of the gyrokinetic equations for [formula].

The flux tube gyrokinetic formulation fails when the perpendicular size of the turbulent eddies [formula] is comparable to the size of the device, [formula]. The surmise that flux tube codes may not be applicable to small machines in which L is small led to the development of global δf codes [\cite=candy03] [\cite=chen03] [\cite=mcmillan08] [\cite=goerler11] and full f codes [\cite=grandgirard06] [\cite=xu07] [\cite=chang08] [\cite=heikkinen08] that do not assume statistical periodicity in the radial direction. The results obtained with these global codes tend to the solutions obtained with flux tube simulations when the size of the turbulent eddies is much smaller than the simulation domain [\cite=goerler11] [\cite=candy04], confirming that the flux tube formulation is the correct limit for [formula].

In the derivation of the gyrokinetic equations, the eddy characteristic length is ordered as [formula] to include finite gyroradius effects in the equations. For this reason, it has been argued that devices with relatively large [formula] can only be modeled with global gyrokinetic codes, but this statement is not completely correct. Global codes can treat turbulence with [formula], but they are not particularly well suited for treating most of the finite [formula] effects. Flux tube gyrokinetic formulations are based on two independendent expansions: one in the ratio [formula] between the frequency of the turbulence vti / L and the ion gyrofrequency Ωi, and one in the ratio [formula] between the eddy perpendicular length and the size of the machine. Due to the expansion in [formula], it is possible to average over the fast gyromotion time scale. The expansion in [formula] is common to both global and flux tube codes, and finite [formula] effects can only be treated properly by keeping higher order terms in the gyrokinetic equation [\cite=parra11a], or by resorting to a full Vlasov formulation. The expansion in [formula] is relaxed in global simulations. Thus, global codes are appropriate for [formula]. The size of [formula] is connected to the size of the turbulent energy flux [formula] which is in turn controlled by the energy injected into the machine. To illustrate the relation between [formula] and [formula], we use the regime of Ion Temperature Gradient (ITG) turbulence far from marginal stability studied in [\cite=barnes11b]. In this regime, the turbulent energy flux is

[formula]

the perpendicular eddy length is

[formula]

and the size of the turbulent perturbation of the electrostatic potential [formula] is

[formula]

Here ne is the electron density, Ti is the ion temperature, [formula] is the characteristic length of the ion temperature, and qR is the tokamak connection length. Equations ([\ref=eq:Qtborder]), ([\ref=eq:lbotorder]) and ([\ref=eq:phitborder]) were obtained for turbulence in which the density and temperature fluctuations are not in phase. From equations ([\ref=eq:Qtborder]), ([\ref=eq:lbotorder]) and ([\ref=eq:phitborder]), we find

[formula]

Global gyrokinetic codes are then useful if [formula] is sufficiently large that [formula] whereas at the same time, [formula] is still sufficiently small to justify averaging out the gyromotion. Importantly, in the limit [formula], the turbulent fluctuations of the potential are of the order of the thermal energy of the plasma, and some terms that are neglected in δf formulations become important. We do not attempt to model this extreme limit in this article, and for this reason, we do not consider the case [formula] any further.

Global gyrokinetic codes have proven useful for certain problems, but they have several disadvantages compared to flux tube formulations. They are computationally expensive, and unlike most flux tube codes, they do not use efficient spectral methods which are particularly useful for gyroaveraging. The time scale separation between the transport time scale and the turbulent time scale is not infinite as in flux tube formulations, and as a result, ad hoc sources and sinks of particles, momentum and energy must be included to mantain density, rotation and temperature gradients. Perhaps the greatest challenge facing global simulations is choosing suitable boundary conditions at the two flux surfaces that bound the simulation domain. The boundary conditions imposed in global δf codes are typically chosen to be 'benign' from a numerical perspective; i.e., not chosen according to physical considerations such as regularity at the magnetic axis, or the open field lines beyond the last closed flux surface. The influence of these boundary conditions on the results of the simulations for [formula] is unclear. Boundary conditions are important in this limit, but if this is the case, the boundary conditions should be based on physical arguments.

Given these limitations, we propose a different approach to capture effects included in global δf codes but not in flux tube formulations. Our approach exploits the advantages of the flux tube formulation, and relaxes the assumption [formula] by keeping more terms in the expansion in [formula].

The new method presented in this article is ideal for intrinsic rotation calculations. Intrinsic rotation is the rotation observed in tokamaks without any external momentum input [\cite=rice99] [\cite=rice05] [\cite=bortolon06] [\cite=scarabosio06] [\cite=degrassie07] [\cite=duval07] [\cite=rice07] [\cite=eriksson09] [\cite=incecushman09] [\cite=lin09] [\cite=camenen10] [\cite=solomon10] [\cite=mcdermott11] [\cite=rice11a] [\cite=rice11b] [\cite=parra12a] [\cite=hillesheim14]. It is the result of the turbulent redistribution of toroidal angular momentum within the tokamak plasma. To lowest order in [formula], momentum redistribution is not possible in up-down symmetric tokamaks due to a symmetry of the gyrokinetic equations [\cite=peeters05] [\cite=parra11c] [\cite=sugama11a]. Intrinsic rotation can only be driven by mechanisms that break this symmetry, such as up-down asymmetry of the magnetic flux surfaces [\cite=camenen09b] [\cite=camenen09c] [\cite=ball14], or higher order terms in [formula] [\cite=parra10b] [\cite=parra12b]. Some of the higher order terms that have been considered in previous work are: RF heating and current drive [\cite=perkins01] [\cite=lee12], the radial variation of the gradients of density and temperature [\cite=diamond08] [\cite=gurcan10] [\cite=waltz11] [\cite=camenen11], the neoclassical flows of particles and heat parallel to the flux surface [\cite=parra10a] [\cite=parra11d] [\cite=barnes13] [\cite=lee14a] [\cite=lee14b] [\cite=lee14c], finite orbit width effects [\cite=parra10a] [\cite=parra11d], and the poloidal variation of the turbulence characteristics [\cite=sung13] (see [\cite=parra14b] for a rigorous treatment of all these effects for conventional tokamaks). The new method for global δf gyrokinetics that we propose here can be used to study the effect of the radial and poloidal variation of the turbulence characteristics on rotation.

We present gyrokinetics briefly in section [\ref=sec:gyrokinetics]. We then propose the new method to do global δf gyrokinetics in section [\ref=sec:newapproach], and we prove that it is equivalent to the method implemented in current global δf simulations for [formula] in section [\ref=sec:equivalence]. We finish with some remarks and conclusions in section [\ref=sec:conclusions].

Gyrokinetics

Gyrokinetics [\cite=catto78] [\cite=frieman82] averages out the gyromotion time scale while keeping finite gyroradius effects. To be able to average out the gyromotion, several terms must be small in [formula]. In particular, for electrostatic turbulence in a plasma with flow below the ion thermal speed, the electric field must satisfy [\cite=dimits92] [\cite=parra08]

[formula]

where B is the magnitude of the magnetic field, and c is the speed of light. When this bound is satisfied by the electric field, the modifications to the lowest order circular gyro orbit are small in [formula], and the calculation of the particle orbit can be done order by order in [formula] to the desired accuracy. The methods to perform the expansion are varied [\cite=XSLee83] [\cite=WWLee83] [\cite=dubin83] [\cite=hahm88] [\cite=sugama96] [\cite=sugama97] [\cite=sugama98] [\cite=brizard07] [\cite=parra08] [\cite=abel13] [\cite=parra11a]. Once the particle motion is known, it is straightforward to split it into secular drifts and periodic oscillations, and it is possible to average over the periodic oscillations because they happen in the fast gyromotion time scale. For a recent review on the topic of gyrokinetics, see [\cite=krommes12].

Because we want to keep finite gyroradius corrections, we allow wavelengths perpendicular to the magnetic field of the order of ρi, that is, [formula]. According to the bound ([\ref=eq:Efieldorder]), the components of φ that have such short wavelengths are of order [formula]. The turbulence wavelength parallel to the magnetic field is much larger than the perpendicular wavelength, [formula]. The reason for this difference between the parallel and the perpendicular scale lengths is the disparate size of the parallel and perpendicular velocities of the secular particle motion. In the parallel direction, the particle moves with its full parallel velocity, whereas in the perpendicular direction the particle velocity almost averages to zero, giving perpendicular drifts slower than the thermal speed by a factor of [formula].

To describe the particle motion, new phase space coordinates are defined order by order in [formula] [\cite=parra08]. We use the guiding center position [formula], the parallel velocity v||, the magnetic moment μ and the gyrophase φ. These variables are defined such that the particle's position and velocity are

[formula]

and

[formula]

to lowest order in [formula]. Here

[formula]

is the gyroradius, [formula] is the unit vector in the direction of the magnetic field [formula], and 1 and 2 are two unit vector that form an orthonormal set with [formula] and satisfy 1  ×  2  =  . Of these coordinates, only the gyrophase φ changes in the fast gyromotion time scale. The other coordinates are defined such that they do not vary in the gyromotion time scale. As a result, we can average out the gyromotion by just averaging over φ. The distribution function will not depend on the gyrophase to lowest order because of this averaging procedure. Expressions ([\ref=eq:rdef]) and ([\ref=eq:vdef]) are only valid to lowest order in [formula]. For a complete and consistent treatment of the gyrokinetic transformation to the correct order, see [\cite=parra11a], where the transformation is calculated to second order in [formula].

Before writing the gyrokinetic system of equations, we make an additional assumption, namely the turbulent fluctuations are small compared to the background. This approximation is valid in the core of tokamaks and stellarators [\cite=mckee01]. In addition, in the core, the collision frequency is much larger than the inverse of the transport time scale, making the background distribution function a Maxwellian to lowest order. Then, the distribution function for species s is

[formula]

where

[formula]

is a stationary Maxwellian and [formula] is the turbulent piece of the distribution function. The density ns(ψ) and the temperature Ts(ψ) are flux functions, that is, they only depend on our radial coordinate ψ, the poloidal magnetic flux divided by 2π. Correspondingly, the electrostatic potential is

[formula]

where the background potentical [formula] is a flux function because of quasineutrality, and [formula] is the turbulent piece of the potential. Both [formula] and fMs are slowly varying in space. In particular, fMs can be Taylor expanded around [formula] to give

[formula]

Using expressions ([\ref=eq:fssplit]) and ([\ref=eq:phisplit]), we obtain the lowest order Fokker-Planck equation for [formula],

[formula]

where we have neglected collisions for simplicity, and we have written the equation in terms of the non-adiabatic response

[formula]

and the lowest order quasineutrality equation for [formula],

[formula]

Here

[formula]

is the curvature and magnetic drift, [formula] is the curvature of the magnetic field line, and [formula] is the gyrophase average holding [formula], v||, μ and t fixed. In particular, the gyroaveraged potential is

[formula]

Equations ([\ref=eq:FPequation]) and ([\ref=eq:QNequation]) are only correct to lowest order in [formula], but they are the most commonly used equations in global δf codes. The higher order terms that we keep in the next sections are the ones needed to capture the physics included in global δf codes. For other higher order effects, see [\cite=parra11a] [\cite=parra14b].

New approach to global δf gyrokinetics

Because we need to distinguish between the directions perpendicular and parallel to the magnetic field due to the disparate length scales, we use the set of flux coordinates {ψ,α,θ} to describe the spatial dependence of [formula] and [formula]. As explained above, ψ is the poloidal magnetic flux divided by 2π, and determines the flux surface. The angle α is the Clebsch variable corresponding to ψ,

[formula]

and identifies a magnetic field line within the flux surface. The two coordinates ψ and α describe the direction perpendicular to the magnetic field and satisfy [formula]. We need one coordinate to determine the position along the magnetic field line. We choose the poloidal angle θ.

With periodic boundary conditions, it is possible to write the perpendicular spatial dependence of the potential and the distribution function as an eikonal, that is,

[formula]

and

[formula]

The wavenumbers kψ and kα are ordered such that

[formula]

is of order ρ- 1i, that is, the eikonal kψψ  +  kαα gives the fast spatial dependence of the turbulent fluctuations. In addition to the eikonal, in the Fourier coefficients [formula] and [formula] in ([\ref=eq:phitbscales]) and ([\ref=eq:fstbscales]), we have kept a slow dependence on the position. The characteristic length of this dependence is of the order of the size of the machine,

[formula]

where

[formula]

and the equivalent formula is used for [formula]. This slow spatial dependence represents two different phenomena: the long parallel wavelengths of the turbulence, and the slow dependence of the turbulence characteristics on the spatial location. The long parallel wavelengths of the turbulence are included in flux tube codes, but the effect of the slow variation of the turbulence characteristics across the machine is not included. Note that in tokamaks, [formula] due to axisymmetry.

Using the forms in ([\ref=eq:phitbscales]) and ([\ref=eq:fstbscales]), we obtain

[formula]

and

[formula]

where Jn is the n-th order Bessel function of the first kind,

[formula]

[formula]

and [formula] is the magnitude of [formula] in ([\ref=eq:kbotdef]). The corrections [formula] and [formula] are small in [formula], and we have neglected terms that are of order [formula] or higher. The corrections [formula] and [formula] are given by

[formula]

and

[formula]

where [formula] is the unit matrix, our convention for double contraction is [formula], and

[formula]

is defined such that G  →  1 for x  →  0.

With the results in ([\ref=eq:phiaveapprox]) and ([\ref=eq:hrvapprox]), and the decomposition in ([\ref=eq:phitbscales]) and ([\ref=eq:fstbscales]), equations ([\ref=eq:FPequation]) and ([\ref=eq:QNequation]) become

[formula]

and

[formula]

It is important to remember that all the coefficients in these equations depend on ψ and α even though that dependence is not used in flux tube formulations. A prime on a function such as [formula] or Λs indicates that it depends on [formula] and [formula], e.g., [formula]. Two primes indicate that it depends on [formula] and [formula], e.g., [formula], where

[formula]

and

[formula]

In ([\ref=eq:FPfluxtube]) and ([\ref=eq:QNfluxtube]), the terms that are small because they correspond to the slow derivatives are on the right side of the equations. In flux tube simulations, these terms are neglected, leaving the simpler equations

[formula]

and

[formula]

If the terms on the right side of equations ([\ref=eq:FPfluxtube]) and ([\ref=eq:QNfluxtube]) are implemented into a flux tube code, they give the next order corrections in the expansion in [formula], and some of the terms in the expansion in [formula], but not all of them. To calculate the right side of equations ([\ref=eq:FPfluxtube]) and ([\ref=eq:QNfluxtube]), we need the slow derivatives [formula], [formula], [formula] and [formula]. The slow derivatives [formula] and [formula] are already determined by the lowest order equations ([\ref=eq:FPfluxtube0]) and ([\ref=eq:QNfluxtube0]). To determine [formula], [formula], [formula] and [formula], one can run several flux tube simulations to obtain [formula] and [formula] at different spatial locations, and then differentiate numerically. Another possibility is to integrate in time [formula], [formula], [formula] and [formula] using the derivatives of the lowest order equations ([\ref=eq:FPfluxtube0]) and ([\ref=eq:QNfluxtube0]). The time evolution equations for [formula], [formula], [formula] and [formula] are long and for that reason are given in [\ref=app:ddpsiddaphaequations], in equations ([\ref=eq:FPgradpsi])-([\ref=eq:QNgradalpha]).

We have used the lowest order equations ([\ref=eq:FPfluxtube0]) and ([\ref=eq:QNfluxtube0]) to derive equations for [formula], [formula], [formula] and [formula] because these gradients are not needed to higher order. They only appear in the higher order terms of ([\ref=eq:FPfluxtube]) and ([\ref=eq:QNfluxtube]). If we take the spatial derivatives of ([\ref=eq:FPfluxtube]) and ([\ref=eq:QNfluxtube]) instead of the derivatives of the lowest order equations ([\ref=eq:FPfluxtube0]) and ([\ref=eq:QNfluxtube0]), [formula], [formula], [formula] and [formula] can be known to an order higher in [formula] and as a result, [formula] and [formula] can be determined to [formula]. In this case, the equations for [formula], [formula], [formula] and [formula] include terms with second spatial derivatives of [formula] and [formula] with respect to ψ and α that must be determined. To calculate these second derivatives we can use the second derivatives of the lowest order equations ([\ref=eq:FPfluxtube0]) and ([\ref=eq:QNfluxtube0]), truncating the system of equations at this order, or use again the second spatial derivatives of equations ([\ref=eq:FPfluxtube]) and ([\ref=eq:QNfluxtube]) that in turn include the third derivatives with respect to ψ and α. The more spatial derivatives we keep of [formula] and [formula], the more accurate the calculation is in [formula].

To summarize, to keep first order terms in [formula], we must solve equations ([\ref=eq:FPfluxtube]), ([\ref=eq:QNfluxtube]) and ([\ref=eq:FPgradpsi])-([\ref=eq:QNgradalpha]) simultaneously. In the next section, we show that this is equivalent to solving ([\ref=eq:FPequation]) and ([\ref=eq:QNequation]) with a global δf code for [formula].

Equivalence between the two methods to do global δf gyrokinetics

Instead of solving the equations given in section [\ref=sec:newapproach], one can solve equations ([\ref=eq:FPequation]) and ([\ref=eq:QNequation]) with a global δf code. We already pointed out in the introduction that global δf codes give the same solution as flux tube simulations in the limit [formula] [\cite=goerler11] [\cite=candy04]. In this section we show that the flux tube formulation in section [\ref=sec:newapproach] gives the same result as a global δf code to an order higher in [formula] than the usual flux tube formulation in equations ([\ref=eq:FPfluxtube0]) and ([\ref=eq:QNfluxtube0]).

The solutions to the lowest order flux tube equations ([\ref=eq:FPfluxtube0]) and ([\ref=eq:QNfluxtube0]) in a flux tube located at ψ  =  ψ0 and α  =  α0 are solutions to the global δf equations ([\ref=eq:FPequation]) and ([\ref=eq:QNequation]) to lowest order in [formula] in a region of size [formula] around ψ  =  ψ0 and α  =  α0. To show that the flux tube formulation in section [\ref=sec:newapproach] gives the solution to higher order in [formula], we construct solutions [formula] and [formula] to the global δf equations ([\ref=eq:FPequation]) and ([\ref=eq:QNequation]) from the functions [formula], [formula], [formula], [formula], [formula] and [formula] obtained using the flux tube equations ([\ref=eq:FPfluxtube]), ([\ref=eq:QNfluxtube]) and ([\ref=eq:FPgradpsi])-([\ref=eq:QNgradalpha]). These solutions are

[formula]

and

[formula]

The functions [formula] and [formula] are constructed from the Fourier coefficients that are the solution to the higher order flux tube equations ([\ref=eq:FPfluxtube]) and ([\ref=eq:QNfluxtube]) in the flux tube around ψ  =  ψ0 and α  =  α0,

[formula]

and

[formula]

The functions [formula], [formula], [formula] and [formula] are constructed from the Fourier coefficients that are the solution to the flux tube equations ([\ref=eq:FPgradpsi])-([\ref=eq:QNgradalpha]) in the same flux tube,

[formula]

[formula]

[formula]

and

[formula]

The functions [formula], [formula], [formula] and [formula] correspond to the slow spatial derivatives used in section [\ref=sec:newapproach]. We have not used the usual derivative notation, i.e., [formula], [formula], [formula] and [formula], because in global δf formulations there is no clear distinction between fast and slow spatial derivatives. In fact, the separation between fast and slow spatial dependence is somewhat arbitrary. This freedom is apparent in our formulation because the functions [formula], [formula], [formula] and [formula] are only defined by the time evolution equations they satisfy (the Fourier transforms of equations ([\ref=eq:FPgradpsi])-([\ref=eq:QNgradalpha])). The infinite choices for the initial condition for [formula], [formula], [formula] and [formula] are a reflection of the fact that the separation between fast and slow spatial dependences is arbitrary. Conversely, the time evolution equations for [formula], [formula], [formula] and [formula] are unique.

The details of the proof that the functions in ([\ref=eq:hhatdef]) and ([\ref=eq:phihatdef]) are solutions to the global δf equations ([\ref=eq:FPequation]) and ([\ref=eq:QNequation]) accurate to first order in [formula] in a region of size [formula] around ψ  =  ψ0 and α  =  α0 are given in [\ref=app:proof]. The proof consists of substituting the functions [formula] and [formula] in ([\ref=eq:hhatdef]) and ([\ref=eq:phihatdef]) into the global δf equations ([\ref=eq:FPequation]) and ([\ref=eq:QNequation]). Using the time evolution equations for [formula], [formula], [formula] and [formula] (the Fourier transforms of equations ([\ref=eq:FPgradpsi])-([\ref=eq:QNgradalpha])), it is possible to show that equations ([\ref=eq:FPequation]) and ([\ref=eq:QNequation]) are satisfied to first order in [formula] in a region of size [formula] around ψ  =  ψ0 and α  =  α0. It is crucial for the proof that the geometrical coefficients in the global δf equations ([\ref=eq:FPequation]) and ([\ref=eq:QNequation]) can be Taylor expanded around ψ  =  ψ0 and α  =  α0. Therefore, equations ([\ref=eq:FPfluxtube]), ([\ref=eq:QNfluxtube]) and ([\ref=eq:FPgradpsi])-([\ref=eq:QNgradalpha]) are equivalent to the gyrokinetic equations in a global δf simulation as long as the coefficients in the equation are sufficiently regular that they can be Taylor expanded in ψ and α.

Conclusions

We have derived a system of equations, formed by equations ([\ref=eq:FPfluxtube]), ([\ref=eq:QNfluxtube]) and ([\ref=eq:FPgradpsi])-([\ref=eq:QNgradalpha]), that gives the next order correction in [formula] to the flux tube gyrokinetic equations. Equations ([\ref=eq:FPfluxtube]), ([\ref=eq:QNfluxtube]) and ([\ref=eq:FPgradpsi])-([\ref=eq:QNgradalpha]) do not have to be solved in an extended radial domain. Consequently, we do not need to impose boundary conditions other than periodicity. We have shown that the system of equations ([\ref=eq:FPfluxtube]), ([\ref=eq:QNfluxtube]) and ([\ref=eq:FPgradpsi])-([\ref=eq:QNgradalpha]) is equivalent to the gyrokinetic equations solved in global δf simulations in the limit [formula].

The method proposed in this article is only valid for [formula], and it was developed to calculate the intrinsic rotation due to the slow spatial variation of the turbulence characteristics [\cite=parra14b]. Our method cannot treat extreme cases with turbulent eddies of the order of the size of the machine because in this limit the boundary conditions at the magnetic axis and at the last closed flux surface affect the entire tokamak. Our method can be used to find the corrections due to the finite size of turbulent eddies. One possible exciting use of the system of equations ([\ref=eq:FPfluxtube]), ([\ref=eq:QNfluxtube]) and ([\ref=eq:FPgradpsi])-([\ref=eq:QNgradalpha]) is to compare it with results from current global δf codes to determine the extent to which boundary conditions affect the turbulence and break the assumptions under which we could prove that equations ([\ref=eq:FPfluxtube]), ([\ref=eq:QNfluxtube]) and ([\ref=eq:FPgradpsi])-([\ref=eq:QNgradalpha]) are equivalent to a global δf gyrokinetic simulation.

Equations for [formula], [formula], [formula] and [formula]

Differentiating ([\ref=eq:FPfluxtube0]) and ([\ref=eq:QNfluxtube0]) with respect to ψ, we find

[formula]

and

[formula]

These equations can be integrated in time to find [formula] and [formula]. The equations for [formula] and [formula] are obtained in a similar way,

[formula]

and

[formula]

In tokamaks, [formula], and these last two equations are not needed.

Proof that the functions defined in ([\ref=eq:hhatdef]) and ([\ref=eq:phihatdef]) are solutions to the global δf equations ([\ref=eq:FPequation]) and ([\ref=eq:QNequation])

In this appendix we show that the functions [formula] and [formula] in ([\ref=eq:hhatdef]) and ([\ref=eq:phihatdef]) are solutions to ([\ref=eq:FPequation]) and ([\ref=eq:QNequation]) in a region of size [formula] around the magnetic field line ψ  =  ψ0 and α  =  α0. To describe the spatial dependence of the different coefficients in equations ([\ref=eq:FPequation]) and ([\ref=eq:QNequation]), we Taylor expand these coefficients around ψ  =  ψ0 and α  =  α0. For example, for B(ψ,α,θ),

[formula]

where B0  =  B(ψ0,α0,θ) is the function B evaluated on the magnetic field line ψ  =  ψ0 and α  =  α0, and the operator δ is

[formula]

Note that we have only Taylor expanded the dependence of B in the directions perpendicular to the magnetic field because the dependence of B along the magnetic field is needed to solve the lowest order equations ([\ref=eq:FPfluxtube0]) and ([\ref=eq:QNfluxtube0]). By writing equations ([\ref=eq:FPequation]) and ([\ref=eq:QNequation]) using the coordinates {ψ,α,θ}, Taylor expanding all the coefficients as shown in ([\ref=eq:Taylorexample]), and employing

[formula]

where the average [formula] of a function of space [formula] is

[formula]

we find

[formula]

and

[formula]

All the terms of order [formula] and [formula] are on the right side of the equations. We have neglected terms that are higher order. In deriving equations ([\ref=eq:FPlocal]) and ([\ref=eq:QNlocal]), we have distinguished between the fast derivatives ∂  /  ∂ψ and ∂  /  ∂α and the slow derivative ∂  /  ∂θ. Because most terms that contain ∂  /  ∂θ are small, we have not Taylor expanded the coefficients in terms that contain a derivative with respect to θ. The only exception to this rule is the parallel streaming term [formula] because it is a lowest order term. Finally, in the small terms we have used the lowest order version of ([\ref=eq:phiaveapprox2]), [formula].

If we neglect the right side of equations ([\ref=eq:FPlocal]) and ([\ref=eq:QNlocal]), we obtain equations with coefficients that are independent of ψ and α, and we can then Fourier analyze them. The resulting equations are the same as the lowest order flux tube equations ([\ref=eq:FPfluxtube0]) and ([\ref=eq:QNfluxtube0]), proving that global δf simulations give the same results as flux tube simulations for [formula]. We want to show that the solution in ([\ref=eq:hhatdef]) and ([\ref=eq:phihatdef]) is valid to an order higher in [formula]. We substitute equations ([\ref=eq:hhatdef]) and ([\ref=eq:phihatdef]) into equations ([\ref=eq:FPlocal]) and ([\ref=eq:QNlocal]). The resulting equation can be simplified by using the definitions of [formula], [formula], [formula] and [formula] in equations ([\ref=eq:FourierHpsi])-([\ref=eq:FourierPhialpha]), and equations ([\ref=eq:FPgradpsi])-([\ref=eq:QNgradalpha]) to obtain that [formula], [formula], [formula] and [formula] satisfy

[formula]

[formula]

[formula]

and

[formula]

Substituting ([\ref=eq:hhatdef]) and ([\ref=eq:phihatdef]) into ([\ref=eq:FPlocal]) and ([\ref=eq:QNlocal]), using equations ([\ref=eq:FPpsi])-([\ref=eq:QNalpha]), and employing

[formula]

[formula]

and

[formula]

we find

[formula]

and

[formula]

To obtain these equations, we have used that the coefficients of the Fourier series for [formula], [formula], [formula], [formula], [formula] and [formula], given in ([\ref=eq:Fourierhhat])-([\ref=eq:FourierPhialpha]), do not depend on ψ or α because they are evaluated at the fixed values ψ  =  ψ0 and α  =  α0.

Equations ([\ref=eq:FPlocalfinal]) and ([\ref=eq:QNlocalfinal]) vanish because they are the Fourier transforms of equations ([\ref=eq:FPfluxtube]) and ([\ref=eq:QNfluxtube]). To show that equations ([\ref=eq:FPlocalfinal]) and ([\ref=eq:QNlocalfinal]) are the Fourier transforms of equations ([\ref=eq:FPfluxtube]) and ([\ref=eq:QNfluxtube]), we use equations ([\ref=eq:Fourierhhat]) and ([\ref=eq:Fourierphihat]) to find

[formula]

and

[formula]

Note the difference between these results and equations ([\ref=eq:phiaveapprox]) and ([\ref=eq:hrvapprox]).

References