Supplementary Text

Definitions

We introduce these scaled variables:

the scaled mutation rate θ = 2N0μ

the scaled sweep rate ν = 2N0V

the scaled selection coefficient σ = 2Ns

the scaled time to the common ancestor of two speces τ = t / 2N0

the scaled effective population size λ = N / N0. For most of the derivation, we consider λ = 1 and will relax this further below.

General allele frequency distribution

Neutral equilibrium allele frequency distribution

We consider a single biallelic site with two alleles 0 and 1. We denote the frequency of allele 1 in the population with x. In the absence of any selective advantage, a symmetric mutational process with scaled rate θ and an effective population size N, genetic drift will lead to an equilibrium distribution [\cite=Sawyer:1992vb] which for small mutation rates can be decomposed into two terms [\cite=Mustonen:2007im]:

[formula]

with the partial distribution

[formula]

and the normalization factor

[formula]

To derive the probability to observe a discrete allele count rather than a continuous allele frequency we model the binomial sampling process explicitly. The probability to observe k out of m individuals carrying allele 1 is then given as a binomial moment of the equilibrium distribution:

[formula]

which leads again to the independent partial distributions

[formula]

for a = 0,1.

Hitchhiking with recurrent selective sweeps

We model recurrent selective sweeps as a Poisson process with scaled rate ν. The probability that no sweep occurs for a time t (in scaled units of 2N generations) is then exponential:

[formula]

We approximate the expected scaled time it takes for a neutral polymorphism to reach allele frequency x by t = x (again in units of 2N generations) and express the partial equilibrium probability under recurrent sweeps approximately as

[formula]

where the sum over the two delta distributions accounts for complete hitchhiking to the two fixed states b = {0,1} and which will be given further below.

We can again derive binomial moments to express the discrete probability distribution for sampling k out of m individuals with allele 1:

[formula]

where the last term again account for the fraction of hitchhiking alleles and affects the two boundary states k = 0 and k = m. Here, [formula] denotes the confluent hypergeometric function.

The hitchhiking fraction is derived by integrating the probability to hitchhike from frequency x to frequency b = 0 or b = 1:

[formula]

where the term bx + (1 - b)(1 - x) just accounts for the fact that the allele hichhikes to b = 1 with probability x and to b = 0 with probability 1 - x. Using the above defined moments Ma(k;m,θ) we can compute this integral to:

[formula]

In the following figure we plot both the continuous and the discrete neutral model with and without hitchhiking (parameters: μ = 0.025, ν  =  2):

As expected, the hitchhiking model predicts fewer common variants in comparison to the standard model.

Selection

We can add selection to the standard model without hitchhiking, following [\cite=Mustonen:2007im]:

[formula]

with the normalization factor

[formula]

The binomial moments are derived again by integration, similar to equation [\ref=eq_binom_sampling]:

[formula]

We can now apply the same modification using an exponential factor for hitchhiking as we did in equation [\ref=eq_qdist_hh], which for the equilibrium distributions under selection leads to:

[formula]

with the hitchhiking fraction

[formula]

and the binomial moments

[formula]

We plot again both the continuous and the discrete neutral model with and without hitchhiking, but including selection (same parameters as above but σ = 2)

As expected, due to directional selection, allele frequencies are skewed towards the B-allele (i.e. higher x).

Substitutions and divergence from outgroup

To model the divergence from a related species, we exploit the fact that we generally consider relatively small mutation rates, which leads to a separation of the substitution (fixation) time scale from the polymorphism time scale [\cite=Lassig:2007iq]. In this regime, which corresponds to [formula], we can model fixations independently from polymorphisms as a Poisson process. Without hitchhiking and in the weak mutation regime, the rate per scaled unit time of this process is approximately [\cite=Mustonen:2007im]

[formula]

Under hitchhiking with an effective rate ν (see above), we have previously shown [\cite=Schiffels:2011fu] that the substitution rate changes to approximately

[formula]

which effectively reduces the rate of beneficial mutations, and increases the rate of deleterious mutations, making them ore neutral.

We abbreviate u+ = u(θ, + σ,ν) and u- = u(θ, - σ,ν) and will omit the dependencies on θ, σ and ν, which are always implicit in the following expressions. The rates u+ and u- form a two state Markov process with states a = {0,1} and a rate matrix

[formula]

and transition probability

[formula]

The equilibrium state [formula] for this transition probability is

[formula]

where we again left out the dependency on θ, σ and ν for brevity.

This transition probability lets us write the probability to observe a frequency k1 out of m1 samples with allele B in species 1, and k2 out of m2 samples in species 2, where both species share a common ancestral species at time τ in the past:

[formula]

The indices in the matrix [formula] and the vector [formula] denote row and column, respectively. This expression makes use of the fact that the polymorphisms dynamics (reflected by Ma(k;m)) are independent of the substitution dynamics (reflected by [formula]) in the weak mutation regime set by [formula].

The outgroup-directed allele frequency as used in the data analysis is now simply a sum over the two cases in which the single outgroup-sample carries either of the two alleles:

[formula]

This is the most general allele frequency probability distribution, on which all models for parameter estimation as described in Material and Methods are based on. The following figure shows this probability for θ = 0.025 and τ = 5 and different values for σ and ν as indicated:

Note that this probability is independent with respect to the sign of σ. The reason is that we compute the difference in the two species, without direction of an ancestral vs. derived allele. If σ is negative, it means that the A allele is the fitter one, but the probability to observe k out of m samples with a different allele than the outgroup is the same if B was the fitter allele. We therefore treat σ as a parameter on the positive domain of real values.

In all of the above we have considered N = N0, i.e. λ = 1 (see section [\ref=sec_def]). We can generalize by scaling all scaled parameters by λ:

[formula]

Models

Basic Models for synonymous sites

To work with real data and to infer parameters reliably, we define simplified subsets of the full model, by setting some parameters to default values. In particular, we define these basic models:

Unlinked adaptation model: The unlinked model has as free parameters only the scaled mutation rate θ and the divergence time τ. Other parameters are fixed, so that the resulting probability can be written as:

[formula]

Background selection model: The background selection model (BGS) has as additional free parameter the effective population size λ:

[formula]

Linked Adaptation model: With hitchhiking, we use one further parameter ν:

[formula]

Directional selection model: We also define a model with background selection and direct selection (see Supplementary Figures S2 and S3):

[formula]

Mixed model for heterogeneous data sets

For our mixed model we add together these components with different weights:

Neutral component: A fraction cn of sites evolves neutrally, but generally under hitchhiking.

Weakly selected component: A fraction cw of sites evolves under weak directional selection.

Adaptive component: At a fraction ca of sites we assume that adaptive evolution has generated fixed differences between the two species. This fraction accounts for an observed surplus of substitutions with respect to the neutral expectation.

Conserved component: The remainder of the above, with fraction cc = 1 - cn - cw - ca is assumed to be under strong directional selection which accounts for an observed surplus of conserved sites with respect to the neutral expectation.

Each component has its own specific outgroup-directed allele frequency distribution. First, the neutral component is simply one of the above derived basic models without selection:

[formula]

defining three separate mixed models. The weakly selected component uses the full probability derived above, including a selection coefficient σ, which we typically constrain to 1 < σ < 150:

[formula]

The adaptive component is only a surplus of fixed differences between the two species, so it is simply

[formula]

with the Kronecker-Delta which sets this probability to zero everywhere except at k = m where it is one. Analogously, the conserved component is:

[formula]

Note that each of these components is normalized across 0  ≤  k  ≤  m.

The full probability of the mixed model is then:

[formula]

This full model has 7 parameters Θ  =  {τ,θ,σ,ν,cn,cw,ca}.

Maximum Likelihood estimation

We consider a data set of outgroup-directed allele frequencies with a fixed sample size m. We denote the number of sites with allele frequency k by nk. The total likelihood of the data given parameters Θ is then:

[formula]

In practice we use the log-Likelihood

[formula]

The parameters are then learned by maximization of the log-Likelihood:

[formula]

As pointed out in the text, we typically follow a hierarchical protocol to estimate parameters from data. Assuming, all sites have been binned according to the local recombination rate (see Methods in the main article), we first use the unlinked model to infer τ (under free variation of θ) from synonymous sites in the highest recombination bin. We then use the background selection and linked adaptation models to infer θ, λ and ν for each bin, keeping τ fixed at the value inferred from the highest recombination bin using the unlinked model. We then learn the rest of the parameters from non-neutral annotation categories using the mixed models, keeping the neutral parameters fixed to their values obtained from the background selection or the linked adaptation model. Numerical maximization is implemented using Powell's method [\cite=Press].

Types of substitutions in the mixed model

In the mixed model, we implemented different components which contribute differently to the amount of fixed differences between species. We make use of the three components Pn, Pw and Pa as defined in equations [\ref=eq_Pn], [\ref=eq_Pw], [\ref=eq_Pa]. First, we can estimate the fraction of sites with neutral substitutions that have been fixed by drift alone:

[formula]

where e-  ν is the probability that no linked sweep occurs during the typical time of fixation of a neutral variant (2N0 generations). We also define the fraction of sites with neutral substitutions fixed by drift and by hitchhiking:

[formula]

From these two, we obtain the hitchhiking fraction via:

[formula]

We obtain the fraction of sites with weakly selected substitutions that have been fixed by drift via:

[formula]

and the fraction of sites with weakly selected substitutions fixed by drift and hitchhiking

[formula]

which allows us to derive the fraction of sites with weakly selected substitutions fixed by deleterious hitchhiking:

[formula]

We can also write down the fraction of sites with adaptive substitutions:

[formula]

Fitness Flux

Fitness flux was introduced in [\cite=Mustonen:2007im] as the product of the rate of substitutions and their average selection coefficient. To estimate fitness flux, we first compute the rate of adaptive substitutions per scaled unit time, ka, from our fraction fa = ca above:

[formula]

because 2τ is the total branch length between the two species, and ca is the expected number of substitutions per site. If we knew the average selection coefficient of adaptive substitutions, sa, the fitness flux Φ would be

[formula]

per scaled unit time. We cannot measure sa directly from our framework, but we have an indirect measure using the rate of linked sweeps, ν. As has been shown in [\cite=Smith:1974vn] and [\cite=Kaplan:1989tm], the typical "effect width" of a single selective sweep with selection coefficient sa is

[formula]

where r is the recombination rate, and α is a constant, which depends on model assumptions and parameters such as the absolute effective population size. For relevant parameters, α lies between 0.1 and 0.5, as computed in [\cite=Kaplan:1989tm]. Here we fix α = 0.1 to be conservative in estimating fitness flux and sa as follows: We can now relate the effective rate of linked sweeps, ν, which is simply to total rate of adaptive mutations within a window of width w, with the fitness flux (see also [\cite=Mustonen:2007im]):

[formula]

So the rate of linked sweeps ν is directly linked to the fitness flux per recombination map length. In case we do not observe any positive rate of linked drivers, we estimate a conservative upper bound on the fitness flux using the inequality ν < 1 (with ν = 1 being a typical value that we can measure with confidence). In summary, we compute fitness flux as:

[formula]

as an upper bound on fitness flux in regions with r > 0. Having estimated Φ, we can simply solve for sa using equation [\ref=eq_Phiplus].

Similarly to the rate of beneficial mutations, we can estimate the total rate of weakly deleterious substitutions via

[formula]

which then lets us estimate a negative component to the fitness flux as

[formula]

where σ is the scaled selection coefficient as used in the mixed model, and the factor 1 / 2 accounts for the fact that in equilibrium only half of the substitutions are deleterious, the other half is compensatory and hence beneficial. We used a diploid population size of 1.78  ×  106, as used in [\cite=Sella:2009hs] and [\cite=Andolfatto:2007cq]. We show this estimate in Supplementary Figure 6c). In the definitions above, fitness flux is defined in units of 1 / 2N0. However, it is intuitive to use as units μ / 2N0, with μ estimated from our estimates of θ and the above population size. In these units, a fitness flux of 1 can for example be generated by mutations with selection coefficients of 1 / 2N, which fix with the neutral substitution rate (μ). We use these units in Figure 5.

To report a fitness flux per million years, we assume a generation time of 0.1 years in Drosophila, which yields a neutral substitution rate of one substitution per [formula] years.

We also translate these rates to fitness flux per gene, for which we use an average number of 1,000 nonsynonymous sites per gene in the autosomes in Drosophila, obtained from the annotations described in methods.

Genetic Load

Genetic load as used here quantifies the amount of fitness loss generated by fixed deleterious mutations. The probability for a weakly selected site to be in the less fit state follows from the equilibrium state of the Markov process defined in equation [\ref=eq_rateM]:

[formula]

where the fixation rates u+ and u- are described in section [\ref=sec_subst]. The genetic load is then simply:

[formula]

where cw is the fraction of weakly selected sites, and σ is their selection coefficient, as defined in the mixed model.